<!DOCTYPE html>
<html>
<head>
    <title>Job Scheduler</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
        }
        
        .header {
            background: #2563eb;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .main-container {
            display: grid;
            grid-template-rows: 400px 1fr;
            height: calc(100vh - 60px);
        }

        /* Map Section */
        .map-section {
            position: relative;
            border-bottom: 2px solid #dee2e6;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        /* Bottom Panels */
        .bottom-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            overflow: hidden;
        }

        .panel {
            display: flex;
            flex-direction: column;
            background: white;
        }

        .panel-header {
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            font-weight: bold;
        }

        .panel-controls {
            padding: 10px;
            background: white;
            border-bottom: 1px solid #dee2e6;
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        /* Job Cards */
        .job-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            cursor: move;
        }

        .job-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .job-card.scheduled {
            opacity: 0.5;
            background: #f0f0f0;
        }

        /* Tech Cards */
        .tech-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
        }

        .tech-card.drop-ready {
            background: #dbeafe;
            border-color: #3b82f6;
        }

        /* Schedule Grid */
        .schedule-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .day-column {
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 5px;
            min-height: 100px;
            background: #f9fafb;
        }

        .day-header {
            font-weight: bold;
            text-align: center;
            padding: 5px;
            background: #e5e7eb;
            border-radius: 3px;
            margin-bottom: 5px;
        }

        .scheduled-job {
            background: #3b82f6;
            color: white;
            padding: 4px;
            margin: 2px 0;
            border-radius: 3px;
            font-size: 11px;
        }

        /* Stats */
        .stats-row {
            display: flex;
            gap: 20px;
            padding: 10px;
            background: #f9fafb;
            border-bottom: 1px solid #dee2e6;
        }

        .stat {
            flex: 1;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2563eb;
        }

        .stat-label {
            font-size: 12px;
            color: #6b7280;
        }

        /* Controls */
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background: #2563eb;
        }

        input, select {
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            margin-right: 8px;
        }

        .capacity-bar {
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            margin-top: 5px;
            overflow: hidden;
        }

        .capacity-fill {
            height: 100%;
            background: #10b981;
            transition: width 0.3s;
        }

        .capacity-fill.warning {
            background: #f59e0b;
        }

        .capacity-fill.danger {
            background: #ef4444;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸ“… Job Scheduler</h1>
        <nav>
            <button onclick="saveSchedule()">ðŸ’¾ Save Schedule</button>
        </nav>
    </div>
    
    <div class="main-container">
        <!-- Map -->
        <div class="map-section">
            <div id="map"></div>
        </div>

        <!-- Bottom Section -->
        <div class="bottom-section">
            <!-- Jobs Panel -->
            <div class="panel">
                <div class="panel-header">
                    Unassigned Jobs (<span id="job-count">0</span>)
                </div>
                <div class="panel-controls">
                    <input type="date" id="start-date" value="2025-09-01">
                    <input type="date" id="end-date" value="2025-09-30">
                    <button onclick="loadJobs()">Load Jobs</button>
                </div>
                <div class="stats-row">
                    <div class="stat">
                        <div class="stat-label">Total Hours</div>
                        <div class="stat-value" id="total-hours">0</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Urgent</div>
                        <div class="stat-value" id="urgent-count">0</div>
                    </div>
                </div>
                <div class="panel-content" id="job-list">
                    <!-- Jobs appear here -->
                </div>
            </div>

            <!-- Schedule Panel -->
            <div class="panel">
                <div class="panel-header">
                    Week Schedule
                </div>
                <div class="panel-controls">
                    <label>Tech:</label>
                    <select id="tech-select" onchange="selectTech()">
                        <option value="">Select Technician</option>
                    </select>
                    <span id="tech-hours">0h / 0h</span>
                </div>
                <div class="schedule-grid" id="schedule-grid">
                    <div class="day-column" data-day="monday">
                        <div class="day-header">Monday</div>
                        <div class="day-jobs" ondrop="dropJob(event, 'monday')" ondragover="allowDrop(event)"></div>
                    </div>
                    <div class="day-column" data-day="tuesday">
                        <div class="day-header">Tuesday</div>
                        <div class="day-jobs" ondrop="dropJob(event, 'tuesday')" ondragover="allowDrop(event)"></div>
                    </div>
                    <div class="day-column" data-day="wednesday">
                        <div class="day-header">Wednesday</div>
                        <div class="day-jobs" ondrop="dropJob(event, 'wednesday')" ondragover="allowDrop(event)"></div>
                    </div>
                    <div class="day-column" data-day="thursday">
                        <div class="day-header">Thursday</div>
                        <div class="day-jobs" ondrop="dropJob(event, 'thursday')" ondragover="allowDrop(event)"></div>
                    </div>
                    <div class="day-column" data-day="friday">
                        <div class="day-header">Friday</div>
                        <div class="day-jobs" ondrop="dropJob(event, 'friday')" ondragover="allowDrop(event)"></div>
                    </div>
                </div>
                <div class="panel-content" id="tech-list">
                    <!-- Tech info appears here -->
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Global variables
        const API_KEY = 'devkey123';
        let map;
        let jobs = [];
        let techs = [];
        let selectedTech = null;
        let schedules = {}; // techId -> {monday: [], tuesday: [], ...}
        
        // Initialize map
        function initMap() {
            map = L.map('map').setView([39.0, -105.5], 7);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        }
        
        // Load jobs
        async function loadJobs() {
            const start = document.getElementById('start-date').value;
            const end = document.getElementById('end-date').value;
            
            try {
                const response = await fetch(
                    `/jobs/pool?start=${start}&end=${end}&limit=500`,
                    { headers: {'X-API-Key': API_KEY} }
                );
                const data = await response.json();
                jobs = data.jobs.filter(j => 
                    j.jp_status === 'Call' || 
                    j.jp_status === 'Waiting to Schedule'
                );
                
                displayJobs();
                plotJobsOnMap();
                updateStats();
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to load jobs');
            }
        }
        
        // Display jobs in list
        function displayJobs() {
            const container = document.getElementById('job-list');
            container.innerHTML = '';
            
            jobs.forEach(job => {
                if (isJobScheduled(job.work_order)) return;
                
                const div = document.createElement('div');
                div.className = 'job-card';
                div.id = `job-${job.work_order}`;
                div.draggable = true;
                div.ondragstart = (e) => dragJob(e, job);
                
                div.innerHTML = `
                    <strong>WO ${job.work_order}</strong> - ${job.est_hours || 2}h<br>
                    ${job.site_name}<br>
                    ${job.site_city}, ${job.site_state}<br>
                    Due: ${new Date(job.due_date).toLocaleDateString()}
                `;
                
                container.appendChild(div);
            });
            
            document.getElementById('job-count').textContent = 
                jobs.filter(j => !isJobScheduled(j.work_order)).length;
        }
        
        // Check if job is scheduled
        function isJobScheduled(workOrder) {
            for (let techId in schedules) {
                for (let day in schedules[techId]) {
                    if (schedules[techId][day].some(j => j.work_order === workOrder)) {
                        return true;
                    }
                }
            }
            return false;
        }
        
        // Plot jobs on map
        function plotJobsOnMap() {
            // Clear existing markers
            map.eachLayer(layer => {
                if (layer instanceof L.CircleMarker) {
                    map.removeLayer(layer);
                }
            });
            
            jobs.forEach(job => {
                if (!job.latitude || !job.longitude) return;
                if (isJobScheduled(job.work_order)) return;
                
                const color = job.jp_priority === 'Urgent' ? 'red' : 'blue';
                L.circleMarker([job.latitude, job.longitude], {
                    radius: 6,
                    fillColor: color,
                    color: 'white',
                    weight: 2,
                    fillOpacity: 0.8
                }).addTo(map).bindPopup(`
                    <strong>${job.site_name}</strong><br>
                    WO: ${job.work_order}<br>
                    ${job.est_hours || 2} hours
                `);
            });
        }
        
        // Load technicians
        async function loadTechs() {
            try {
                const response = await fetch('/technicians?active_only=true', {
                    headers: {'X-API-Key': API_KEY}
                });
                const data = await response.json();
                techs = data.technicians;
                
                const select = document.getElementById('tech-select');
                techs.forEach(tech => {
                    const option = document.createElement('option');
                    option.value = tech.technician_id;
                    option.textContent = `${tech.name} (${tech.home_location})`;
                    select.appendChild(option);
                    
                    // Initialize schedule
                    schedules[tech.technician_id] = {
                        monday: [],
                        tuesday: [],
                        wednesday: [],
                        thursday: [],
                        friday: []
                    };
                });
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        // Select technician
        function selectTech() {
            const techId = document.getElementById('tech-select').value;
            if (!techId) return;
            
            selectedTech = techs.find(t => t.technician_id == techId);
            updateScheduleDisplay();
        }
        
        // Drag and drop functions
        function dragJob(event, job) {
            event.dataTransfer.setData('job', JSON.stringify(job));
        }
        
        function allowDrop(event) {
            event.preventDefault();
            event.target.style.background = '#dbeafe';
        }
        
        function dropJob(event, day) {
            event.preventDefault();
            event.target.style.background = '';
            
            if (!selectedTech) {
                alert('Please select a technician first');
                return;
            }
            
            const job = JSON.parse(event.dataTransfer.getData('job'));
            
            // Check capacity
            const dayHours = schedules[selectedTech.technician_id][day]
                .reduce((sum, j) => sum + (j.est_hours || 2), 0);
            
            if (dayHours + (job.est_hours || 2) > selectedTech.max_daily_hours) {
                alert(`This exceeds ${selectedTech.name}'s daily capacity`);
                return;
            }
            
            // Add to schedule
            schedules[selectedTech.technician_id][day].push(job);
            
            // Update displays
            updateScheduleDisplay();
            displayJobs();
            plotJobsOnMap();
            updateStats();
            
            // Mark job card as scheduled
            const jobCard = document.getElementById(`job-${job.work_order}`);
            if (jobCard) {
                jobCard.classList.add('scheduled');
            }
        }
        
        // Update schedule display
        function updateScheduleDisplay() {
            if (!selectedTech) return;
            
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
            let totalHours = 0;
            
            days.forEach(day => {
                const dayDiv = document.querySelector(`[data-day="${day}"] .day-jobs`);
                dayDiv.innerHTML = '';
                
                const dayJobs = schedules[selectedTech.technician_id][day];
                dayJobs.forEach(job => {
                    const jobDiv = document.createElement('div');
                    jobDiv.className = 'scheduled-job';
                    jobDiv.innerHTML = `WO ${job.work_order} (${job.est_hours || 2}h)`;
                    dayDiv.appendChild(jobDiv);
                    totalHours += job.est_hours || 2;
                });
            });
            
            // Update hours display
            document.getElementById('tech-hours').textContent = 
                `${totalHours}h / ${selectedTech.max_weekly_hours}h`;
        }
        
        // Update stats
        function updateStats() {
            const unscheduledJobs = jobs.filter(j => !isJobScheduled(j.work_order));
            
            const totalHours = unscheduledJobs.reduce((sum, j) => sum + (j.est_hours || 2), 0);
            const urgentCount = unscheduledJobs.filter(j => j.jp_priority === 'Urgent').length;
            
            document.getElementById('total-hours').textContent = totalHours.toFixed(1);
            document.getElementById('urgent-count').textContent = urgentCount;
        }
        
        // Save schedule
        async function saveSchedule() {
            console.log('Saving schedule:', schedules);
            alert('Schedule saved (check console)');
            // Here you would call your API to save the schedule
        }
        
        // Initialize
        window.onload = function() {
            initMap();
            loadTechs();
        };
    </script>
</body>
</html>