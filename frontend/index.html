<!DOCTYPE html>
<html>
<head>
    <title>Job Scheduler</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
        }
        
        .header {
            background: #2563eb;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .main-container {
            display: grid;
            grid-template-rows: 400px 1fr;
            height: calc(100vh - 60px);
        }

        /* Map Section */
        .map-section {
            position: relative;
            border-bottom: 2px solid #dee2e6;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        /* Bottom Panels */
        .bottom-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            overflow: hidden;
        }

        .panel {
            display: flex;
            flex-direction: column;
            background: white;
        }

        .panel-header {
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            font-weight: bold;
        }

        .panel-controls {
            padding: 10px;
            background: white;
            border-bottom: 1px solid #dee2e6;
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        /* Job Cards */
        .job-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            cursor: move;
        }

        .job-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .job-card.scheduled {
            opacity: 0.5;
            background: #f0f0f0;
        }

        /* Tech Cards */
        .tech-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
        }

        .tech-card.drop-ready {
            background: #dbeafe;
            border-color: #3b82f6;
        }

        /* Schedule Grid */
        .schedule-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .day-column {
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 5px;
            min-height: 100px;
            background: #f9fafb;
        }

        .day-header {
            font-weight: bold;
            text-align: center;
            padding: 5px;
            background: #e5e7eb;
            border-radius: 3px;
            margin-bottom: 5px;
        }

        .scheduled-job {
            background: #3b82f6;
            color: white;
            padding: 4px;
            margin: 2px 0;
            border-radius: 3px;
            font-size: 11px;
        }

        /* Stats */
        .stats-row {
            display: flex;
            gap: 20px;
            padding: 10px;
            background: #f9fafb;
            border-bottom: 1px solid #dee2e6;
        }

        .stat {
            flex: 1;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2563eb;
        }

        .stat-label {
            font-size: 12px;
            color: #6b7280;
        }

        /* Controls */
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background: #2563eb;
        }

        input, select {
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            margin-right: 8px;
        }

        .capacity-bar {
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            margin-top: 5px;
            overflow: hidden;
        }

        .capacity-fill {
            height: 100%;
            background: #10b981;
            transition: width 0.3s;
        }

        .capacity-fill.warning {
            background: #f59e0b;
        }

        .capacity-fill.danger {
            background: #ef4444;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>📅 Job Scheduler</h1>
        <nav>
            <button onclick="saveSchedule()">💾 Save Schedule</button>
        </nav>
    </div>
    
    <div class="main-container">
        <!-- Map -->
        <div class="map-section">
            <div id="map"></div>
        </div>

        <!-- Bottom Section -->
        <div class="bottom-section">
            <!-- Jobs Panel -->
            <div class="panel">
                <div class="panel-header">
                    Unassigned Jobs (<span id="job-count">0</span>)
                </div>
                <div class="panel-controls">
                    <input type="date" id="start-date" value="2025-09-01">
                    <input type="date" id="end-date" value="2025-09-30">
                    <button onclick="loadJobs()">Load Jobs</button>
                </div>
                <div class="stats-row">
                    <div class="stat">
                        <div class="stat-label">Total Hours</div>
                        <div class="stat-value" id="total-hours">0</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Urgent</div>
                        <div class="stat-value" id="urgent-count">0</div>
                    </div>
                </div>
                <div class="panel-content" id="job-list">
                    <!-- Jobs appear here -->
                </div>
            </div>

            <!-- Schedule Panel -->
            <div class="panel">
                <div class="panel-header">
                    Week Schedule
                </div>
                <div class="panel-controls">
                    <label>Tech:</label>
                    <select id="tech-select" onchange="selectTech()">
                        <option value="">Select Technician</option>
                    </select>
                    <span id="tech-hours">0h / 0h</span>
                </div>
                <div class="schedule-grid" id="schedule-grid">
                    <div class="day-column" data-day="monday">
                        <div class="day-header">Monday</div>
                        <div class="day-jobs" id="monday-jobs" ondrop="dropJob(event, 'monday')" ondragover="allowDrop(event)" ondragleave="clearDrop(event)"></div>
                    </div>
                    <div class="day-column" data-day="tuesday">
                        <div class="day-header">Tuesday</div>
                        <div class="day-jobs" id="tuesday-jobs" ondrop="dropJob(event, 'tuesday')" ondragover="allowDrop(event)" ondragleave="clearDrop(event)"></div>
                    </div>
                    <div class="day-column" data-day="wednesday">
                        <div class="day-header">Wednesday</div>
                        <div class="day-jobs" id="wednesday-jobs" ondrop="dropJob(event, 'wednesday')" ondragover="allowDrop(event)" ondragleave="clearDrop(event)"></div>
                    </div>
                    <div class="day-column" data-day="thursday">
                        <div class="day-header">Thursday</div>
                        <div class="day-jobs" id="thursday-jobs" ondrop="dropJob(event, 'thursday')" ondragover="allowDrop(event)" ondragleave="clearDrop(event)"></div>
                    </div>
                    <div class="day-column" data-day="friday">
                        <div class="day-header">Friday</div>
                        <div class="day-jobs" id="friday-jobs" ondrop="dropJob(event, 'friday')" ondragover="allowDrop(event)" ondragleave="clearDrop(event)"></div>
                    </div>
                </div>
                <!-- Add this AI Suggestions Panel -->
                <div style="padding: 15px; background: #f0f9ff; border-top: 2px solid #0284c7; margin-top: 20px;">
                    <h3 style="margin: 0 0 10px 0; color: #0c4a6e;">🤖 AI Suggestions</h3>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <button onclick="suggestNearbyJobs()" style="background: #0ea5e9;">Find Nearby Jobs</button>
                        <button onclick="suggestBestFit()" style="background: #10b981;">Best Fit Jobs</button>
                        <button onclick="optimizeWeek()" style="background: #8b5cf6;">Optimize Week</button>
                    </div>
                    <div id="suggestions" style="max-height: 200px; overflow-y: auto;">
                        <p style="color: #64748b; font-style: italic;">Select a technician and click a suggestion type</p>
                    </div>
                </div>

                <div class="panel-content" id="tech-list">
                    <!-- Tech info appears here -->
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Global variables
        const API_KEY = 'devkey123';
        let map;
        let jobs = [];
        let techs = [];
        let selectedTech = null;
        let schedules = {}; // techId -> {monday: [], tuesday: [], ...}
        
        // Initialize map
        function initMap() {
            map = L.map('map').setView([39.0, -105.5], 7);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        }
        
        // Load jobs
        async function loadJobs() {
            const start = document.getElementById('start-date').value;
            const end = document.getElementById('end-date').value;
            
            try {
                const response = await fetch(
                    `/jobs/pool?start=${start}&end=${end}&limit=500`,
                    { headers: {'X-API-Key': API_KEY} }
                );
                const data = await response.json();
                jobs = data.jobs.filter(j => 
                    j.jp_status === 'Call' || 
                    j.jp_status === 'Waiting to Schedule'
                );
                
                displayJobs();
                plotJobsOnMap();
                updateStats();
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to load jobs');
            }
        }
        
        // Display jobs in list
        function displayJobs() {
            const container = document.getElementById('job-list');
            container.innerHTML = '';
            
            jobs.forEach(job => {
                if (isJobScheduled(job.work_order)) return;
                
                const div = document.createElement('div');
                div.className = 'job-card';
                div.id = `job-${job.work_order}`;
                div.draggable = true;
                div.ondragstart = (e) => dragJob(e, job);
                
                div.innerHTML = `
                    <strong>WO ${job.work_order}</strong> - ${job.est_hours || 2}h<br>
                    ${job.site_name}<br>
                    ${job.site_city}, ${job.site_state}<br>
                    Due: ${new Date(job.due_date).toLocaleDateString()}
                `;
                
                container.appendChild(div);
            });
            
            document.getElementById('job-count').textContent = 
                jobs.filter(j => !isJobScheduled(j.work_order)).length;
        }
        
        // Check if job is scheduled
        function isJobScheduled(workOrder) {
            for (let techId in schedules) {
                for (let day in schedules[techId]) {
                    if (schedules[techId][day].some(j => j.work_order === workOrder)) {
                        return true;
                    }
                }
            }
            return false;
        }
        
        // Plot jobs on map
        function plotJobsOnMap() {
            // Clear existing markers
            map.eachLayer(layer => {
                if (layer instanceof L.CircleMarker) {
                    map.removeLayer(layer);
                }
            });
            
            jobs.forEach(job => {
                if (!job.latitude || !job.longitude) return;
                if (isJobScheduled(job.work_order)) return;
                
                const color = job.jp_priority === 'Urgent' ? 'red' : 'blue';
                L.circleMarker([job.latitude, job.longitude], {
                    radius: 6,
                    fillColor: color,
                    color: 'white',
                    weight: 2,
                    fillOpacity: 0.8
                }).addTo(map).bindPopup(`
                    <strong>${job.site_name}</strong><br>
                    WO: ${job.work_order}<br>
                    ${job.est_hours || 2} hours
                `);
            });
        }
        
        // Load technicians
        async function loadTechs() {
            try {
                const response = await fetch('/technicians?active_only=true', {
                    headers: {'X-API-Key': API_KEY}
                });
                const data = await response.json();
                techs = data.technicians;
                
                const select = document.getElementById('tech-select');
                techs.forEach(tech => {
                    const option = document.createElement('option');
                    option.value = tech.technician_id;
                    option.textContent = `${tech.name} (${tech.home_location})`;
                    select.appendChild(option);
                    
                    // Initialize schedule
                    schedules[tech.technician_id] = {
                        monday: [],
                        tuesday: [],
                        wednesday: [],
                        thursday: [],
                        friday: []
                    };
                });
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        // Select technician
        function selectTech() {
            const techId = document.getElementById('tech-select').value;
            if (!techId) return;
            
            selectedTech = techs.find(t => t.technician_id == techId);
            updateScheduleDisplay();
        }
        
        // Drag and drop functions
        function dragJob(event, job) {
            event.dataTransfer.setData('job', JSON.stringify(job));
        }
        
        // Fixed drag and drop functions
        function allowDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            // Highlight the drop zone
            const dropZone = event.currentTarget;
            dropZone.style.background = '#dbeafe';
            dropZone.style.border = '2px dashed #3b82f6';
        }

        function clearDrop(event) {
            const dropZone = event.currentTarget;
            dropZone.style.background = '';
            dropZone.style.border = '';
        }

        function dropJob(event, day) {
            event.preventDefault();
            event.stopPropagation();
            
            // Clear the highlight
            const dropZone = event.currentTarget;
            dropZone.style.background = '';
            dropZone.style.border = '';
            
            if (!selectedTech) {
                alert('Please select a technician first');
                return;
            }
            
            const job = JSON.parse(event.dataTransfer.getData('job'));
            
            // Check capacity
            const dayHours = schedules[selectedTech.technician_id][day]
                .reduce((sum, j) => sum + (j.est_hours || 2), 0);
            
            if (dayHours + (job.est_hours || 2) > selectedTech.max_daily_hours) {
                alert(`This exceeds ${selectedTech.name}'s daily capacity of ${selectedTech.max_daily_hours} hours`);
                return;
            }
            
            // Add to schedule
            schedules[selectedTech.technician_id][day].push(job);
            
            // Update displays
            updateScheduleDisplay();
            displayJobs();
            plotJobsOnMap();
            updateStats();

            
            // Mark job card as scheduled
            const jobCard = document.getElementById(`job-${job.work_order}`);
            if (jobCard) {
                jobCard.classList.add('scheduled');
            }
        }
        
        // Update schedule display
        function updateScheduleDisplay() {
            if (!selectedTech) return;
            
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
            let totalHours = 0;
            
            days.forEach(day => {
                const dayDiv = document.querySelector(`[data-day="${day}"] .day-jobs`);
                dayDiv.innerHTML = '';
                
                const dayJobs = schedules[selectedTech.technician_id][day];
                dayJobs.forEach(job => {
                    const jobDiv = document.createElement('div');
                    jobDiv.className = 'scheduled-job';
                    jobDiv.innerHTML = `WO ${job.work_order} (${job.est_hours || 2}h)`;
                    dayDiv.appendChild(jobDiv);
                    totalHours += job.est_hours || 2;
                });
            });
            
            // Update hours display
            document.getElementById('tech-hours').textContent = 
                `${totalHours}h / ${selectedTech.max_weekly_hours}h`;
        }
        
        // Update stats
        function updateStats() {
            const unscheduledJobs = jobs.filter(j => !isJobScheduled(j.work_order));
            
            const totalHours = unscheduledJobs.reduce((sum, j) => sum + (j.est_hours || 2), 0);
            const urgentCount = unscheduledJobs.filter(j => j.jp_priority === 'Urgent').length;
            
            document.getElementById('total-hours').textContent = totalHours.toFixed(1);
            document.getElementById('urgent-count').textContent = urgentCount;
        }
        
        // Save schedule
        async function saveSchedule() {
            console.log('Saving schedule:', schedules);
            alert('Schedule saved (check console)');
            // Here you would call your API to save the schedule
        }
        
        // Initialize
        window.onload = function() {
            initMap();
            loadTechs();
        }
                // AI Suggestion Functions
        function suggestNearbyJobs() {
            if (!selectedTech) {
                alert('Please select a technician first');
                return;
            }
            
            const suggestionsDiv = document.getElementById('suggestions');
            suggestionsDiv.innerHTML = '<p>🔍 Finding nearby jobs...</p>';
            
            // Get tech's scheduled jobs
            const scheduledJobs = [];
            for (let day in schedules[selectedTech.technician_id]) {
                scheduledJobs.push(...schedules[selectedTech.technician_id][day]);
            }
            
            if (scheduledJobs.length === 0) {
                suggestionsDiv.innerHTML = '<p>⚠️ Schedule some jobs first, then I can find nearby ones!</p>';
                return;
            }
            
            // Find unscheduled jobs near scheduled ones
            const unscheduledJobs = jobs.filter(j => !isJobScheduled(j.work_order));
            const suggestions = [];
            
            scheduledJobs.forEach(schedJob => {
                if (!schedJob.latitude || !schedJob.longitude) return;
                
                unscheduledJobs.forEach(job => {
                    if (!job.latitude || !job.longitude) return;
                    
                    const distance = calculateDistance(
                        schedJob.latitude, schedJob.longitude,
                        job.latitude, job.longitude
                    );
                    
                    if (distance < 20) { // Within 20 miles
                        suggestions.push({
                            job: job,
                            nearJob: schedJob,
                            distance: distance
                        });
                    }
                });
            });
            
            // Sort by distance and show top 5
            suggestions.sort((a, b) => a.distance - b.distance);
            const top5 = suggestions.slice(0, 5);
            
            if (top5.length === 0) {
                suggestionsDiv.innerHTML = '<p>No nearby jobs found within 20 miles of scheduled jobs</p>';
                return;
            }
            
            let html = '<div style="color: #0c4a6e;"><strong>📍 Nearby Jobs (within 20 miles):</strong></div>';
            top5.forEach(s => {
                html += `
                    <div style="padding: 8px; margin: 5px 0; background: white; border-radius: 4px; border-left: 3px solid #0ea5e9;">
                        <strong>WO ${s.job.work_order}</strong> - ${s.job.site_name}<br>
                        <small>📏 ${s.distance.toFixed(1)} miles from WO ${s.nearJob.work_order}</small><br>
                        <small>⏱️ ${s.job.est_hours || 2} hours</small>
                        <button onclick='quickAddJob(${JSON.stringify(s.job)})' style='margin-top: 5px; padding: 4px 8px; font-size: 12px;'>
                            + Add to Schedule
                        </button>
                    </div>
                `;
            });
            
            suggestionsDiv.innerHTML = html;
        }

        function suggestBestFit() {
            if (!selectedTech) {
                alert('Please select a technician first');
                return;
            }
            
            const suggestionsDiv = document.getElementById('suggestions');
            suggestionsDiv.innerHTML = '<p>🔍 Finding best fit jobs...</p>';
            
            // Calculate remaining capacity per day
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
            const capacity = {};
            
            days.forEach(day => {
                const used = schedules[selectedTech.technician_id][day]
                    .reduce((sum, j) => sum + (j.est_hours || 2), 0);
                capacity[day] = selectedTech.max_daily_hours - used;
            });
            
            // Find jobs that fit in available slots
            const unscheduledJobs = jobs.filter(j => !isJobScheduled(j.work_order));
            const fits = [];
            
            unscheduledJobs.forEach(job => {
                const jobHours = job.est_hours || 2;
                
                days.forEach(day => {
                    if (capacity[day] >= jobHours) {
                        // Check if near tech's home
                        if (selectedTech.home_latitude && job.latitude) {
                            const distanceFromHome = calculateDistance(
                                selectedTech.home_latitude, selectedTech.home_longitude,
                                job.latitude, job.longitude
                            );
                            
                            if (distanceFromHome < 50) { // Within 50 miles of home
                                fits.push({
                                    job: job,
                                    day: day,
                                    remainingCapacity: capacity[day],
                                    distanceFromHome: distanceFromHome,
                                    score: (50 - distanceFromHome) + (jobHours * 10) // Prioritize closer and longer jobs
                                });
                            }
                        }
                    }
                });
            });
            
            // Sort by score and show top 5
            fits.sort((a, b) => b.score - a.score);
            const top5 = fits.slice(0, 5);
            
            if (top5.length === 0) {
                suggestionsDiv.innerHTML = '<p>No jobs found that fit remaining capacity within 50 miles</p>';
                return;
            }
            
            let html = '<div style="color: #0c4a6e;"><strong>✨ Best Fit Jobs:</strong></div>';
            top5.forEach(f => {
                html += `
                    <div style="padding: 8px; margin: 5px 0; background: white; border-radius: 4px; border-left: 3px solid #10b981;">
                        <strong>WO ${f.job.work_order}</strong> - ${f.job.site_name}<br>
                        <small>📅 Fits on ${f.day.charAt(0).toUpperCase() + f.day.slice(1)}</small><br>
                        <small>🏠 ${f.distanceFromHome.toFixed(1)} miles from home</small><br>
                        <small>⏱️ ${f.job.est_hours || 2}h (${f.remainingCapacity}h available)</small>
                        <button onclick='quickAddJobToDay(${JSON.stringify(f.job)}, "${f.day}")' style='margin-top: 5px; padding: 4px 8px; font-size: 12px;'>
                            + Add to ${f.day}
                        </button>
                    </div>
                `;
            });
            
            suggestionsDiv.innerHTML = html;
        }

        function optimizeWeek() {
            if (!selectedTech) {
                alert('Please select a technician first');
                return;
            }
            
            const suggestionsDiv = document.getElementById('suggestions');
            
            // Calculate current efficiency
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
            let totalTravel = 0;
            let totalHours = 0;
            let emptyDays = 0;
            
            days.forEach(day => {
                const dayJobs = schedules[selectedTech.technician_id][day];
                if (dayJobs.length === 0) {
                    emptyDays++;
                } else {
                    dayJobs.forEach(j => totalHours += (j.est_hours || 2));
                    
                    // Calculate travel between jobs
                    for (let i = 1; i < dayJobs.length; i++) {
                        if (dayJobs[i-1].latitude && dayJobs[i].latitude) {
                            totalTravel += calculateDistance(
                                dayJobs[i-1].latitude, dayJobs[i-1].longitude,
                                dayJobs[i].latitude, dayJobs[i].longitude
                            );
                        }
                    }
                }
            });
            
            const efficiency = totalHours > 0 ? 
                ((totalHours / (totalHours + totalTravel/25)) * 100).toFixed(1) : 0;
            
            let html = `
                <div style="padding: 10px; background: white; border-radius: 6px;">
                    <h4 style="color: #7c3aed; margin: 0 0 10px 0;">📊 Week Analysis</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <strong>Total Hours:</strong> ${totalHours.toFixed(1)}h<br>
                            <strong>Travel Distance:</strong> ${totalTravel.toFixed(0)} miles<br>
                        </div>
                        <div>
                            <strong>Efficiency:</strong> ${efficiency}%<br>
                            <strong>Empty Days:</strong> ${emptyDays}<br>
                        </div>
                    </div>
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e5e7eb;">
                        <strong>💡 Recommendations:</strong><br>
            `;
            
            if (emptyDays > 2) {
                html += `• Consider consolidating jobs to fewer days<br>`;
            }
            if (totalTravel > 200) {
                html += `• High travel distance - group jobs by area<br>`;
            }
            if (efficiency < 70) {
                html += `• Low efficiency - use "Find Nearby Jobs" to reduce travel<br>`;
            }
            if (totalHours < selectedTech.max_weekly_hours * 0.7) {
                html += `• ${(selectedTech.max_weekly_hours - totalHours).toFixed(1)}h capacity remaining<br>`;
            }
            
            html += `
                    </div>
                </div>
            `;
            
            suggestionsDiv.innerHTML = html;
        }

        // Helper functions
        function calculateDistance(lat1, lon1, lat2, lon2) {
            // Simple distance calculation (Haversine formula)
            const R = 3958.8; // Earth radius in miles
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function quickAddJob(job) {
            // Find best day for this job
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
            
            for (let day of days) {
                const dayHours = schedules[selectedTech.technician_id][day]
                    .reduce((sum, j) => sum + (j.est_hours || 2), 0);
                
                if (dayHours + (job.est_hours || 2) <= selectedTech.max_daily_hours) {
                    schedules[selectedTech.technician_id][day].push(job);
                    updateScheduleDisplay();
                    displayJobs();
                    plotJobsOnMap();
                    updateStats();
                    alert(`Added WO ${job.work_order} to ${day}`);
                    return;
                }
            }
            
            alert('No capacity available this week for this job');
        }

        function quickAddJobToDay(job, day) {
            schedules[selectedTech.technician_id][day].push(job);
            updateScheduleDisplay();
            displayJobs();
            plotJobsOnMap();
            updateStats();
        };
    </script>
</body>
</html>