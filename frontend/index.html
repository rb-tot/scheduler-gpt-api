<!DOCTYPE html>
<html>
<head>
    <title>Job Scheduler</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            overflow: hidden;
        }
        
        .header {
            background: #2563eb;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
        }

        .main-container {
            display: grid;
            grid-template-rows: 400px 1fr;
            height: calc(100vh - 60px);
        }

        /* Map Section with AI overlay */
        .map-section {
            position: relative;
            border-bottom: 2px solid #dee2e6;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        /* AI Suggestions Overlay - Top of map */
        .ai-suggestions-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30%;
            max-width: 400px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .ai-suggestions-panel.collapsed {
            height: 40px;
            overflow: hidden;
        }

        .ai-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 15px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .ai-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }

        .ai-content {
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .ai-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .ai-buttons button {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
            flex: 1;
            min-width: 100px;
        }

        /* Bottom Panels - Adjusted widths */
        .bottom-section {
            display: grid;
            grid-template-columns: 35% 65%;
            overflow: hidden;
            height: 100%;
        }

        .panel {
            display: flex;
            flex-direction: column;
            background: white;
            border-right: 1px solid #dee2e6;
            height: 100%;
        }

        .panel-header {
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            font-weight: bold;
            flex-shrink: 0;
        }

        .panel-controls {
            padding: 10px;
            background: white;
            border-bottom: 1px solid #dee2e6;
            flex-shrink: 0;
        }

        /* Fix scrolling for job list */
        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            min-height: 0; /* Important for Firefox */
        }

        /* Week selector */
        .week-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .week-nav {
            display: flex;
            gap: 5px;
        }

        .week-nav button {
            padding: 5px 10px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            cursor: pointer;
        }

        .week-nav button:hover {
            background: #f8f9fa;
        }

        /* Job Cards */
        .job-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            cursor: move;
            transition: all 0.2s;
        }

        .job-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }

        .job-card.scheduled {
            opacity: 0.5;
            background: #f9fafb;
            cursor: not-allowed;
        }

        .job-card.ineligible {
            opacity: 0.4;
            border-color: #dc2626;
            background: #fef2f2;
        }

        /* Schedule Grid */
        .schedule-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin: 10px;
            flex: 1;
            min-height: 0;
        }

        .day-column {
            border: 2px solid #dee2e6;
            border-radius: 6px;
            background: #ffffff;
            display: flex;
            flex-direction: column;
        }

        .day-header {
            background: #3b82f6;
            color: white;
            padding: 8px;
            text-align: center;
            font-weight: bold;
            border-radius: 4px 4px 0 0;
        }

        .day-date {
            font-size: 11px;
            font-weight: normal;
            opacity: 0.9;
        }

        /* Day drop zone - always droppable */
        .day-jobs {
            flex: 1;
            padding: 8px;
            min-height: 150px;
            position: relative;
            transition: all 0.3s;
        }

        .day-jobs.drag-over {
            background: #dbeafe;
            border: 2px dashed #3b82f6;
        }

        /* Empty state message */
        .day-jobs:empty::after {
            content: 'Drop jobs here';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #9ca3af;
            font-style: italic;
            pointer-events: none;
        }

        /* Hotel toggle */
        .hotel-toggle {
            padding: 5px;
            background: #fef3c7;
            border-top: 1px solid #fbbf24;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }

        .hotel-toggle input {
            cursor: pointer;
        }

        /* Scheduled jobs */
        .scheduled-job {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            padding: 6px;
            margin: 4px 0;
            border-radius: 4px;
            font-size: 12px;
            position: relative;
            cursor: move;
        }

        .scheduled-job:hover .remove-job {
            opacity: 1;
        }

        .remove-job {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 3px;
            width: 18px;
            height: 18px;
            font-size: 12px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .remove-job:hover {
            background: #dc2626;
        }

        /* Stats */
        .stats-row {
            display: flex;
            gap: 15px;
            padding: 10px;
            background: #f9fafb;
            border-bottom: 1px solid #dee2e6;
            flex-shrink: 0;
        }

        .stat {
            flex: 1;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #2563eb;
        }

        .stat-label {
            font-size: 11px;
            color: #6b7280;
            text-transform: uppercase;
        }

        /* Daily hours display */
        .day-hours {
            padding: 5px;
            background: #f0f9ff;
            border-top: 1px solid #0284c7;
            font-size: 11px;
            text-align: center;
            color: #075985;
        }

        .day-hours.over-capacity {
            background: #fef2f2;
            border-color: #dc2626;
            color: #991b1b;
        }

        /* Controls */
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background: #2563eb;
        }

        input, select {
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
        }

        .job-count-info {
            font-size: 12px;
            color: #6b7280;
            padding: 5px 10px;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìÖ Job Scheduler</h1>
        <nav>
            <button onclick="saveSchedule()">üíæ Save Schedule</button>
        </nav>
    </div>
    
    <div class="main-container">
        <!-- Map Section with AI Overlay -->
        <div class="map-section">
            <div id="map"></div>
            
            <!-- AI Suggestions Panel - Floating on map -->
            <div class="ai-suggestions-panel" id="ai-panel">
                <div class="ai-header" onclick="toggleAIPanel()">
                    <span>ü§ñ AI Suggestions</span>
                    <button class="ai-toggle" id="ai-toggle">‚ñº</button>
                </div>
                <div class="ai-content">
                    <div class="ai-buttons">
                        <button onclick="suggestNearbyJobs()" style="background: #0ea5e9;">Find Nearby</button>
                        <button onclick="suggestBestFit()" style="background: #10b981;">Best Fit</button>
                        <button onclick="optimizeWeek()" style="background: #8b5cf6;">Optimize</button>
                    </div>
                    <div id="suggestions">
                        <p style="color: #64748b; font-style: italic; text-align: center;">
                            Select a technician to see suggestions
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Section - Jobs and Schedule -->
        <div class="bottom-section">
            <!-- Jobs Panel (35% width) -->
            <div class="panel">
                <div class="panel-header">
                    Unassigned Jobs (<span id="job-count">0</span>)
                </div>
                <div class="panel-controls">
                    <input type="date" id="start-date" value="2025-09-01">
                    <input type="date" id="end-date" value="2025-09-30">
                    <button onclick="loadJobs()">Load Jobs</button>
                </div>
                <div class="stats-row">
                    <div class="stat">
                        <div class="stat-label">Total Hours</div>
                        <div class="stat-value" id="total-hours">0</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Urgent</div>
                        <div class="stat-value" id="urgent-count">0</div>
                    </div>
                </div>
                <div class="job-count-info">
                    Showing <span id="showing-count">0</span> of <span id="total-count">0</span> jobs
                    <span id="filtered-info"></span>
                </div>
                <div class="panel-content" id="job-list">
                    <!-- Jobs appear here -->
                </div>
            </div>

            <!-- Schedule Panel (65% width) -->
            <div class="panel" style="border-right: none;">
                <div class="panel-header">
                    Weekly Schedule
                </div>
                
                <!-- Week Selector -->
                <div class="week-selector">
                    <label>Week:</label>
                    <div class="week-nav">
                        <button onclick="changeWeek(-1)">‚óÄ</button>
                        <input type="week" id="week-select" onchange="loadWeek()">
                        <button onclick="changeWeek(1)">‚ñ∂</button>
                    </div>
                    <select id="tech-select" onchange="selectTech()">
                        <option value="">Select Technician</option>
                    </select>
                    <span id="tech-hours" style="margin-left: auto; font-weight: bold;">
                        0h / 0h
                    </span>
                </div>
                
                <!-- Schedule Grid -->
                <div class="schedule-grid" id="schedule-grid">
                    <!-- Days will be generated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Global variables
        const API_KEY = 'devkey123';
        let map;
        let jobs = [];
        let techs = [];
        let selectedTech = null;
        let schedules = {};
        let weekDates = {};
        let scheduledJobIds = new Set(); // Track scheduled jobs to prevent duplicates
        let techEligibility = {}; // Store tech eligibility data
        
        // Initialize map
        function initMap() {
            map = L.map('map').setView([39.0, -105.5], 7);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        }
        
        // Toggle AI Panel
        function toggleAIPanel() {
            const panel = document.getElementById('ai-panel');
            const toggle = document.getElementById('ai-toggle');
            
            if (panel.classList.contains('collapsed')) {
                panel.classList.remove('collapsed');
                toggle.textContent = '‚ñº';
            } else {
                panel.classList.add('collapsed');
                toggle.textContent = '‚ñ∂';
            }
        }
        
        // Initialize week selector and dates
        function initializeWeek() {
            const now = new Date();
            const monday = new Date(now);
            monday.setDate(now.getDate() - now.getDay() + 1);
            
            // Set week selector
            const year = monday.getFullYear();
            const week = getWeekNumber(monday);
            document.getElementById('week-select').value = `${year}-W${week.toString().padStart(2, '0')}`;
            
            updateWeekDates();
            createScheduleGrid();
        }
        
        // Get week number
        function getWeekNumber(d) {
            const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            date.setUTCDate(date.getUTCDate() + 4 - (date.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1));
            const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
            return weekNo;
        }
        
        // Update week dates
        function updateWeekDates() {
            const weekInput = document.getElementById('week-select').value;
            if (!weekInput) return;
            
            const [year, week] = weekInput.split('-W');
            const firstDayOfYear = new Date(year, 0, 1);
            const days = 2 + (week - 1) * 7 - firstDayOfYear.getDay() + 1;
            const monday = new Date(year, 0, days);
            
            weekDates = {
                monday: new Date(monday),
                tuesday: new Date(monday.getTime() + 86400000),
                wednesday: new Date(monday.getTime() + 86400000 * 2),
                thursday: new Date(monday.getTime() + 86400000 * 3),
                friday: new Date(monday.getTime() + 86400000 * 4)
            };
        }
        
        // Create schedule grid with dates
        function createScheduleGrid() {
            const grid = document.getElementById('schedule-grid');
            grid.innerHTML = '';
            
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
            
            days.forEach(day => {
                const date = weekDates[day];
                const dateStr = date ? `${date.getMonth() + 1}/${date.getDate()}` : '';
                
                const dayCol = document.createElement('div');
                dayCol.className = 'day-column';
                dayCol.innerHTML = `
                    <div class="day-header">
                        ${day.charAt(0).toUpperCase() + day.slice(1)}
                        <div class="day-date">${dateStr}</div>
                    </div>
                    <div class="day-jobs" 
                         id="${day}-jobs" 
                         data-day="${day}"
                         ondrop="dropJob(event, '${day}')" 
                         ondragover="allowDrop(event)" 
                         ondragleave="clearDrop(event)">
                    </div>
                    <div class="day-hours" id="${day}-hours">
                        0h / 0h
                    </div>
                    <div class="hotel-toggle">
                        <input type="checkbox" id="${day}-hotel" onchange="updateDayHours('${day}')">
                        <label for="${day}-hotel">üè® Staying out</label>
                    </div>
                `;
                grid.appendChild(dayCol);
            });
        }
        
        // Change week
        function changeWeek(direction) {
            const weekInput = document.getElementById('week-select');
            const [year, week] = weekInput.value.split('-W');
            const newWeek = parseInt(week) + direction;
            
            if (newWeek < 1) {
                weekInput.value = `${parseInt(year) - 1}-W52`;
            } else if (newWeek > 52) {
                weekInput.value = `${parseInt(year) + 1}-W01`;
            } else {
                weekInput.value = `${year}-W${newWeek.toString().padStart(2, '0')}`;
            }
            
            loadWeek();
        }
        
        // Load week
        function loadWeek() {
            updateWeekDates();
            createScheduleGrid();
            
            if (selectedTech) {
                updateScheduleDisplay();
            }
        }
        
        // Load jobs
        async function loadJobs() {
            const start = document.getElementById('start-date').value;
            const end = document.getElementById('end-date').value;
            
            try {
                const response = await fetch(
                    `/jobs/pool?start=${start}&end=${end}&limit=500`,
                    { headers: {'X-API-Key': API_KEY} }
                );
                const data = await response.json();
                jobs = data.jobs.filter(j => 
                    j.jp_status === 'Call' || 
                    j.jp_status === 'Waiting to Schedule'
                );
                
                // Load eligibility data if available
                await loadEligibilityData();
                
                displayJobs();
                plotJobsOnMap();
                updateStats();
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to load jobs');
            }
        }
        
        // Load eligibility data
        async function loadEligibilityData() {
            // This would load from your job_technician_eligibility table
            // For now, we'll assume all techs can do all jobs
            // You can implement the actual API call here
        }
        
        // Display jobs
        function displayJobs() {
            const container = document.getElementById('job-list');
            container.innerHTML = '';
            
            let displayedCount = 0;
            let eligibleCount = 0;
            
            jobs.forEach(job => {
                // Skip if already scheduled
                if (scheduledJobIds.has(job.work_order)) {
                    return;
                }
                
                const isEligible = !selectedTech || checkTechEligibility(selectedTech.technician_id, job.work_order);
                if (selectedTech && !isEligible) {
                    return; // Don't show ineligible jobs when tech selected
                }
                
                displayedCount++;
                if (isEligible) eligibleCount++;
                
                const div = document.createElement('div');
                div.className = `job-card ${!isEligible ? 'ineligible' : ''}`;
                div.id = `job-${job.work_order}`;
                div.draggable = isEligible;
                div.ondragstart = (e) => dragJob(e, job);
                
                const urgentBadge = (job.jp_priority === 'NOV' || job.jp_priority === 'Urgent') 
                    ? '<span style="color: red; float: right;">‚ö†Ô∏è</span>' : '';
                
                div.innerHTML = `
                    ${urgentBadge}
                    <strong>WO ${job.work_order}</strong> - ${job.est_hours || 2}h<br>
                    <small>${job.site_name}<br>
                    ${job.site_city}, ${job.site_state}<br>
                    Due: ${new Date(job.due_date).toLocaleDateString()}</small>
                `;
                
                container.appendChild(div);
            });
            
            // Update counts
            document.getElementById('job-count').textContent = displayedCount;
            document.getElementById('showing-count').textContent = displayedCount;
            document.getElementById('total-count').textContent = jobs.length - scheduledJobIds.size;
            
            if (selectedTech) {
                document.getElementById('filtered-info').textContent = ` (${eligibleCount} eligible for ${selectedTech.name})`;
            } else {
                document.getElementById('filtered-info').textContent = '';
            }
        }
        
        // Check tech eligibility
        function checkTechEligibility(techId, workOrder) {
            // For now, return true for all
            // Implement actual eligibility check using your data
            return true;
        }
        
        // Plot jobs on map
        function plotJobsOnMap() {
            // Clear existing markers
            map.eachLayer(layer => {
                if (layer instanceof L.CircleMarker) {
                    map.removeLayer(layer);
                }
            });
            
            jobs.forEach(job => {
                if (!job.latitude || !job.longitude) return;
                if (scheduledJobIds.has(job.work_order)) return;
                
                const color = job.jp_priority === 'Urgent' ? 'red' : 'blue';
                L.circleMarker([job.latitude, job.longitude], {
                    radius: 6,
                    fillColor: color,
                    color: 'white',
                    weight: 2,
                    fillOpacity: 0.8
                }).addTo(map).bindPopup(`
                    <strong>${job.site_name}</strong><br>
                    WO: ${job.work_order}<br>
                    ${job.est_hours || 2} hours
                `);
            });
        }
        
        // Load technicians
        async function loadTechs() {
            try {
                const response = await fetch('/technicians?active_only=true', {
                    headers: {'X-API-Key': API_KEY}
                });
                const data = await response.json();
                techs = data.technicians;
                
                const select = document.getElementById('tech-select');
                techs.forEach(tech => {
                    const option = document.createElement('option');
                    option.value = tech.technician_id;
                    option.textContent = `${tech.name} (${tech.home_location})`;
                    select.appendChild(option);
                    
                    // Initialize schedule for each tech
                    if (!schedules[tech.technician_id]) {
                        schedules[tech.technician_id] = {
                            monday: [],
                            tuesday: [],
                            wednesday: [],
                            thursday: [],
                            friday: []
                        };
                    }
                });
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        // Select technician
        function selectTech() {
            const techId = document.getElementById('tech-select').value;
            if (!techId) {
                selectedTech = null;
                displayJobs(); // Refresh to show all jobs
                return;
            }
            
            selectedTech = techs.find(t => t.technician_id == techId);
            displayJobs(); // Refresh to filter eligible jobs
            updateScheduleDisplay();
        }
        
        // Drag and drop functions
        function dragJob(event, job) {
            event.dataTransfer.setData('job', JSON.stringify(job));
        }
        
        function allowDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }
        
        function clearDrop(event) {
            event.currentTarget.classList.remove('drag-over');
        }
        
        function dropJob(event, day) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
            
            if (!selectedTech) {
                alert('Please select a technician first');
                return;
            }
            
            const job = JSON.parse(event.dataTransfer.getData('job'));
            
            // Check if job already scheduled
            if (scheduledJobIds.has(job.work_order)) {
                alert('This job is already scheduled');
                return;
            }
            
            // Check capacity
            const dayJobs = schedules[selectedTech.technician_id][day];
            const dayHours = calculateDayHours(selectedTech, day);
            
            if (dayHours.total + (job.est_hours || 2) > selectedTech.max_daily_hours) {
                alert(`This exceeds ${selectedTech.name}'s daily capacity of ${selectedTech.max_daily_hours} hours`);
                return;
            }
            
            // Add to schedule
            schedules[selectedTech.technician_id][day].push(job);
            scheduledJobIds.add(job.work_order);
            
            // Update displays
            updateScheduleDisplay();
            displayJobs();
            plotJobsOnMap();
            updateStats();
        }
        
        // Calculate day hours including travel
        function calculateDayHours(tech, day) {
            const dayJobs = schedules[tech.technician_id][day];
            let jobHours = 0;
            let travelHours = 0;
            
            if (dayJobs.length === 0) {
                return { jobs: 0, travel: 0, total: 0 };
            }
            
            // Calculate job hours
            dayJobs.forEach(job => {
                jobHours += job.est_hours || 2;
            });
            
            // Calculate travel time
            // From home to first job (unless staying out from previous day)
            const prevDay = getPreviousDay(day);
            const stayingFromPrevious = prevDay && document.getElementById(`${prevDay}-hotel`)?.checked;
            
            if (!stayingFromPrevious && dayJobs[0] && tech.home_latitude && dayJobs[0].latitude) {
                const homeToFirst = calculateDistance(
                    tech.home_latitude, tech.home_longitude,
                    dayJobs[0].latitude, dayJobs[0].longitude
                );
                travelHours += homeToFirst / 50; // Assume 50mph average
            }
            
            // Between jobs
            for (let i = 1; i < dayJobs.length; i++) {
                if (dayJobs[i-1].latitude && dayJobs[i].latitude) {
                    const betweenJobs = calculateDistance(
                        dayJobs[i-1].latitude, dayJobs[i-1].longitude,
                        dayJobs[i].latitude, dayJobs[i].longitude
                    );
                    travelHours += betweenJobs / 50;
                }
            }
            
            // Back home (unless staying out)
            const stayingOut = document.getElementById(`${day}-hotel`)?.checked;
            if (!stayingOut && dayJobs[dayJobs.length - 1] && tech.home_latitude) {
                const lastJob = dayJobs[dayJobs.length - 1];
                if (lastJob.latitude) {
                    const lastToHome = calculateDistance(
                        lastJob.latitude, lastJob.longitude,
                        tech.home_latitude, tech.home_longitude
                    );
                    travelHours += lastToHome / 50;
                }
            }
            
            return {
                jobs: jobHours,
                travel: Math.round(travelHours * 10) / 10,
                total: Math.round((jobHours + travelHours) * 10) / 10
            };
        }
        
        // Get previous day
        function getPreviousDay(day) {
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
            const index = days.indexOf(day);
            return index > 0 ? days[index - 1] : null;
        }
        
        // Update day hours display
        function updateDayHours(day) {
            if (!selectedTech) return;
            
            const hours = calculateDayHours(selectedTech, day);
            const hoursDiv = document.getElementById(`${day}-hours`);
            
            hoursDiv.textContent = `${hours.total}h (${hours.jobs}h work + ${hours.travel}h travel)`;
            
            if (hours.total > selectedTech.max_daily_hours) {
                hoursDiv.className = 'day-hours over-capacity';
            } else {
                hoursDiv.className = 'day-hours';
            }
        }
        
        // Update schedule display
        function updateScheduleDisplay() {
            if (!selectedTech) return;
            
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
            let totalWeekHours = 0;
            
            days.forEach(day => {
                const dayDiv = document.getElementById(`${day}-jobs`);
                dayDiv.innerHTML = '';
                
                const dayJobs = schedules[selectedTech.technician_id][day];
                
                dayJobs.forEach((job, index) => {
                    const jobDiv = document.createElement('div');
                    jobDiv.className = 'scheduled-job';
                    jobDiv.innerHTML = `
                        WO ${job.work_order} - ${job.est_hours || 2}h
                        <button class="remove-job" onclick="removeJob('${day}', ${index}, ${job.work_order})" title="Remove">√ó</button>
                    `;
                    dayDiv.appendChild(jobDiv);
                });
                
                // Update day hours
                updateDayHours(day);
                const dayHours = calculateDayHours(selectedTech, day);
                totalWeekHours += dayHours.total;
            });
            
            // Update week total
            document.getElementById('tech-hours').textContent = 
                `${totalWeekHours.toFixed(1)}h / ${selectedTech.max_weekly_hours}h`;
        }
        
        // Remove job from schedule
        function removeJob(day, index, workOrder) {
            if (!selectedTech) return;
            
            // Remove from schedule
            schedules[selectedTech.technician_id][day].splice(index, 1);
            
            // Remove from scheduled set
            scheduledJobIds.delete(workOrder);
            
            // Update displays
            updateScheduleDisplay();
            displayJobs();
            plotJobsOnMap();
            updateStats();
        }
        
        // Calculate distance
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 3958.8; // Earth radius in miles
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        // Update stats
        function updateStats() {
            const unscheduledJobs = jobs.filter(j => !scheduledJobIds.has(j.work_order));
            
            const totalHours = unscheduledJobs.reduce((sum, j) => sum + (j.est_hours || 2), 0);
            const urgentCount = unscheduledJobs.filter(j => 
                j.jp_priority === 'NOV' || j.jp_priority === 'Urgent'
            ).length;
            
            document.getElementById('total-hours').textContent = totalHours.toFixed(1);
            document.getElementById('urgent-count').textContent = urgentCount;
        }
        
        // Save schedule
        async function saveSchedule() {
            console.log('Saving schedule:', schedules);
            console.log('Scheduled job IDs:', Array.from(scheduledJobIds));
            
            // Here you would save to database
            // Could create a 'scheduled_jobs_temp' table or similar
            
            alert('Schedule ready to save - check console for data');
        }
        // AI Suggestion Functions (add these before window.onload)

        function suggestNearbyJobs() {
            if (!selectedTech) {
                alert('Please select a technician first');
                return;
            }
            
            const suggestionsDiv = document.getElementById('suggestions');
            suggestionsDiv.innerHTML = '<p>üîç Finding nearby jobs...</p>';
            
            // Get all scheduled jobs for this tech
            const scheduledJobs = [];
            for (let day in schedules[selectedTech.technician_id]) {
                schedules[selectedTech.technician_id][day].forEach(job => {
                    scheduledJobs.push({ ...job, day: day });
                });
            }
            
            if (scheduledJobs.length === 0) {
                suggestionsDiv.innerHTML = '<p>‚ö†Ô∏è Schedule some jobs first, then I can find nearby ones!</p>';
                return;
            }
            
            // Find unscheduled jobs near scheduled ones
            const unscheduledJobs = jobs.filter(j => !scheduledJobIds.has(j.work_order));
            const suggestions = [];
            
            scheduledJobs.forEach(schedJob => {
                if (!schedJob.latitude || !schedJob.longitude) return;
                
                unscheduledJobs.forEach(job => {
                    if (!job.latitude || !job.longitude) return;
                    
                    const distance = calculateDistance(
                        schedJob.latitude, schedJob.longitude,
                        job.latitude, job.longitude
                    );
                    
                    if (distance < 20) { // Within 20 miles
                        suggestions.push({
                            job: job,
                            nearJob: schedJob,
                            distance: distance,
                            suggestedDay: schedJob.day // Same day as nearby job
                        });
                    }
                });
            });
            
            // Remove duplicates and sort by distance
            const uniqueSuggestions = [];
            const seen = new Set();
            suggestions.sort((a, b) => a.distance - b.distance);
            
            suggestions.forEach(s => {
                if (!seen.has(s.job.work_order)) {
                    seen.add(s.job.work_order);
                    uniqueSuggestions.push(s);
                }
            });
            
            const top5 = uniqueSuggestions.slice(0, 5);
            
            if (top5.length === 0) {
                suggestionsDiv.innerHTML = '<p>No nearby jobs found within 20 miles of scheduled jobs</p>';
                return;
            }
            
            let html = '<div style="color: #0c4a6e;"><strong>üìç Nearby Jobs (within 20 miles):</strong></div>';
            top5.forEach(s => {
                const dayCapitalized = s.suggestedDay.charAt(0).toUpperCase() + s.suggestedDay.slice(1);
                html += `
                    <div style="padding: 8px; margin: 5px 0; background: white; border-radius: 4px; border-left: 3px solid #0ea5e9;">
                        <strong>WO ${s.job.work_order}</strong> - ${s.job.site_name}<br>
                        <small>üìè ${s.distance.toFixed(1)} miles from WO ${s.nearJob.work_order} on ${dayCapitalized}</small><br>
                        <small>‚è±Ô∏è ${s.job.est_hours || 2} hours</small><br>
                        <select id="day-select-${s.job.work_order}" style="margin-top: 5px; padding: 4px;">
                            <option value="${s.suggestedDay}" selected>${dayCapitalized} (recommended)</option>
                            <option value="monday">Monday</option>
                            <option value="tuesday">Tuesday</option>
                            <option value="wednesday">Wednesday</option>
                            <option value="thursday">Thursday</option>
                            <option value="friday">Friday</option>
                        </select>
                        <button onclick='addJobToSelectedDay(${JSON.stringify(s.job)}, "${s.job.work_order}")' style='margin-left: 5px; padding: 4px 8px; font-size: 12px;'>
                            + Add
                        </button>
                    </div>
                `;
            });
            
            suggestionsDiv.innerHTML = html;
        }

        function addJobToSelectedDay(job, workOrderId) {
            const daySelect = document.getElementById(`day-select-${workOrderId}`);
            const selectedDay = daySelect.value;
            
            if (!selectedTech) {
                alert('Please select a technician first');
                return;
            }
            
            // Check if already scheduled
            if (scheduledJobIds.has(job.work_order)) {
                alert('This job is already scheduled');
                return;
            }
            
            // Check capacity
            const dayHours = calculateDayHours(selectedTech, selectedDay);
            if (dayHours.total + (job.est_hours || 2) > selectedTech.max_daily_hours) {
                alert(`This exceeds ${selectedTech.name}'s daily capacity for ${selectedDay}`);
                return;
            }
            
            // Add to schedule
            schedules[selectedTech.technician_id][selectedDay].push(job);
            scheduledJobIds.add(job.work_order);
            
            // Update displays
            updateScheduleDisplay();
            displayJobs();
            plotJobsOnMap();
            updateStats();
            
            // Refresh suggestions
            suggestNearbyJobs();
        }

        function suggestBestFit() {
            if (!selectedTech) {
                alert('Please select a technician first');
                return;
            }
            
            const suggestionsDiv = document.getElementById('suggestions');
            suggestionsDiv.innerHTML = '<p>üîç Finding best fit jobs...</p>';
            
            // Calculate remaining capacity per day
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
            const capacity = {};
            
            days.forEach(day => {
                const hours = calculateDayHours(selectedTech, day);
                capacity[day] = Math.max(0, selectedTech.max_daily_hours - hours.total);
            });
            
            // Find jobs that fit
            const unscheduledJobs = jobs.filter(j => !scheduledJobIds.has(j.work_order));
            const fits = [];
            
            unscheduledJobs.forEach(job => {
                const jobHours = job.est_hours || 2;
                
                days.forEach(day => {
                    if (capacity[day] >= jobHours + 1) { // +1 for travel time estimate
                        if (selectedTech.home_latitude && job.latitude) {
                            const distanceFromHome = calculateDistance(
                                selectedTech.home_latitude, selectedTech.home_longitude,
                                job.latitude, job.longitude
                            );
                            
                            if (distanceFromHome < 50) {
                                fits.push({
                                    job: job,
                                    day: day,
                                    remainingCapacity: capacity[day],
                                    distanceFromHome: distanceFromHome,
                                    score: (50 - distanceFromHome) + (jobHours * 10)
                                });
                            }
                        }
                    }
                });
            });
            
            // Sort by score and get unique jobs
            fits.sort((a, b) => b.score - a.score);
            const uniqueFits = [];
            const seen = new Set();
            
            fits.forEach(f => {
                if (!seen.has(f.job.work_order)) {
                    seen.add(f.job.work_order);
                    uniqueFits.push(f);
                }
            });
            
            const top5 = uniqueFits.slice(0, 5);
            
            if (top5.length === 0) {
                suggestionsDiv.innerHTML = '<p>No jobs found that fit remaining capacity</p>';
                return;
            }
            
            let html = '<div style="color: #0c4a6e;"><strong>‚ú® Best Fit Jobs:</strong></div>';
            top5.forEach(f => {
                html += `
                    <div style="padding: 8px; margin: 5px 0; background: white; border-radius: 4px; border-left: 3px solid #10b981;">
                        <strong>WO ${f.job.work_order}</strong> - ${f.job.site_name}<br>
                        <small>üìÖ Best fit: ${f.day.charAt(0).toUpperCase() + f.day.slice(1)}</small><br>
                        <small>üè† ${f.distanceFromHome.toFixed(1)} miles from home</small><br>
                        <small>‚è±Ô∏è ${f.job.est_hours || 2}h (${f.remainingCapacity.toFixed(1)}h available)</small>
                        <button onclick='quickAddJobToDay(${JSON.stringify(f.job)}, "${f.day}")' style='margin-top: 5px; padding: 4px 8px; font-size: 12px;'>
                            + Add to ${f.day}
                        </button>
                    </div>
                `;
            });
            
            suggestionsDiv.innerHTML = html;
        }

        function quickAddJobToDay(job, day) {
            if (!selectedTech) return;
            
            // Check if already scheduled
            if (scheduledJobIds.has(job.work_order)) {
                alert('This job is already scheduled');
                return;
            }
            
            schedules[selectedTech.technician_id][day].push(job);
            scheduledJobIds.add(job.work_order);
            
            updateScheduleDisplay();
            displayJobs();
            plotJobsOnMap();
            updateStats();
            
            // Refresh suggestions
            suggestBestFit();
        }

        function optimizeWeek() {
            if (!selectedTech) {
                alert('Please select a technician first');
                return;
            }
            
            const suggestionsDiv = document.getElementById('suggestions');
            
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
            let totalTravel = 0;
            let totalHours = 0;
            let totalJobs = 0;
            let emptyDays = 0;
            
            days.forEach(day => {
                const dayJobs = schedules[selectedTech.technician_id][day];
                const dayHours = calculateDayHours(selectedTech, day);
                
                if (dayJobs.length === 0) {
                    emptyDays++;
                } else {
                    totalJobs += dayJobs.length;
                    totalHours += dayHours.total;
                    totalTravel += dayHours.travel;
                }
            });
            
            const efficiency = totalHours > 0 ? 
                ((totalHours - totalTravel) / totalHours * 100).toFixed(1) : 0;
            
            let html = `
                <div style="padding: 10px; background: white; border-radius: 6px;">
                    <h4 style="color: #7c3aed; margin: 0 0 10px 0;">üìä Week Analysis</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 13px;">
                        <div>
                            <strong>Jobs Scheduled:</strong> ${totalJobs}<br>
                            <strong>Total Hours:</strong> ${totalHours.toFixed(1)}h<br>
                            <strong>Travel Time:</strong> ${totalTravel.toFixed(1)}h
                        </div>
                        <div>
                            <strong>Work Efficiency:</strong> ${efficiency}%<br>
                            <strong>Empty Days:</strong> ${emptyDays}<br>
                            <strong>Avg per Day:</strong> ${(totalJobs / (5 - emptyDays)).toFixed(1)} jobs
                        </div>
                    </div>
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e5e7eb;">
                        <strong>üí° Recommendations:</strong><br>
            `;
            
            if (emptyDays > 2) {
                html += `‚Ä¢ Consider consolidating to fewer days for efficiency<br>`;
            }
            if (totalTravel > totalHours * 0.3) {
                html += `‚Ä¢ High travel time - use "Find Nearby" to reduce<br>`;
            }
            if (totalHours < selectedTech.max_weekly_hours * 0.7) {
                const remaining = selectedTech.max_weekly_hours - totalHours;
                html += `‚Ä¢ ${remaining.toFixed(1)}h capacity available - add more jobs<br>`;
            }
            if (totalJobs > 0 && totalJobs < 10) {
                html += `‚Ä¢ Low job count - use "Best Fit" to fill schedule<br>`;
            }
            
            html += `
                    </div>
                </div>
            `;
            
            suggestionsDiv.innerHTML = html;
        }       
        // Initialize
        window.onload = function() {
            initMap();
            initializeWeek();
            loadTechs();
        };
    </script>
</body>
</html>