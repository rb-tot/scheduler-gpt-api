<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedule Review Dashboard - SchedulerGPT</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f3f4f6;
            color: #1f2937;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        
        /* HEADER */
        .header {
            background: #4f46e5;
            color: white;
            padding: 0.75rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .week-nav {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(255,255,255,0.1);
            padding: 0.25rem;
            border-radius: 6px;
        }
        
        .week-nav button {
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 1.25rem;
        }
        
        .week-nav button:hover {
            background: rgba(255,255,255,0.2);
        }
        
        #week-display {
            padding: 0 1rem;
            font-size: 0.875rem;
        }
        
        /* MAIN LAYOUT */
        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        
        /* DETAIL PANEL */
        .detail-panel {
            background: white;
            border-top: 1px solid #e5e7eb;
            min-height: 0px;
            max-height: 0px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .detail-panel.empty {
            /* Stays collapsed when empty */
            min-height: 0px;
            max-height: 0px;
        }

        .detail-panel.active {
            min-height: 200px;
            max-height: 600px;
            overflow-y: auto;
        }

        .detail-content {
            padding: 1rem;
        }

        
        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .detail-header h3 {
            font-size: 1rem;
            font-weight: 600;
            color: #1f2937;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            font-size: 1.25rem;
            padding: 0.25rem;
        }
        
        .close-btn:hover {
            color: #374151;
        }
        
        .jobs-table {
            width: 100%;
            font-size: 0.875rem;
        }
        
        .jobs-table th {
            text-align: left;
            padding: 0.5rem;
            background: #f9fafb;
            font-weight: 600;
            color: #4b5563;
        }
        
        .jobs-table td {
            padding: 0.5rem;
            border-top: 1px solid #f3f4f6;
        }
        
        .job-actions {
            display: flex;
            gap: 0.25rem;
        }
        
        .job-actions button {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .job-actions button:hover {
            background: #f3f4f6;
        }
        
        /* SCHEDULE GRID */
        .schedule-container {
            background: white;
            margin: 1rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: auto;
            max-height: 400px;
        }
        
        .schedule-grid {
            width: 100%;
            border-collapse: collapse;
            min-width: 700px;
        }
        
        .schedule-grid th,
        .schedule-grid td {
            padding: 0.75rem;
            text-align: center;
            border: 1px solid #e5e7eb;
        }
        
        .schedule-grid th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .schedule-grid .tech-column {
            text-align: left;
            position: sticky;
            left: 0;
            background: white;
            z-index: 5;
            min-width: 150px;
        }
        
        .tech-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .tech-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        
        .day-cell {
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
        }
        
        .day-cell:hover {
            background: #f3f4f6;
        }
        
        .day-cell.selected {
            background: #dbeafe;
            outline: 2px solid #3b82f6;
            outline-offset: -2px;
        }
        
        .job-count {
            font-weight: 600;
            color: #1f2937;
        }
        
        .hours-info {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }
        
        .hours-info.over-capacity {
            color: #dc2626;
            font-weight: 600;
        }
        
        .hotel-info {
            font-size: 0.7rem;
            color: #f59e0b;
            margin-top: 2px;
            font-weight: 500;
        }
        .unavailable {
            background: #f3f4f6;
            color: #9ca3af;
            font-style: italic;
        }
         /* Exploding head animation */
        .exploding-head {
            display: inline-block;
            font-size: 16px;
            animation: explode 0.8s ease-in-out infinite;
        }

        @keyframes explode {
            0% { 
                transform: scale(0.8) rotate(-5deg); 
                opacity: 0.7; 
            }
            50% { 
                transform: scale(1.3) rotate(5deg); 
                opacity: 1; 
                filter: brightness(1.5);
            }
            100% { 
                transform: scale(0.8) rotate(-5deg); 
                opacity: 0.7; 
            }
        }

        /* Success checkmark pulse */
        .success-check {
            display: inline-block;
            animation: successPulse 0.5s ease-out;
        }

        @keyframes successPulse {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }
        /* FILTER BAR */
        .filter-bar {
            background: white;
            padding: 0.75rem 1.5rem;
            margin: 0 1rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .filter-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
        }
        
        .date-input {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        
        .job-count-badge {
            background: #ef4444;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
            margin-left: auto;
        }
        
        /* MAP CONTAINER */
        .map-container {
            flex: 1;
            margin: 1rem;
            margin-top: 0.5rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
            min-height: 300px;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        /* MAP POPUP */
        .job-popup {
            min-width: 200px;
        }
        
        .job-popup h4 {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .job-popup-info {
            font-size: 0.75rem;
            color: #6b7280;
            margin-bottom: 0.75rem;
        }
        
        .assign-form {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .assign-form select {
            padding: 0.375rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        
        .assign-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .assign-btn:hover {
            background: #059669;
        }
        
        /* LOADING */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            color: #6b7280;
        }
    </style>
</head>
    <!-- Your existing head content -->
    
    <!-- Add Flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<body>
    <div style="background: white; padding: 15px 30px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center;">
        <h2 style="margin: 0; color: #1f2937; font-size: 24px;">üóìÔ∏è SchedulerGPT</h2>
        <div style="display: flex; gap: 10px;">
            <a href="/schedule-review-dashboard" style="padding: 8px 16px; background: #3b82f6; color: white; text-decoration: none; border-radius: 6px; font-size: 14px;">üìÖ Dashboard</a>
            <a href="/analysis" style="padding: 8px 16px; background: #10b981; color: white; text-decoration: none; border-radius: 6px; font-size: 14px;">üìä Analysis</a>
            <a href="/tech-manager" style="padding: 8px 16px; background: #f59e0b; color: white; text-decoration: none; border-radius: 6px; font-size: 14px;">üë∑ Technicians</a>
            <a href="/ai-scheduler" class="btn btn-primary">ü§ñ AI Scheduler</a>
            <a href="/data-manager" style="padding: 8px 16px; background: #6b7280; color: white; text-decoration: none; border-radius: 6px; font-size: 14px;">üìÅ Data</a>
        </div>
    </div>
    <!-- HEADER -->
    <header class="header">
        <h1>üìä Schedule Review Dashboard</h1>
        <button onclick="toggleOptimization()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
            üîß Optimize
        </button>
        <button class="btn btn-success" onclick="exportScheduleCSV()">Export Schedule CSV</button>
        <div class="week-nav">
            <button onclick="changeWeek(-1)">‚Üê</button>
            <span id="week-display">Loading...</span>
            <button onclick="changeWeek(1)">‚Üí</button>
            <button id="jump-to-date" style="margin-left: 10px; padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                üìÖ Jump to Date
            </button>
        </div>

    </header>
    
        <!-- MAIN CONTAINER -->
    <div class="main-container">
        <!-- SCHEDULE GRID FIRST -->
        <div class="schedule-container">
            <table class="schedule-grid" id="schedule-grid">
                <thead>
                    <tr>
                        <th class="tech-column">Technician</th>
                        <th>Monday<br><span id="date-mon" class="date-label"></span></th>
                        <th>Tuesday<br><span id="date-tue" class="date-label"></span></th>
                        <th>Wednesday<br><span id="date-wed" class="date-label"></span></th>
                        <th>Thursday<br><span id="date-thu" class="date-label"></span></th>
                        <th>Friday<br><span id="date-fri" class="date-label"></span></th>
                    </tr>
                </thead>
                <tbody id="grid-body">
                    <tr>
                        <td colspan="6" class="loading">Loading schedule...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- DETAIL PANEL SECOND (BELOW CALENDAR) -->
        <div class="detail-panel empty" id="detail-panel">
            <div>Click any job cell to view and edit details</div>
        </div>
        
        <!-- FILTER BAR -->
        <div class="filter-bar">
            <span class="filter-label">Unscheduled Jobs Due Between:</span>
            <input type="date" id="filter-start" class="date-input">
            <span>and</span>
            <input type="date" id="filter-end" class="date-input">
            <span class="job-count-badge" id="unscheduled-count">0 jobs</span>
            <label style="margin-left: auto;">
                <input type="checkbox" id="show-unscheduled" checked> 
                Show unscheduled jobs
            </label>
        </div>
        <!-- OPTIMIZATION PANEL -->
        <div class="optimization-panel" id="optimization-panel" style="margin: 1rem; display: none;">
            <div style="background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="font-weight: 600;">üîß Schedule Optimization</h3>
                    <button onclick="toggleOptimization()" style="padding: 0.25rem 0.5rem; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer;">Close</button>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem;">
                    <!-- Urgent Job Input -->
                    <div style="border-right: 1px solid #e5e7eb; padding-right: 1rem;">
                        <h4 style="margin-bottom: 0.5rem; font-size: 0.875rem;">Add Urgent Job</h4>
                        
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <input type="text" id="urgent-site" placeholder="Site Name" style="padding: 0.375rem; border: 1px solid #d1d5db; border-radius: 4px;">
                            <input type="text" id="urgent-city" placeholder="City" style="padding: 0.375rem; border: 1px solid #d1d5db; border-radius: 4px;">
                            <select id="urgent-state" style="padding: 0.375rem; border: 1px solid #d1d5db; border-radius: 4px;">
                                <option value="CO">CO</option>
                                <option value="WY">WY</option>
                                <option value="UT">UT</option>
                                <option value="NE">NE</option>
                                <option value="KS">KS</option>
                            </select>
                            <input type="number" id="urgent-duration" placeholder="Duration (hours)" step="0.5" value="2" style="padding: 0.375rem; border: 1px solid #d1d5db; border-radius: 4px;">
                            <select id="urgent-quals" style="padding: 0.375rem; border: 1px solid #d1d5db; border-radius: 4px;">
                                <option value="">Basic - No special quals</option>
                                <option value="PDT">PDT</option>
                                <option value="PVCT">PVCT</option>
                                <option value="VLT">VLT</option>
                                <option value="SCT">SCT</option>
                                <option value="NT">NT</option>
                                <option value="LDT">LDT</option>
                                <option value="CPS">CPS</option>
                                <option value="ACI">ACI</option>
                                <option value="ATG">ATG</option>
                                <option value="DWP">DWP</option>
                                <option value="MOI">MOI</option>
                                <option value="OFV">OFV</option>
                                <option value="SBT">SBT</option>
                                <option value="SVT">SVT</option>
                                <option value="Tracer">Tracer</option>
                                <option value="TT">TT</option>
                            </select>
                            <input type="date" id="urgent-date" style="padding: 0.375rem; border: 1px solid #d1d5db; border-radius: 4px;">
                            <button onclick="findUrgentOptions()" style="padding: 0.5rem; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer;">Find Options</button>
                        </div>
                    </div>
                    
                    <!-- Options Display -->
                    <div>
                        <h4 style="margin-bottom: 0.5rem; font-size: 0.875rem;">Scheduling Options</h4>
                        <div id="optimization-results" style="max-height: 300px; overflow-y: auto;">
                            <p style="color: #6b7280;">Enter urgent job details to see options...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Route Optimization Check -->
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                    <button onclick="analyzeCurrentRoutes()" style="padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">Analyze Current Week Routes</button>
                    <div id="route-analysis" style="margin-top: 1rem;"></div>
                </div>
            </div>
        </div>
        <!-- MAP -->
        <div class="map-container">
            <div id="map"></div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // ============================================================================
        // GLOBAL STATE
        // ============================================================================
        
        const API_KEY = 'devkey123'; // Update this if needed
        
        let currentWeek = null;
        let technicians = [];
        let scheduledJobs = [];
        let unscheduledJobs = [];
        let selectedCell = null;
        let map = null;
        let jobMarkers = [];
        let techRouteGroups = {};
        
        // Tech colors for map
        const techColors = [
            '#3b82f6', // blue
            '#10b981', // green
            '#f59e0b', // amber
            '#8b5cf6', // purple
            '#ec4899', // pink
            '#14b8a6', // teal
            '#f97316', // orange
            '#6366f1', // indigo
            '#84cc16', // lime
            '#06b6d4', // cyan
            '#a855f7'  // purple
        ];
        
        // ============================================================================
        // INITIALIZATION
        // ============================================================================
        
        document.addEventListener('DOMContentLoaded', async () => {
            initializeWeek();
            initializeMap();
            setDateFilterDefaults();
            await loadData();
            setupEventHandlers();
        });
        
        function initializeWeek() {
            const today = new Date();
            const monday = new Date(today);
            monday.setDate(today.getDate() - today.getDay() + 1);
            currentWeek = monday;
            updateWeekDisplay();
        }
        
        function initializeMap() {
            map = L.map('map').setView([40.5, -105.0], 7); // Colorado center
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
        }
        
        function setDateFilterDefaults() {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            
            document.getElementById('filter-start').value = firstDay.toISOString().split('T')[0];
            document.getElementById('filter-end').value = lastDay.toISOString().split('T')[0];
        }
        
        // ============================================================================
        // DATA LOADING
        // ============================================================================
        
        async function loadData() {
            try {
                // Load technicians
                const techResponse = await fetch('/api/technicians/all', {
                    headers: { 'X-API-Key': API_KEY }
                });
                const techData = await techResponse.json();
                technicians = techData.technicians || [];
                
                // Normalize tech IDs
                technicians = technicians.map((tech, index) => ({
                    ...tech,
                    id: tech.technician_id || tech.id,
                    color: techColors[index % techColors.length]
                }));
                
                // Load schedule
                await loadWeekSchedule();
                
                // Load unscheduled jobs
                await loadUnscheduledJobs();
                
            } catch (error) {
                console.error('Error loading data:', error);
                alert('Failed to load schedule data. Check console for details.');
            }
        }
        
        async function loadWeekSchedule() {
            const weekStart = currentWeek.toISOString().split('T')[0];
            
            const response = await fetch(`/api/schedule/week-all?week_start=${weekStart}`, {
                headers: { 'X-API-Key': API_KEY }
            });
            
            const data = await response.json();
            scheduledJobs = data.scheduled_jobs || [];
            
            console.log(`Loaded ${scheduledJobs.length} scheduled jobs for week of ${weekStart}`);
            
            renderScheduleGrid();
            updateMapMarkers();
        }

        async function loadUnscheduledJobs() {
            const startDate = document.getElementById('filter-start').value;
            const endDate = document.getElementById('filter-end').value;
            
            const badge = document.getElementById('unscheduled-count');
            
            // EXPLODING HEAD LOADING ü§Ø
            badge.innerHTML = '<span class="exploding-head">ü§Ø</span> Loading...';
            badge.style.background = '#f59e0b';
            
            try {
                // ‚Üê CHANGED: Pass dates to API instead of filtering in browser
                const url = `/api/jobs/unscheduled?start_date=${startDate}&end_date=${endDate}`;
                console.log('üîç Calling API with URL:', url);  // Debug line
                const response = await fetch(url, {
                    headers: { 'X-API-Key': API_KEY }
                });
                
                const data = await response.json();
                unscheduledJobs = data.jobs || [];  // ‚Üê No more filtering needed!
                
                // SUCCESS ‚úÖ
                badge.innerHTML = '<span class="success-check">‚úÖ</span> Loaded!';
                badge.style.background = '#10b981';
                
                updateMapMarkers();
                
                setTimeout(() => {
                    badge.textContent = `${unscheduledJobs.length} jobs`;
                    badge.style.background = '#dc2626';
                }, 800);
                
            } catch (error) {
                console.error('Failed to load unscheduled jobs:', error);
                badge.innerHTML = '<span class="exploding-head">üí•</span> Error!';
                badge.style.background = '#ef4444';
            }
        }
        
        // ============================================================================
        // RENDERING
        // ============================================================================
        
        function renderScheduleGrid() {
            const tbody = document.getElementById('grid-body');
            tbody.innerHTML = '';
            
            // Update date headers
            const days = ['mon', 'tue', 'wed', 'thu', 'fri'];
            days.forEach((day, index) => {
                const date = new Date(currentWeek);
                date.setDate(date.getDate() + index);
                document.getElementById(`date-${day}`).textContent = 
                    date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            
            // Group jobs by tech and day
            const jobsByTechDay = {};
            scheduledJobs.forEach(job => {
                const key = `${job.technician_id}-${getDayKey(job.date)}`;
                if (!jobsByTechDay[key]) {
                    jobsByTechDay[key] = [];
                }
                jobsByTechDay[key].push(job);
            });
            
            // Render tech rows
            technicians.forEach(tech => {
                if (!tech.active) return;
                
                const row = document.createElement('tr');
                
                // Tech column
                const techCell = document.createElement('td');
                techCell.className = 'tech-column';
                techCell.innerHTML = `
                    <div class="tech-info">
                        <input type="checkbox" 
                               class="tech-checkbox" 
                               id="tech-check-${tech.id}"
                               onchange="toggleTechRoute(${tech.id})">
                        <label for="tech-check-${tech.id}">${tech.name}</label>
                    </div>
                `;
                row.appendChild(techCell);
                
                // Day cells
                days.forEach((day, index) => {
                    const jobs = jobsByTechDay[`${tech.id}-${day}`] || [];
                    const cell = document.createElement('td');
                    cell.className = 'day-cell';
                    cell.dataset.techId = tech.id;
                    cell.dataset.day = day;
                    
                    if (jobs.length > 0) {
                        const totalWork = jobs.reduce((sum, job) => sum + (job.duration || 0), 0);
                        const totalDrive = jobs.reduce((sum, job) => sum + (job.drive_time || 0), 0);
                        const initialDrive = jobs.reduce((sum, job) => sum + (job.initial_drive_hours || 0), 0);
                        const hasHotel = jobs.some(job => job.needs_hotel);
                        const hotelLocation = jobs.find(job => job.hotel_location)?.hotel_location;
                        
                        cell.innerHTML = `
                            <div class="job-count">
                                ${jobs.length} job${jobs.length > 1 ? 's' : ''}
                                ${hasHotel ? ' üè®' : ''}
                            </div>
                            <div class="hours-info ${totalWork + totalDrive + initialDrive > 10 ? 'over-capacity' : ''}">
                                ${initialDrive > 0 ? `${initialDrive.toFixed(1)}h start + ` : ''}${totalWork.toFixed(1)}h work${totalDrive > 0 ? ` + ${totalDrive.toFixed(1)}h drive` : ''}
                            </div>
                            ${hasHotel ? `<div style="font-size: 0.7rem; color: #f59e0b; margin-top: 2px;">Hotel: ${hotelLocation}</div>` : ''}
                        `;
                        
                        cell.onclick = () => showDayDetails(tech, day, jobs);
                    } else {
                        cell.innerHTML = '<div style="color: #d1d5db;">-</div>';
                    }
                    
                    row.appendChild(cell);
                });
                
                tbody.appendChild(row);
            });
        }
        
        function showDayDetails(tech, day, jobs) {
            // Remove previous selection
            document.querySelectorAll('.day-cell').forEach(cell => {
                cell.classList.remove('selected');
            });
            
            // Mark selected
            const cell = document.querySelector(`[data-tech-id="${tech.id}"][data-day="${day}"]`);
            if (cell) cell.classList.add('selected');
            
            // Update detail panel
            const panel = document.getElementById('detail-panel');
            panel.classList.remove('empty');
            panel.classList.add('active');
            
            const date = new Date(currentWeek);
            date.setDate(date.getDate() + ['mon', 'tue', 'wed', 'thu', 'fri'].indexOf(day));
            
            // Get available techs and days for move dropdown
            const availableTechs = technicians.filter(t => t.active);
            const weekDays = getWeekDays();
            
            panel.innerHTML = `
                <div class="detail-content">
                    <div class="detail-header">
                        <h3>${tech.name} - ${date.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' })}</h3>
                        <button class="close-btn" onclick="closeDetails()">√ó</button>
                    </div>
                    <table class="jobs-table">
                        <thead>
                            <tr>
                                <th>WO</th>
                                <th>Site</th>
                                <th>Location</th>
                                <th>SOW</th>
                                <th>Hours</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${jobs.map(job => `
                                <tr id="job-row-${job.work_order}">
                                    <td>${job.work_order}</td>
                                    <td>${job.site_name || ''}</td>
                                    <td>${job.site_city || ''}, ${job.site_state || ''}</td>
                                    <td>${job.sow_1 || 'N/A'}</td>
                                    <td>${job.duration || 0}h</td>
                                    <td class="job-actions">
                                        <div id="action-buttons-${job.work_order}">
                                            <button onclick="showMoveForm(${job.work_order})">Move</button>
                                            <button onclick="removeJob(${job.work_order})">Remove</button>
                                        </div>
                                        <div id="move-form-${job.work_order}" style="display: none;">
                                            <select id="move-tech-${job.work_order}" style="font-size: 0.75rem; padding: 0.25rem;">
                                                <option value="">Select Tech...</option>
                                                ${availableTechs.map(t => 
                                                    `<option value="${t.id}" ${t.id === tech.id ? 'selected' : ''}>${t.name}</option>`
                                                ).join('')}
                                            <Select>
                                            <input type="date" id="move-day-${job.work_order}" value="${date.toISOString().split('T')[0]}" style="font-size: 0.75rem; padding: 0.25rem;">
                                            <button onclick="confirmMove(${job.work_order})" style="background: #10b981;">‚úì</button>
                                            <button onclick="cancelMove(${job.work_order})" style="background: #ef4444;">‚úó</button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function closeDetails() {
            const panel = document.getElementById('detail-panel');
            panel.classList.remove('active');
            panel.classList.add('empty');
            panel.innerHTML = '<div>Click any job cell to view and edit details</div>';
            
            document.querySelectorAll('.day-cell').forEach(cell => {
                cell.classList.remove('selected');
            });
        }
                function showMoveForm(workOrder) {
            // Hide action buttons, show move form
            document.getElementById(`action-buttons-${workOrder}`).style.display = 'none';
            document.getElementById(`move-form-${workOrder}`).style.display = 'flex';
        }

        function cancelMove(workOrder) {
            // Hide move form, show action buttons
            document.getElementById(`move-form-${workOrder}`).style.display = 'none';
            document.getElementById(`action-buttons-${workOrder}`).style.display = 'block';
        }

        async function confirmMove(workOrder) {
            const techSelect = document.getElementById(`move-tech-${workOrder}`);
            const daySelect = document.getElementById(`move-day-${workOrder}`);
            
            const newTechId = parseInt(techSelect.value);
            const newDate = daySelect.value;
            
            if (!newTechId || !newDate) {
                alert('Please select both technician and day');
                return;
            }
            
            try {
                // First remove from current schedule
                const removeResponse = await fetch(`/api/schedule/remove/${workOrder}`, {
                    method: 'DELETE',
                    headers: { 'X-API-Key': API_KEY }
                });
                
                if (!removeResponse.ok) {
                    throw new Error('Failed to remove job from current schedule');
                }
                
                // Then assign to new tech/day
                const assignResponse = await fetch('/api/schedule/assign', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': API_KEY
                    },
                    body: JSON.stringify({
                        work_order: workOrder,
                        technician_id: newTechId,
                        date: newDate
                    })
                });
                
                const result = await assignResponse.json();
                
                if (result.success) {
                    await loadWeekSchedule();
                    closeDetails();
                    alert('Job moved successfully');
                } else {
                    throw new Error(result.errors ? result.errors[0] : 'Failed to assign job');
                }
            } catch (error) {
                console.error('Error moving job:', error);
                alert('Error moving job: ' + error.message);
            }
        }


        // ============================================================================
        // MAP FUNCTIONS
        // ============================================================================
        // Simple city/state to approximate coordinates (for testing)
        const cityCoordinates = {
            'Denver, CO': [39.7392, -104.9903],
            'Aurora, CO': [39.7294, -104.8319],
            'Lakewood, CO': [39.7047, -105.0814],
            'Fort Collins, CO': [40.5853, -105.0844],
            'Colorado Springs, CO': [38.8339, -104.8214],
            'Cheyenne, WY': [41.1400, -104.8202],
            'Casper, WY': [42.8501, -106.3252],
            'Salt Lake City, UT': [40.7608, -111.8910],
            'Lincoln, NE': [40.8136, -96.7026],
            'Phoenix, AZ': [33.4484, -112.0740],
            'Boise, ID': [43.6150, -116.2023]
        };

        function getJobCoordinates(job) {
            // Try standard coordinate fields first (your actual field names)
            if (job.latitude && job.longitude) {
                return [job.latitude, job.longitude];
            }
            
            // Try other possible field names
            if (job.site_latitude && job.site_longitude) {
                return [job.site_latitude, job.site_longitude];
            }
            
            if (job.lat && job.lng) {
                return [job.lat, job.lng];
            }
            
            if (job.site_lat && job.site_lng) {
                return [job.site_lat, job.site_lng];
            }
            
            // Fallback to city lookup
            if (job.site_city && job.site_state) {
                const cityKey = `${job.site_city}, ${job.site_state}`;
                const coords = cityCoordinates[cityKey];
                if (coords) {
                    // Add small random offset to prevent overlapping
                    return [
                        coords[0] + (Math.random() - 0.5) * 0.1,
                        coords[1] + (Math.random() - 0.5) * 0.1
                    ];
                }
            }
            
            return null;
        }
        function updateMapMarkers() {
            console.log('=== Updating Map Markers ===');
            console.log(`Unscheduled jobs: ${unscheduledJobs.length}`);
            
            // Clear existing markers
            jobMarkers.forEach(marker => map.removeLayer(marker));
            jobMarkers = [];
            
            // Clear tech routes
            Object.values(techRouteGroups).forEach(group => map.removeLayer(group));
            techRouteGroups = {};
            
            // Check for coordinate fields
            let jobsWithCoords = 0;
            let jobsWithoutCoords = 0;
            
            document.getElementById('show-unscheduled').addEventListener('change', (e) => {
                if (e.target.checked) {
                    jobMarkers.forEach(marker => marker.addTo(map));
                } else {
                    jobMarkers.forEach(marker => map.removeLayer(marker));
                }
            });

            // Add unscheduled job markers
            unscheduledJobs.forEach(job => {
                const coords = getJobCoordinates(job);
                if (coords) {
                    jobsWithCoords++;
                    const marker = L.marker(coords, {
                        icon: L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div style="background-color: #ef4444; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white;"></div>`,
                            iconSize: [16, 16],
                            iconAnchor: [8, 8]
                        })
                    });
                    
                    marker.bindPopup(createJobPopup(job));
                    marker.addTo(map);
                    jobMarkers.push(marker);
                } else {
                    jobsWithoutCoords++;
                    // Log first few jobs without coords to see field names
                    if (jobsWithoutCoords <= 3) {
                        console.log('Job without coords:', {
                            work_order: job.work_order,
                            site_city: job.site_city,
                            site_state: job.site_state,
                            available_fields: Object.keys(job).filter(k => k.includes('lat') || k.includes('lng') || k.includes('lon'))
                        });
                    }
                }
            });
            
            console.log(`Unscheduled jobs with coordinates: ${jobsWithCoords}`);
            console.log(`Unscheduled jobs without coordinates: ${jobsWithoutCoords}`);
            
            // Add scheduled job markers by tech (if checkbox checked)
            technicians.forEach(tech => {
                const checkbox = document.getElementById(`tech-check-${tech.id}`);
                if (checkbox && checkbox.checked) {
                    showTechRoute(tech);
                }
            });
        }
        
        function toggleTechRoute(techId) {
            const tech = technicians.find(t => t.id === techId);
            if (!tech) return;
            
            const checkbox = document.getElementById(`tech-check-${techId}`);
            if (checkbox.checked) {
                showTechRoute(tech);
            } else {
                hideTechRoute(tech);
            }
        }
        
        function showTechRoute(tech) {
            console.log(`=== Showing route for ${tech.name} ===`);
            const techJobs = scheduledJobs.filter(job => job.technician_id === tech.id);
            console.log(`Found ${techJobs.length} jobs for tech ${tech.id}`);
            
            const markers = [];
            let jobsWithCoords = 0;
            let jobsWithoutCoords = 0;
            
            techJobs.forEach(job => {
                const coords = getJobCoordinates(job);
                if (coords) {
                    jobsWithCoords++;
                    const marker = L.marker(coords, {
                        icon: L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div style="background-color: ${tech.color}; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white;"></div>`,
                            iconSize: [16, 16],
                            iconAnchor: [8, 8]
                        })
                    });
                    
                    marker.bindPopup(`
                        <div class="job-popup">
                            <h4>WO ${job.work_order}</h4>
                            <div class="job-popup-info">
                                ${job.site_name}<br>
                                ${job.site_city}, ${job.site_state}<br>
                                Assigned to: ${tech.name}<br>
                                Date: ${new Date(job.date).toLocaleDateString()}
                            </div>
                        </div>
                    `);
                    
                    markers.push(marker);
                } else {
                    jobsWithoutCoords++;
                    // Log first job without coords
                    if (jobsWithoutCoords === 1) {
                        console.log('Scheduled job fields:', Object.keys(job));
                        console.log('Sample scheduled job:', {
                            work_order: job.work_order,
                            site_name: job.site_name,
                            site_city: job.site_city,
                            site_state: job.site_state
                        });
                    }
                }
            });
            
            console.log(`Scheduled jobs with coordinates: ${jobsWithCoords}`);
            console.log(`Scheduled jobs without coordinates: ${jobsWithoutCoords}`);
            
            if (markers.length > 0) {
                techRouteGroups[tech.id] = L.layerGroup(markers);
                techRouteGroups[tech.id].addTo(map);
                console.log(`Added ${markers.length} markers to map for ${tech.name}`);
            }
        }
        
        function hideTechRoute(tech) {
            if (techRouteGroups[tech.id]) {
                map.removeLayer(techRouteGroups[tech.id]);
                delete techRouteGroups[tech.id];
            }
        }
        
        function createJobPopup(job) {
            const availableTechs = technicians.filter(t => t.active);
            const weekDays = getWeekDays();
            
            return `
                <div class="job-popup">
                    <h4>WO ${job.work_order}</h4>
                    <div class="job-popup-info">
                        ${job.site_name || 'No site name'}<br>
                        ${job.site_city || ''}, ${job.site_state || ''}<br>
                        Due: ${job.due_date ? new Date(job.due_date).toLocaleDateString() : 'No due date'}<br>
                        Est: ${job.est_hours || 0} hours
                    </div>
                    <div class="assign-form">
                        <select id="popup-tech-${job.work_order}">
                            <option value="">Select Tech...</option>
                            ${availableTechs.map(tech => 
                                `<option value="${tech.id}">${tech.name}</option>`
                            ).join('')}
                        </select>
                        <input type="date" id="popup-day-${job.work_order}" style="padding: 0.375rem; border: 1px solid #d1d5db; border-radius: 4px;">
                        <button class="assign-btn" onclick="assignJobFromMap(${job.work_order})">
                            Assign Job
                        </button>
                    </div>
                </div>
            `;
        }
        
        // ============================================================================
        // ACTIONS
        // ============================================================================
        
        async function assignJobFromMap(workOrder) {
            const techSelect = document.getElementById(`popup-tech-${workOrder}`);
            const daySelect = document.getElementById(`popup-day-${workOrder}`);
            
            const techId = parseInt(techSelect.value);
            const date = daySelect.value;
            
            if (!techId || !date) {
                alert('Please select both technician and day');
                return;
            }
            
            try {
                const response = await fetch('/api/schedule/assign', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': API_KEY
                    },
                    body: JSON.stringify({
                        work_order: workOrder,
                        technician_id: techId,
                        date: date
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Close popup
                    map.closePopup();
                    
                    // Reload data
                    await loadWeekSchedule();
                    await loadUnscheduledJobs();
                    
                    alert('Job assigned successfully');
                } else {
                    alert('Failed to assign job: ' + (result.errors ? result.errors[0] : 'Unknown error'));
                }
            } catch (error) {
                console.error('Error assigning job:', error);
                alert('Error assigning job. Check console for details.');
            }
        }
        
        async function moveJob(workOrder) {
            const newDate = prompt('Enter new date (YYYY-MM-DD):');
            if (!newDate) return;
            
            // Implementation for moving job
            alert('Move job feature coming soon');
        }
        
        async function removeJob(workOrder) {
            if (!confirm('Remove this job from the schedule?')) return;
            
            try {
                const response = await fetch(`/api/schedule/remove/${workOrder}`, {
                    method: 'DELETE',
                    headers: { 'X-API-Key': API_KEY }
                });
                
                if (response.ok) {
                    await loadWeekSchedule();
                    closeDetails();
                    alert('Job removed from schedule');
                }
            } catch (error) {
                console.error('Error removing job:', error);
                alert('Failed to remove job');
            }
        }

        // OPTIMIZATION FUNCTIONS
        function toggleOptimization() {
            const panel = document.getElementById('optimization-panel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        async function findUrgentOptions() {
            const site = document.getElementById('urgent-site').value;
            const city = document.getElementById('urgent-city').value;
            const state = document.getElementById('urgent-state').value;
            const duration = parseFloat(document.getElementById('urgent-duration').value);
            const quals = document.getElementById('urgent-quals').value;
            const date = document.getElementById('urgent-date').value;
            
            if (!site || !city || !date) {
                alert('Please fill in all required fields');
                return;
            }
            
            // Find qualified techs
            let qualifiedTechs = technicians.filter(tech => {
                if (!tech.active) return false;
                if (quals && !tech.qualified_tests?.includes(quals)) return false;
                return true;
            });
            
            const results = document.getElementById('optimization-results');
            results.innerHTML = '<p>Analyzing schedule...</p>';
            
            // Check each tech's schedule
            let options = [];
            
            for (let tech of qualifiedTechs) {
                // Get tech's jobs for that day
                const techJobs = scheduledJobs.filter(j => 
                    j.technician_id === tech.technician_id && 
                    j.date === date
                );
                
                // Calculate current hours
                const currentHours = techJobs.reduce((sum, j) => sum + (j.duration || 2), 0);
                
                if (currentHours + duration <= 10) { // Daily max
                    // Check if jobs can be moved
                    const moveableJobs = techJobs.filter(j => !j.is_recurring_site);
                    
                    options.push({
                        tech_id: tech.technician_id,
                        tech_name: tech.name,
                        current_jobs: techJobs.length,
                        current_hours: currentHours,
                        available_hours: 10 - currentHours,
                        moveable_jobs: moveableJobs.length,
                        impact: techJobs.length > 0 ? 'Medium' : 'Low'
                    });
                }
            }
            
            // Sort by impact
            options.sort((a, b) => a.current_jobs - b.current_jobs);
            
            // Display top 5
            if (options.length === 0) {
                results.innerHTML = '<p style="color: #ef4444;">No qualified technicians available</p>';
            } else {
                results.innerHTML = options.slice(0, 5).map((opt, i) => `
                    <div style="padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 4px; margin-bottom: 0.5rem;">
                        <div style="display: flex; justify-content: space-between;">
                            <strong>Option ${i+1}: ${opt.tech_name}</strong>
                            <span style="color: ${opt.impact === 'Low' ? '#10b981' : '#f59e0b'};">${opt.impact} Impact</span>
                        </div>
                        <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
                            Current: ${opt.current_jobs} jobs, ${opt.current_hours} hrs
                            | Available: ${opt.available_hours} hrs
                            ${opt.moveable_jobs > 0 ? `| ${opt.moveable_jobs} jobs can be moved` : ''}
                        </div>
                        <button onclick="applyUrgentJob(${opt.tech_id}, '${date}')" 
                                style="margin-top: 0.5rem; padding: 0.25rem 0.5rem; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                            Apply
                        </button>
                    </div>
                `).join('');
            }
        }

        async function analyzeCurrentRoutes() {
            const results = document.getElementById('route-analysis');
            results.innerHTML = '<p>Analyzing routes...</p>';
            
            // Group jobs by date and region
            let analysis = [];
            
            const dates = [...new Set(scheduledJobs.map(j => j.date))].sort();
            
            for (let date of dates) {
                const dayJobs = scheduledJobs.filter(j => j.date === date);
                
                // Check for techs in same area
                const techsByCity = {};
                dayJobs.forEach(job => {
                    const key = `${job.site_city}-${job.site_state}`;
                    if (!techsByCity[key]) techsByCity[key] = new Set();
                    techsByCity[key].add(job.technician_id);
                });
                
                // Find overlaps
                const overlaps = Object.entries(techsByCity)
                    .filter(([city, techs]) => techs.size > 1)
                    .map(([city, techs]) => ({
                        city,
                        techs: Array.from(techs),
                        potential_swap: true
                    }));
                
                if (overlaps.length > 0) {
                    analysis.push({ date, overlaps });
                }
            }
            
            if (analysis.length === 0) {
                results.innerHTML = '<p style="color: #10b981;">‚úì Routes look optimized!</p>';
            } else {
                results.innerHTML = '<div style="color: #f59e0b;">‚ö†Ô∏è Potential optimizations found:</div>' +
                    analysis.map(a => `
                        <div style="margin-top: 0.5rem; padding: 0.5rem; background: #fef3c7; border-radius: 4px;">
                            <strong>${a.date}:</strong> Multiple techs in same area<br>
                            ${a.overlaps.map(o => `${o.city}: Techs ${o.techs.join(', ')}`).join('<br>')}
                        </div>
                    `).join('');
            }
        }

        function applyUrgentJob(techId, date) {
            // This would call your API to actually schedule the job
            alert(`Would schedule job with Tech ${techId} on ${date}`);
            // Add actual API call here
        }
        
        // ============================================================================
        // UTILITIES
        // ============================================================================
        
        function updateWeekDisplay() {
            const endDate = new Date(currentWeek);
            endDate.setDate(endDate.getDate() + 4);
            
            const display = `Week ${getWeekNumber(currentWeek)} - ${
                currentWeek.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
            } to ${
                endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
            }`;
            
            document.getElementById('week-display').textContent = display;
        }
        
        function getWeekNumber(date) {
            const firstJan = new Date(date.getFullYear(), 0, 1);
            const days = Math.floor((date - firstJan) / (24 * 60 * 60 * 1000));
            return Math.ceil((days + firstJan.getDay() + 1) / 7);
        }
        
        function getDayKey(dateStr) {
            const date = new Date(dateStr + 'T12:00:00'); // Add noon time to avoid timezone issues
            const dayIndex = date.getDay();
            const days = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
            return days[dayIndex];
        }
        
        function getWeekDays() {
            const days = [];
            for (let i = 0; i < 5; i++) {
                const date = new Date(currentWeek);
                date.setDate(date.getDate() + i);
                days.push({
                    date: date.toISOString().split('T')[0],
                    label: date.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' })
                });
            }
            return days;
        }
        
        async function changeWeek(direction) {
            currentWeek.setDate(currentWeek.getDate() + (direction * 7));
            updateWeekDisplay();
            closeDetails();
            await loadWeekSchedule();
        }
        
        function setupEventHandlers() {
            document.getElementById('filter-start').addEventListener('change', loadUnscheduledJobs);
            document.getElementById('filter-end').addEventListener('change', loadUnscheduledJobs);
        }
        function exportScheduleCSV() {
            const rows = [['WOID', 'UserID', 'IsPrimary', 'ScheduleDate']];
            
            // Assuming you have scheduled jobs data available
            scheduledJobs.forEach(job => {
                rows.push([
                    job.work_order,
                    job.technician_id,
                    '1',
                    job.date 
                ]);
            });
            
            const csvContent = rows.map(e => e.join(",")).join("\n");
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `schedule_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }
        // Initialize date picker for jumping to specific dates
        document.addEventListener('DOMContentLoaded', function() {
            flatpickr("#jump-to-date", {
                inline: false,
                dateFormat: "Y-m-d",
                onChange: function(selectedDates, dateStr, instance) {
                    if (selectedDates.length > 0) {
                        const selected = selectedDates[0];
                        // Jump to the Monday of the selected week
                        const monday = getMonday(selected);
                        currentWeek = monday;
                        updateWeekDisplay();
                        loadWeekSchedule();
                    }
                },
                onOpen: function(selectedDates, dateStr, instance) {
                    // Highlight current week in the calendar
                    if (currentWeek) {
                        instance.setDate(currentWeek, false);
                    }
                }
            });
        });

        // Helper function to get Monday of a week
        function getMonday(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // adjust when day is sunday
            return new Date(d.setDate(diff));
        }
    </script>
</body>
</html>