<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scheduler Helper</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
        }
        
        /* Header */
        .header {
            background: #1e3a5f;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            font-size: 20px;
        }
        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .header-controls input,
        .header-controls select {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
        }
        .header-controls button {
            padding: 8px 16px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .header-controls button:hover {
            background: #2563eb;
        }
        
        /* Main layout */
        .main-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 60px);
        }
        
        /* Calendar section */
        .calendar-section {
            flex: 0 0 auto;
            max-height: 45vh;
            overflow: auto;
            background: white;
            border-bottom: 2px solid #ddd;
        }
        .calendar-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .calendar-table th {
            background: #1e3a5f;
            color: white;
            padding: 8px 4px;
            border: 1px solid #ccc;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .calendar-table td {
            border: 1px solid #ddd;
            padding: 4px;
            vertical-align: top;
            min-width: 150px;
        }
        .calendar-table .tech-name {
            background: #e8f4fc;
            font-weight: bold;
            min-width: 120px;
            position: sticky;
            left: 0;
            z-index: 5;
        }
        .calendar-table .time-off {
            background: #fee2e2;
            color: #991b1b;
            text-align: center;
            font-style: italic;
        }
        
        /* Job cell */
        .day-cell {
            min-height: 60px;
            cursor: pointer;
        }
        .day-cell:hover {
            background: #f0f7ff;
        }
        .day-cell.selected {
            background: #dbeafe;
            outline: 2px solid #3b82f6;
        }
        .job-chip {
            background: #e0e7ff;
            border-left: 3px solid #3b82f6;
            padding: 2px 4px;
            margin: 2px 0;
            font-size: 11px;
            border-radius: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .job-chip.recurring {
            border-left-color: #f59e0b;
            background: #fef3c7;
        }
        .job-chip.urgent {
            border-left-color: #ef4444;
            background: #fee2e2;
        }
        .day-total {
            font-size: 10px;
            color: #666;
            margin-top: 4px;
            padding-top: 4px;
            border-top: 1px solid #eee;
        }
        
        /* Map section */
        .map-section {
            flex: 1;
            min-height: 300px;
        }
        #map {
            width: 100%;
            height: 100%;
        }
        
        /* Urgent jobs panel */
        .urgent-panel {
            position: fixed;
            right: 20px;
            top: 80px;
            width: 300px;
            max-height: 70vh;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
        }
        .urgent-panel.open {
            display: block;
        }
        .urgent-panel-header {
            background: #dc2626;
            color: white;
            padding: 10px 15px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .urgent-panel-content {
            max-height: calc(70vh - 50px);
            overflow-y: auto;
            padding: 10px;
        }
        .urgent-job {
            padding: 8px;
            border: 1px solid #eee;
            border-radius: 4px;
            margin-bottom: 8px;
            cursor: pointer;
        }
        .urgent-job:hover {
            background: #f9fafb;
        }
        .urgent-job .due-date {
            color: #dc2626;
            font-weight: bold;
            font-size: 11px;
        }
        .urgent-job .site-name {
            font-weight: 500;
        }
        .urgent-job .details {
            font-size: 11px;
            color: #666;
        }
        
        /* Toggle button */
        .urgent-toggle {
            position: fixed;
            right: 20px;
            top: 80px;
            background: #dc2626;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            z-index: 999;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .urgent-toggle:hover {
            background: #b91c1c;
        }
        .urgent-count {
            background: white;
            color: #dc2626;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 12px;
            margin-left: 8px;
        }
        
        /* Detail panel */
        .detail-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 2px solid #ddd;
            padding: 15px 20px;
            max-height: 320px;
            overflow-y: auto;
            display: none;
            z-index: 1001;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
        }
        .detail-panel.open {
            display: block;
        }
        .detail-panel h3 {
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .detail-panel .close-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }
        .detail-item {
            background: #f9fafb;
            padding: 8px;
            border-radius: 4px;
        }
        .detail-item label {
            font-size: 11px;
            color: #666;
            display: block;
        }
        .detail-item span {
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Scheduler Helper</h1>
        <div class="header-controls">
            <input type="week" id="week-select" />
            <button onclick="loadData()">Load Week</button>
            
            <!-- Date filter for unscheduled jobs -->
            <span style="margin-left: 15px; color: #ccc;">Jobs Due:</span>
            <input type="date" id="filter-start" style="width: 130px;" />
            <span style="color: #ccc;">to</span>
            <input type="date" id="filter-end" style="width: 130px;" />
            <button onclick="loadUnscheduledJobs()" style="background: #10b981;">Filter Jobs</button>
            <span id="unscheduled-count" style="background: #fbbf24; color: #78350f; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: bold;">0 jobs</span>
            
            <button onclick="exportScheduleCSV()" style="background: #22c55e; margin-left: 10px;">Export CSV</button>
            <button onclick="generateEmailPreview()" style="background: #3b82f6; margin-left: 5px;">Email Preview</button>
        </div>
    </div>
    
    <!-- Navigation Bar -->
    <div style="background: white; padding: 10px 20px; border-bottom: 1px solid #ddd; display: flex; gap: 10px;">
        <a href="/scheduler-helper" style="padding: 8px 16px; background: #1e3a5f; color: white; text-decoration: none; border-radius: 6px; font-size: 14px;">üìÖ Scheduler</a>
        <a href="/analysis" style="padding: 8px 16px; background: #10b981; color: white; text-decoration: none; border-radius: 6px; font-size: 14px;">üìä Analysis</a>
        <a href="/tech-manager" style="padding: 8px 16px; background: #f59e0b; color: white; text-decoration: none; border-radius: 6px; font-size: 14px;">üë∑ Technicians</a>
        <a href="/data-manager" style="padding: 8px 16px; background: #6b7280; color: white; text-decoration: none; border-radius: 6px; font-size: 14px;">üìÅ Data Manager</a>
    </div>
    
    <!-- Email Modal -->
    <div id="email-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; overflow: auto;">
        <div style="background: white; margin: 20px auto; max-width: 900px; padding: 20px; border-radius: 8px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 style="margin: 0;">Weekly Schedule - Individual Tech Emails</h2>
                <button onclick="closeEmailModal()" style="padding: 5px 15px; background: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer;">Close</button>
            </div>
            <p style="color: #666; margin-bottom: 15px;">Click "Copy" on each tech's schedule to copy it to clipboard, then paste into email.</p>
            <div id="email-table-container" style="max-height: 70vh; overflow-y: auto;"></div>
        </div>
    </div>
    
    <div class="main-container">
        <div class="calendar-section">
            <table class="calendar-table" id="calendar-table">
                <thead id="calendar-header"></thead>
                <tbody id="calendar-body"></tbody>
            </table>
        </div>
        
        <div class="map-section">
            <div id="map"></div>
        </div>
    </div>
    
    <!-- Urgent jobs toggle -->
    <div class="urgent-toggle" onclick="toggleUrgentPanel()">
        Urgent Jobs <span class="urgent-count" id="urgent-count">0</span>
    </div>
    
    <!-- Route Builder toggle -->
    <div class="route-toggle" onclick="toggleRouteBuilder()" style="position: fixed; right: 20px; top: 130px; background: #22c55e; color: white; padding: 10px 15px; border-radius: 8px; cursor: pointer; z-index: 999; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        Route Builder <span id="selected-jobs-badge" style="background: #f59e0b; padding: 2px 6px; border-radius: 10px; font-size: 11px; margin-left: 5px; display: none;">0</span>
    </div>
    
    <!-- Route Builder panel -->
    <div class="route-panel" id="route-panel" style="position: fixed; right: 20px; top: 180px; width: 380px; max-height: 80vh; background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 1000; display: none;">
        <div style="background: #22c55e; color: white; padding: 10px 15px; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center;">
            <span>Build Route</span>
            <span style="cursor: pointer;" onclick="toggleRouteBuilder()">√¢≈ì‚Ä¢</span>
        </div>
        <div style="padding: 15px; max-height: calc(80vh - 50px); overflow-y: auto;">
            <!-- Selected Jobs Section -->
            <div style="margin-bottom: 15px; padding: 10px; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 6px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <label style="font-weight: bold; color: #92400e;">Selected Jobs: <span id="selected-count">0</span></label>
                    <button onclick="clearSelectedJobs()" style="padding: 2px 8px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 10px;">Clear</button>
                </div>
                <div id="selected-jobs-list" style="max-height: 150px; overflow-y: auto; font-size: 11px;">
                    <p style="color: #666; font-style: italic; margin: 0;">Click jobs on map √¢‚Ä†‚Äô "+ Selected"</p>
                </div>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; font-weight: bold; margin-bottom: 5px;">Technician:</label>
                <select id="route-tech-select" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" onchange="loadRegionsForRouteTech()">
                    <option value="">Select tech...</option>
                </select>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; font-weight: bold; margin-bottom: 5px;">Regions (hold Ctrl/Cmd for multiple):</label>
                <select id="route-region-select" multiple style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; height: 120px;">
                    <option value="">Loading regions...</option>
                </select>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; font-weight: bold; margin-bottom: 5px;">Start Date:</label>
                <input type="date" id="route-start-date" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; font-weight: bold; margin-bottom: 5px;">Days to Schedule:</label>
                <select id="route-days" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="1">1 day</option>
                    <option value="2">2 days</option>
                    <option value="3">3 days</option>
                    <option value="4">4 days</option>
                    <option value="5" selected>5 days (full week)</option>
                </select>
            </div>
            
            <button onclick="buildRouteFromSelected()" style="width: 100%; padding: 10px; background: #f59e0b; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-bottom: 8px;">
                Build from Selected Jobs
            </button>
            
            <button onclick="buildRoute()" style="width: 100%; padding: 10px; background: #22c55e; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                Build Route (Region-based)
            </button>
            
            <button onclick="showHistoricalRoutes()" style="width: 100%; padding: 10px; background: #8b5cf6; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-top: 8px;">
                Show Historical Routes
            </button>
            
            <div id="route-results" style="margin-top: 15px;"></div>
            
            <div id="historical-results" style="margin-top: 15px; display: none;"></div>
        </div>
    </div>
    
    <!-- Urgent jobs panel -->
    <div class="urgent-panel" id="urgent-panel">
        <div class="urgent-panel-header">
            <span>Urgent Jobs (Due Soon)</span>
            <span style="cursor: pointer;" onclick="toggleUrgentPanel()">X</span>
        </div>
        <div class="urgent-panel-content" id="urgent-list"></div>
    </div>
    
    <!-- Detail panel -->
    <div class="detail-panel" id="detail-panel">
        <h3>
            <span id="detail-title">Select a day to see details</span>
            <button class="close-btn" onclick="closeDetailPanel()">Close</button>
        </h3>
        <div class="detail-grid" id="detail-content"></div>
    </div>

    <script>
        // Global state
        let technicians = [];
        let scheduledJobs = [];
        let unscheduledJobs = [];
        let additionalTechJobs = []; // Jobs where tech is secondary
        let techTimeOff = {};
        let currentWeek = null;
        let map = null;
        let markers = [];
        let selectedJob = null;
        
        // Tech colors - AVOID green (#22c55e), orange (#f97316), blue triangles for homes
        // These are for MAP markers to show tech routes - DISTINCTLY DIFFERENT colors
        const TECH_COLORS = [
            '#e63946', // red
            '#1d4ed8', // dark blue
            '#00ff7f', // fluorescent green
            '#000000', // black
            '#facc15', // dark yellow
            '#ffffff', // white
            '#14b8a6', // teal
            '#9333ea', // purple
            '#ff69b4', // hot pink
            '#00bfff', // light blue
            '#8b4513', // brown
            '#06b6d4', // cyan
        ];
        
        function getTechColor(techId) {
            const index = technicians.findIndex(t => t.technician_id === techId);
            return TECH_COLORS[index % TECH_COLORS.length] || '#6b7280';
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Set default week to 2026-W02
            document.getElementById('week-select').value = '2026-W02';
            
            // Set default date filters (current month)
            setDateFilterDefaults();
            
            initMap();
            loadData();
        });
        
        function setDateFilterDefaults() {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            
            document.getElementById('filter-start').value = firstDay.toISOString().split('T')[0];
            document.getElementById('filter-end').value = lastDay.toISOString().split('T')[0];
        }
        
        async function loadUnscheduledJobs() {
            const startDate = document.getElementById('filter-start').value;
            const endDate = document.getElementById('filter-end').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }
            
            try {
                const url = `/api/jobs/unscheduled?start_date=${startDate}&end_date=${endDate}`;
                const response = await fetch(url);
                const data = await response.json();
                unscheduledJobs = data.jobs || [];
                
                // Update count badge
                const badge = document.getElementById('unscheduled-count');
                badge.textContent = `${unscheduledJobs.length} jobs`;
                
                // Refresh map to show filtered jobs
                refreshMap();
                
                console.log(`Loaded ${unscheduledJobs.length} unscheduled jobs for ${startDate} to ${endDate}`);
            } catch (error) {
                console.error('Failed to load unscheduled jobs:', error);
                alert('Failed to load unscheduled jobs');
            }
        }
        
        function initMap() {
            map = L.map('map').setView([39.5, -105.0], 7);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '√Ç¬© OpenStreetMap'
            }).addTo(map);
        }
        
        async function loadData() {
            const weekInput = document.getElementById('week-select').value;
            if (!weekInput) {
                alert('Please select a week');
                return;
            }
            
            // Parse week to get Monday date
            const [year, weekNum] = weekInput.split('-W');
            currentWeek = getDateOfISOWeek(parseInt(weekNum), parseInt(year));
            const weekStart = currentWeek.toISOString().split('T')[0];
            const weekEnd = new Date(currentWeek);
            weekEnd.setDate(weekEnd.getDate() + 4);
            const weekEndStr = weekEnd.toISOString().split('T')[0];
            
            try {
                // Load technicians
                const techRes = await fetch('/api/technicians/all');
                const techData = await techRes.json();
                technicians = techData.technicians.filter(t => t.active);
                
                // Load scheduled jobs for the week
                const schedRes = await fetch(`/api/schedule/week-all?week_start=${weekStart}`);
                const schedData = await schedRes.json();
                scheduledJobs = schedData.scheduled_jobs || [];
                
                // Load unscheduled jobs WITH date filter
                const startDate = document.getElementById('filter-start').value;
                const endDate = document.getElementById('filter-end').value;
                let unschedUrl = '/api/jobs/unscheduled';
                if (startDate && endDate) {
                    unschedUrl += `?start_date=${startDate}&end_date=${endDate}`;
                }
                const unschedRes = await fetch(unschedUrl);
                const unschedData = await unschedRes.json();
                unscheduledJobs = unschedData.jobs || [];
                
                // Update count badge
                const badge = document.getElementById('unscheduled-count');
                if (badge) {
                    badge.textContent = `${unscheduledJobs.length} jobs`;
                }
                
                // Load additional tech jobs (where tech is secondary)
                try {
                    const addlRes = await fetch(`/api/schedule/additional-techs?week_start=${weekStart}`);
                    const addlData = await addlRes.json();
                    additionalTechJobs = addlData.additional_techs || [];
                } catch (e) {
                    console.log('No additional tech endpoint or error:', e);
                    additionalTechJobs = [];
                }
                
                // Load time off for all techs
                await loadTimeOffData(weekStart);
                
                renderCalendar();
                renderMap();
                renderUrgentJobs();
                
            } catch (error) {
                console.error('Error loading data:', error);
                alert('Error loading data: ' + error.message);
            }
        }
        
        async function loadTimeOffData(weekStart) {
            techTimeOff = {};
            
            const promises = technicians.map(async (tech) => {
                try {
                    const url = `/api/technicians/availability?tech_id=${tech.technician_id}&week_start=${weekStart}`;
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data.availability) {
                        data.availability.forEach(day => {
                            if (!day.available) {
                                const key = `${tech.technician_id}-${day.date}`;
                                techTimeOff[key] = {
                                    reason: day.reason || 'Time Off',
                                    hoursAvailable: day.hours_available
                                };
                            }
                        });
                    }
                } catch (error) {
                    console.error(`Failed to load time off for tech ${tech.technician_id}:`, error);
                }
            });
            
            await Promise.all(promises);
        }
        
        function getDateOfISOWeek(week, year) {
            const jan4 = new Date(year, 0, 4);
            const dayOfWeek = jan4.getDay() || 7;
            const monday = new Date(jan4);
            monday.setDate(jan4.getDate() - dayOfWeek + 1 + (week - 1) * 7);
            return monday;
        }
        
        function renderCalendar() {
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
            const dayKeys = ['mon', 'tue', 'wed', 'thu', 'fri'];
            
            // Build week dates
            const weekDates = [];
            for (let i = 0; i < 5; i++) {
                const d = new Date(currentWeek);
                d.setDate(d.getDate() + i);
                weekDates.push(d);
            }
            
            // Header
            let headerHtml = '<tr><th>Technician</th>';
            weekDates.forEach((d, i) => {
                headerHtml += `<th>${days[i]} ${d.getMonth()+1}/${d.getDate()}</th>`;
            });
            headerHtml += '</tr>';
            document.getElementById('calendar-header').innerHTML = headerHtml;
            
            // Group jobs by tech and day (primary jobs)
            const jobsByTechDay = {};
            scheduledJobs.forEach(job => {
                const techId = job.technician_id;
                const jobDate = new Date(job.date + 'T00:00:00');
                const dayOfWeek = jobDate.getDay();
                const dayKey = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][dayOfWeek];
                
                if (!dayKeys.includes(dayKey)) return;
                
                const key = `${techId}-${dayKey}`;
                if (!jobsByTechDay[key]) jobsByTechDay[key] = [];
                jobsByTechDay[key].push({...job, is_additional: false});
            });
            
            // Add additional tech jobs (where this tech is secondary)
            additionalTechJobs.forEach(addl => {
                const techId = addl.technician_id;
                if (!addl.date) return;
                const jobDate = new Date(addl.date + 'T00:00:00');
                const dayOfWeek = jobDate.getDay();
                const dayKey = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][dayOfWeek];
                
                if (!dayKeys.includes(dayKey)) return;
                
                const key = `${techId}-${dayKey}`;
                if (!jobsByTechDay[key]) jobsByTechDay[key] = [];
                jobsByTechDay[key].push({
                    ...addl,
                    is_additional: true,
                    primary_tech: addl.primary_tech_name
                });
            });
            
            // Body
            let bodyHtml = '';
            technicians.forEach(tech => {
                bodyHtml += `<tr>`;
                bodyHtml += `<td class="tech-name">${tech.name}</td>`;
                
                weekDates.forEach((d, i) => {
                    const dateStr = d.toISOString().split('T')[0];
                    const dayKey = dayKeys[i];
                    const cellKey = `${tech.technician_id}-${dayKey}`;
                    const timeOffKey = `${tech.technician_id}-${dateStr}`;
                    
                    // Check time off
                    if (techTimeOff[timeOffKey]) {
                        bodyHtml += `<td class="time-off">${techTimeOff[timeOffKey].reason}</td>`;
                    } else {
                        const jobs = jobsByTechDay[cellKey] || [];
                        const totalHours = jobs.reduce((sum, j) => sum + (j.duration || 0), 0);
                        
                        // Calculate drive time for the day
                        let driveTime = 0;
                        if (jobs.length > 0 && tech.home_latitude && tech.home_longitude) {
                            let currentLat = tech.home_latitude;
                            let currentLon = tech.home_longitude;
                            
                            // Sort jobs by start_time if available, otherwise just sequence
                            const sortedJobs = [...jobs].sort((a, b) => {
                                if (a.start_time && b.start_time) return a.start_time.localeCompare(b.start_time);
                                return 0;
                            });
                            
                            sortedJobs.forEach(job => {
                                if (job.latitude && job.longitude) {
                                    const dist = haversineDistance(currentLat, currentLon, job.latitude, job.longitude);
                                    driveTime += dist / 45; // 45 mph
                                    currentLat = job.latitude;
                                    currentLon = job.longitude;
                                }
                            });
                            
                            // Add drive home
                            if (sortedJobs.length > 0) {
                                const lastJob = sortedJobs[sortedJobs.length - 1];
                                if (lastJob.latitude && lastJob.longitude) {
                                    const distHome = haversineDistance(lastJob.latitude, lastJob.longitude, tech.home_latitude, tech.home_longitude);
                                    // Only add if < 90 miles (otherwise hotel)
                                    if (distHome <= 90) {
                                        driveTime += distHome / 45;
                                    }
                                }
                            }
                        }
                        
                        bodyHtml += `<td class="day-cell" onclick="selectDay(${tech.technician_id}, '${dateStr}')" data-tech="${tech.technician_id}" data-date="${dateStr}">`;
                        
                        jobs.forEach(job => {
                            let chipClass = 'job-chip';
                            if (job.is_recurring_site) chipClass += ' recurring';
                            
                            // Style for additional tech jobs (secondary)
                            let chipStyle = '';
                            let prefix = '';
                            let suffix = '';
                            
                            if (job.is_additional) {
                                chipStyle = 'background: #f3e8ff; border-left: 3px solid #9333ea; font-style: italic;';
                                prefix = '[+] ';
                                suffix = job.primary_tech ? `<div style="font-size: 9px; color: #7c3aed;">w/ ${job.primary_tech}</div>` : '';
                            }
                            
                            bodyHtml += `<div class="${chipClass}" style="${chipStyle}" title="${job.site_name}${job.is_additional ? ' (Additional Tech)' : ''}">${prefix}${job.site_name.substring(0, 20)}${job.site_name.length > 20 ? '...' : ''}${suffix}</div>`;
                        });
                        
                        if (jobs.length > 0) {
                            const totalDay = totalHours + driveTime;
                            const driveStr = driveTime > 0 ? ` + ${driveTime.toFixed(1)}d` : '';
                            const overClass = totalDay > 9 ? 'color: #dc2626; font-weight: bold;' : '';
                            bodyHtml += `<div class="day-total" style="${overClass}">${totalHours.toFixed(1)}w${driveStr}</div>`;
                        }
                        
                        bodyHtml += `</td>`;
                    }
                });
                
                bodyHtml += `</tr>`;
            });
            
            document.getElementById('calendar-body').innerHTML = bodyHtml;
        }
        
        function refreshMap() {
            // Refresh map with current data (called after filter changes)
            renderMap();
            renderUrgentJobs();
        }
        
        function renderMap() {
            // Clear existing markers
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            
            // Add tech home locations - TRIANGULAR markers with TECH COLOR
            technicians.forEach(tech => {
                if (tech.home_latitude && tech.home_longitude) {
                    const techColor = getTechColor(tech.technician_id);
                    const marker = L.marker([tech.home_latitude, tech.home_longitude], {
                        icon: L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div style="width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 18px solid ${techColor};"></div>`,
                            iconSize: [20, 18],
                            iconAnchor: [10, 18]
                        })
                    });
                    marker.bindPopup(`<b style="color: ${techColor};">${tech.name}</b><br>Home: ${tech.home_location || 'Unknown'}`);
                    marker.addTo(map);
                    markers.push(marker);
                }
            });
            
            // Group unscheduled jobs by location
            const unschedJobGroups = {};
            unscheduledJobs.forEach(job => {
                if (job.latitude && job.longitude) {
                    const key = `${job.latitude.toFixed(4)},${job.longitude.toFixed(4)}`;
                    if (!unschedJobGroups[key]) {
                        unschedJobGroups[key] = {
                            coords: [job.latitude, job.longitude],
                            jobs: []
                        };
                    }
                    unschedJobGroups[key].jobs.push(job);
                }
            });
            
            // Add unscheduled job markers - GREEN circles, ORANGE if urgent
            Object.values(unschedJobGroups).forEach(group => {
                // Check urgency - any job due within 14 days makes it urgent
                let isUrgent = false;
                const today = new Date();
                group.jobs.forEach(job => {
                    if (job.due_date) {
                        const due = new Date(job.due_date);
                        const daysUntil = Math.ceil((due - today) / (1000 * 60 * 60 * 24));
                        if (daysUntil <= 14) isUrgent = true;
                    }
                });
                
                const color = isUrgent ? '#f97316' : '#22c55e'; // orange or green
                
                if (group.jobs.length === 1) {
                    const job = group.jobs[0];
                    const marker = L.circleMarker(group.coords, {
                        radius: 8,
                        fillColor: color,
                        color: '#fff',
                        weight: 2,
                        fillOpacity: 0.8
                    });
                    marker.bindPopup(createJobPopup(job));
                    marker.addTo(map);
                    markers.push(marker);
                } else {
                    // Multiple jobs at same location - show count badge
                    const marker = L.marker(group.coords, {
                        icon: L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div style="background-color: ${color}; color: white; width: 24px; height: 24px; border-radius: 50%; border: 2px solid white; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold;">${group.jobs.length}</div>`,
                            iconSize: [24, 24],
                            iconAnchor: [12, 12]
                        })
                    });
                    marker.bindPopup(createMultiJobPopup(group.jobs));
                    marker.addTo(map);
                    markers.push(marker);
                }
            });
            
            // Group scheduled jobs by location AND tech for color coding
            const schedJobGroups = {};
            scheduledJobs.forEach(job => {
                if (job.latitude && job.longitude) {
                    // Key includes tech so same location different techs get different markers
                    const key = `${job.latitude.toFixed(4)},${job.longitude.toFixed(4)},${job.technician_id}`;
                    if (!schedJobGroups[key]) {
                        schedJobGroups[key] = {
                            coords: [job.latitude, job.longitude],
                            techId: job.technician_id,
                            jobs: []
                        };
                    }
                    schedJobGroups[key].jobs.push(job);
                }
            });
            
            // Add scheduled job markers - SQUARES with TECH COLOR
            // Light colors need dark border to be visible
            const lightColors = ['#ffffff', '#00ff7f', '#facc15', '#ff69b4', '#00bfff'];
            
            Object.values(schedJobGroups).forEach(group => {
                const techColor = getTechColor(group.techId);
                const borderColor = lightColors.includes(techColor.toLowerCase()) ? '#333333' : 'white';
                const textColor = lightColors.includes(techColor.toLowerCase()) ? '#333333' : 'white';
                
                if (group.jobs.length === 1) {
                    const job = group.jobs[0];
                    const marker = L.marker(group.coords, {
                        icon: L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div style="background-color: ${techColor}; width: 12px; height: 12px; border: 2px solid ${borderColor}; box-shadow: 0 1px 3px rgba(0,0,0,0.3);"></div>`,
                            iconSize: [12, 12],
                            iconAnchor: [6, 6]
                        })
                    });
                    marker.bindPopup(createScheduledJobPopup(job));
                    marker.addTo(map);
                    markers.push(marker);
                } else {
                    // Multiple scheduled jobs at same location for same tech
                    const marker = L.marker(group.coords, {
                        icon: L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div style="background-color: ${techColor}; color: ${textColor}; width: 20px; height: 20px; border: 2px solid ${borderColor}; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; box-shadow: 0 1px 3px rgba(0,0,0,0.3);">${group.jobs.length}</div>`,
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        })
                    });
                    marker.bindPopup(createMultiScheduledJobPopup(group.jobs));
                    marker.addTo(map);
                    markers.push(marker);
                }
            });
        }
        
        function createJobPopup(job) {
            return `<div style="min-width: 200px;">
                <b><a href="https://connect.cgrs.com/CGRSConnect/WorkOrder/Create?workOrderId=${job.work_order}" target="_blank" style="color: #2563eb; text-decoration: none;">${job.site_name}</a></b><br>
                <span style="color: #666;">${job.region}</span><br>
                <b>WO:</b> <a href="https://connect.cgrs.com/CGRSConnect/WorkOrder/Create?workOrderId=${job.work_order}" target="_blank" style="color: #2563eb;">${job.work_order}</a><br>
                <b>Due:</b> ${job.due_date}<br>
                <b>Duration:</b> ${job.duration}h<br>
                <b>SOW:</b> ${job.sow_1 || 'N/A'}<br>
                <b>Priority:</b> ${job.jp_priority || 'Standard'}<br>
                <div style="display: flex; gap: 5px; margin-top: 8px;">
                    <button onclick="addToSelectedJobs(${job.work_order})" 
                        style="flex: 1; padding: 6px; background: #f59e0b; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                        + Selected
                    </button>
                    <button onclick="selectUrgentJob(${job.work_order})" 
                        style="flex: 1; padding: 6px; background: #22c55e; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                        Suggest Tech
                    </button>
                </div>
            </div>`;
        }
        
        function createMultiJobPopup(jobs) {
            let html = `<div style="min-width: 200px;"><b>${jobs.length} Jobs at this location:</b><hr style="margin: 5px 0;">`;
            jobs.forEach((job, i) => {
                html += `<div style="margin-bottom: 8px; padding-bottom: 8px; ${i < jobs.length - 1 ? 'border-bottom: 1px solid #eee;' : ''}">
                    <b><a href="https://connect.cgrs.com/CGRSConnect/WorkOrder/Create?workOrderId=${job.work_order}" target="_blank" style="color: #2563eb; text-decoration: none;">${job.site_name}</a></b><br>
                    <a href="https://connect.cgrs.com/CGRSConnect/WorkOrder/Create?workOrderId=${job.work_order}" target="_blank" style="color: #2563eb; font-size: 11px;">WO: ${job.work_order}</a><br>
                    Due: ${job.due_date} | ${job.duration}h<br>
                    ${job.sow_1 || ''}<br>
                    <button onclick="selectUrgentJob(${job.work_order})" 
                        style="margin-top: 4px; padding: 4px 8px; background: #22c55e; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                        Suggest Tech
                    </button>
                </div>`;
            });
            html += '</div>';
            return html;
        }
        
        function createScheduledJobPopup(job) {
            const tech = technicians.find(t => t.technician_id === job.technician_id);
            return `<div style="min-width: 200px;">
                <b><a href="https://connect.cgrs.com/CGRSConnect/WorkOrder/Create?workOrderId=${job.work_order}" target="_blank" style="color: #2563eb; text-decoration: none;">${job.site_name}</a></b><br>
                <span style="color: #666;">${job.region || ''}</span><br>
                <b>WO:</b> <a href="https://connect.cgrs.com/CGRSConnect/WorkOrder/Create?workOrderId=${job.work_order}" target="_blank" style="color: #2563eb;">${job.work_order}</a><br>
                <b>Scheduled:</b> ${job.date}<br>
                <b>Tech:</b> ${tech?.name || 'Unknown'}<br>
                <b>Duration:</b> ${job.duration}h
            </div>`;
        }
        
        function createMultiScheduledJobPopup(jobs) {
            let html = `<div style="min-width: 200px;"><b>${jobs.length} Scheduled Jobs:</b><hr style="margin: 5px 0;">`;
            jobs.forEach((job, i) => {
                const tech = technicians.find(t => t.technician_id === job.technician_id);
                html += `<div style="margin-bottom: 8px; padding-bottom: 8px; ${i < jobs.length - 1 ? 'border-bottom: 1px solid #eee;' : ''}">
                    <b><a href="https://connect.cgrs.com/CGRSConnect/WorkOrder/Create?workOrderId=${job.work_order}" target="_blank" style="color: #2563eb; text-decoration: none;">${job.site_name}</a></b><br>
                    <a href="https://connect.cgrs.com/CGRSConnect/WorkOrder/Create?workOrderId=${job.work_order}" target="_blank" style="color: #2563eb; font-size: 11px;">WO: ${job.work_order}</a><br>
                    ${job.date} | ${tech?.name || 'Unknown'} | ${job.duration}h
                </div>`;
            });
            html += '</div>';
            return html;
        }
        
        function renderUrgentJobs() {
            // Get jobs due within the selected week OR within 7 days of week end
            const weekEnd = new Date(currentWeek);
            weekEnd.setDate(weekEnd.getDate() + 6); // End of week (Sunday)
            
            const urgentJobs = unscheduledJobs.filter(job => {
                if (!job.due_date) return false;
                const due = new Date(job.due_date + 'T00:00:00');
                // Show if due before end of selected week + 7 days buffer
                const cutoff = new Date(weekEnd);
                cutoff.setDate(cutoff.getDate() + 7);
                return due <= cutoff;
            }).sort((a, b) => new Date(a.due_date) - new Date(b.due_date));
            
            document.getElementById('urgent-count').textContent = urgentJobs.length;
            
            let html = '';
            urgentJobs.forEach(job => {
                const due = new Date(job.due_date + 'T00:00:00');
                const weekStart = new Date(currentWeek);
                const weekEndDate = new Date(currentWeek);
                weekEndDate.setDate(weekEndDate.getDate() + 4); // Friday
                
                // Color code: red if due during or before selected week, orange if after
                let dueBadgeColor = '#f97316'; // orange
                if (due <= weekEndDate) {
                    dueBadgeColor = '#ef4444'; // red - due this week or overdue
                }
                
                html += `
                    <div class="urgent-job" onclick="selectUrgentJob(${job.work_order})">
                        <div class="due-date" style="color: ${dueBadgeColor};">Due: ${job.due_date}</div>
                        <div class="site-name">${job.site_name}</div>
                        <div class="details">${job.region} | ${job.duration}h | ${job.sow_1 || ''}</div>
                    </div>
                `;
            });
            
            document.getElementById('urgent-list').innerHTML = html || '<p style="color: #666; padding: 10px;">No urgent jobs</p>';
        }
        
        function selectUrgentJob(workOrder) {
            const job = unscheduledJobs.find(j => j.work_order === workOrder);
            if (!job) return;
            
            selectedJob = job;
            
            // Highlight on map
            if (job.latitude && job.longitude) {
                map.setView([job.latitude, job.longitude], 10);
            }
            
            // Show suggestions in detail panel
            showJobSuggestions(job);
        }
        
        function showJobSuggestions(job) {
            const panel = document.getElementById('detail-panel');
            panel.classList.add('open');
            
            document.getElementById('detail-title').textContent = `Assign Job: ${job.site_name}`;
            
            // Build weekday options
            const weekDays = [];
            for (let i = 0; i < 5; i++) {
                const d = new Date(currentWeek);
                d.setDate(d.getDate() + i);
                weekDays.push({
                    date: d.toISOString().split('T')[0],
                    label: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'][i]
                });
            }
            
            // Calculate best techs
            const suggestions = suggestBestTechs(job);
            
            let html = `
                <div style="margin-bottom: 15px; padding: 10px; background: #f0f9ff; border-radius: 6px;">
                    <strong>Job Details:</strong> ${job.region} | ${job.duration}h | Due: ${job.due_date} | SOW: ${job.sow_1 || 'N/A'}
                    <button onclick="addToSelectedJobs(${job.work_order})" style="float: right; padding: 4px 10px; background: #f59e0b; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                        + Add to Selected
                    </button>
                </div>
            `;
            
            // Manual assign section - always show
            html += `
                <div style="margin-bottom: 15px; padding: 10px; background: #fef3c7; border-radius: 6px; border: 1px solid #f59e0b;">
                    <strong style="color: #92400e;">Manual Assign:</strong>
                    <div style="display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap;">
                        <select id="manual-tech-${job.work_order}" style="flex: 1; min-width: 150px; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px;">
                            <option value="">Select Tech...</option>
                            ${technicians.map(t => `<option value="${t.technician_id}">${t.name}</option>`).join('')}
                        </select>
                        <select id="manual-day-${job.work_order}" style="flex: 1; min-width: 120px; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px;">
                            <option value="">Select Day...</option>
                            ${weekDays.map(d => `<option value="${d.date}">${d.label} ${d.date.slice(5)}</option>`).join('')}
                        </select>
                        <button onclick="manualAssignJob(${job.work_order})" style="padding: 6px 12px; background: #f59e0b; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                            Add to Queue
                        </button>
                    </div>
                </div>
            `;
            
            if (suggestions.length > 0) {
                html += `<div style="margin-bottom: 10px;"><strong>Suggested Assignments:</strong></div>`;
                
                suggestions.forEach((sug, i) => {
                    const bgColor = i === 0 ? '#dcfce7' : '#f9fafb';
                    html += `
                        <div style="background: ${bgColor}; margin-bottom: 8px; padding: 10px; border-radius: 6px; border: 1px solid #e5e7eb;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${i + 1}. ${sug.tech.name}</strong>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">
                                        ${sug.reasons.join(' | ')}
                                    </div>
                                </div>
                                <button onclick="addToQueue(${job.work_order}, ${sug.tech.technician_id}, '${sug.suggestedDay}')" 
                                    style="padding: 6px 12px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    Add (${sug.suggestedDay})
                                </button>
                            </div>
                        </div>
                    `;
                });
            } else {
                html += '<p style="color: #666; font-style: italic;">No automatic suggestions - use manual assign above</p>';
            }
            
            document.getElementById('detail-content').innerHTML = html;
        }
        
        function manualAssignJob(workOrder) {
            const techId = document.getElementById(`manual-tech-${workOrder}`).value;
            const day = document.getElementById(`manual-day-${workOrder}`).value;
            
            if (!techId || !day) {
                alert('Please select both a technician and a day');
                return;
            }
            
            addToQueue(workOrder, parseInt(techId), day);
        }
        
        function suggestBestTechs(job) {
            const suggestions = [];
            const jobLat = job.latitude;
            const jobLon = job.longitude;
            const jobRegion = job.region;
            const jobState = jobRegion ? jobRegion.split('_')[0] : null;
            
            technicians.forEach(tech => {
                // Check state eligibility
                const statesAllowed = tech.states_allowed ? tech.states_allowed.split(',') : [];
                if (jobState && !statesAllowed.includes(jobState)) {
                    return; // Not eligible for this state
                }
                
                const reasons = [];
                let score = 0;
                let suggestedDay = null;
                
                // 1. Check if tech has scheduled jobs near this job
                let nearestScheduledDist = Infinity;
                let nearestScheduledDay = null;
                scheduledJobs.forEach(sj => {
                    if (sj.technician_id === tech.technician_id && sj.latitude && sj.longitude) {
                        const dist = haversineDistance(jobLat, jobLon, sj.latitude, sj.longitude);
                        if (dist < nearestScheduledDist) {
                            nearestScheduledDist = dist;
                            nearestScheduledDay = sj.date;
                        }
                    }
                });
                
                if (nearestScheduledDist < 30) {
                    score += 50;
                    reasons.push(`${nearestScheduledDist.toFixed(0)} mi from scheduled job on ${nearestScheduledDay}`);
                    suggestedDay = nearestScheduledDay;
                } else if (nearestScheduledDist < 60) {
                    score += 30;
                    reasons.push(`${nearestScheduledDist.toFixed(0)} mi from scheduled job on ${nearestScheduledDay}`);
                    suggestedDay = nearestScheduledDay;
                }
                
                // 2. Distance from home
                if (tech.home_latitude && tech.home_longitude) {
                    const homeDist = haversineDistance(jobLat, jobLon, tech.home_latitude, tech.home_longitude);
                    if (homeDist < 50) {
                        score += 20;
                        reasons.push(`${homeDist.toFixed(0)} mi from home`);
                    } else if (homeDist < 100) {
                        score += 10;
                        reasons.push(`${homeDist.toFixed(0)} mi from home`);
                    } else {
                        reasons.push(`${homeDist.toFixed(0)} mi from home`);
                    }
                }
                
                // 3. Check capacity (rough estimate)
                const techScheduledHours = scheduledJobs
                    .filter(sj => sj.technician_id === tech.technician_id)
                    .reduce((sum, sj) => sum + (sj.duration || 0), 0);
                
                const availableHours = 50 - techScheduledHours; // Assume 50h week max
                if (availableHours >= job.duration) {
                    score += 10;
                    reasons.push(`${availableHours.toFixed(0)}h available`);
                } else {
                    reasons.push(`Only ${availableHours.toFixed(0)}h available`);
                }
                
                // 4. Check time off
                const weekDates = [];
                for (let i = 0; i < 5; i++) {
                    const d = new Date(currentWeek);
                    d.setDate(d.getDate() + i);
                    weekDates.push(d.toISOString().split('T')[0]);
                }
                const daysOff = weekDates.filter(d => techTimeOff[`${tech.technician_id}-${d}`]).length;
                if (daysOff > 0) {
                    score -= daysOff * 10;
                    reasons.push(`${daysOff} day(s) off`);
                }
                
                // If no suggested day from nearby job, use first available day
                if (!suggestedDay) {
                    for (const d of weekDates) {
                        if (!techTimeOff[`${tech.technician_id}-${d}`]) {
                            suggestedDay = d;
                            break;
                        }
                    }
                }
                
                if (score > 0 || reasons.length > 0) {
                    suggestions.push({
                        tech: tech,
                        score: score,
                        reasons: reasons,
                        suggestedDay: suggestedDay
                    });
                }
            });
            
            // Sort by score descending
            suggestions.sort((a, b) => b.score - a.score);
            
            return suggestions.slice(0, 5); // Top 5
        }
        
        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 3959; // Earth's radius in miles
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        // Queue for batch assignments
        let assignmentQueue = [];
        
        function addToQueue(workOrder, techId, dateStr) {
            const job = unscheduledJobs.find(j => j.work_order === workOrder);
            const tech = technicians.find(t => t.technician_id === techId);
            
            if (!job || !tech) return;
            
            // Check if already in queue
            if (assignmentQueue.some(a => a.work_order === workOrder)) {
                alert('Job already in queue');
                return;
            }
            
            assignmentQueue.push({
                work_order: workOrder,
                technician_id: techId,
                date: dateStr,
                site_name: job.site_name,
                tech_name: tech.name
            });
            
            updateQueueDisplay();
            closeDetailPanel();
        }
        
        function removeFromQueue(workOrder) {
            assignmentQueue = assignmentQueue.filter(a => a.work_order !== workOrder);
            updateQueueDisplay();
        }
        
        function updateQueueDisplay() {
            let queueHtml = document.getElementById('queue-panel');
            if (!queueHtml) {
                // Create queue panel if it doesn't exist
                const panel = document.createElement('div');
                panel.id = 'queue-panel';
                panel.style.cssText = 'position: fixed; bottom: 0; left: 0; right: 0; background: #1e3a5f; color: white; padding: 10px 20px; z-index: 1002; display: none;';
                panel.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>Assignment Queue:</strong> <span id="queue-count">0</span> jobs
                            <span id="queue-items" style="margin-left: 15px; font-size: 12px;"></span>
                        </div>
                        <div>
                            <button onclick="clearQueue()" style="padding: 6px 12px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">Clear</button>
                            <button onclick="saveAllAssignments()" style="padding: 6px 12px; background: #22c55e; color: white; border: none; border-radius: 4px; cursor: pointer;">Save All</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(panel);
                queueHtml = panel;
            }
            
            if (assignmentQueue.length === 0) {
                queueHtml.style.display = 'none';
            } else {
                queueHtml.style.display = 'block';
                document.getElementById('queue-count').textContent = assignmentQueue.length;
                
                const itemsHtml = assignmentQueue.map(a => 
                    `<span style="background: #374151; padding: 2px 8px; border-radius: 4px; margin-right: 5px;">
                        ${a.site_name.substring(0, 15)}... √¢‚Ä†‚Äô ${a.tech_name.split(' ')[0]} (${a.date})
                        <span onclick="removeFromQueue(${a.work_order})" style="cursor: pointer; margin-left: 5px;">√É‚Äî</span>
                    </span>`
                ).join('');
                document.getElementById('queue-items').innerHTML = itemsHtml;
            }
        }
        
        function clearQueue() {
            assignmentQueue = [];
            updateQueueDisplay();
        }
        
        async function saveAllAssignments() {
            if (assignmentQueue.length === 0) {
                alert('No jobs in queue');
                return;
            }
            
            let successCount = 0;
            let errors = [];
            
            for (const assignment of assignmentQueue) {
                try {
                    const response = await fetch('/api/schedule/assign', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            work_order: assignment.work_order,
                            technician_id: assignment.technician_id,
                            date: assignment.date
                        })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        successCount++;
                    } else {
                        errors.push(`${assignment.site_name}: ${result.errors?.join(', ') || 'Unknown error'}`);
                    }
                } catch (error) {
                    errors.push(`${assignment.site_name}: ${error.message}`);
                }
            }
            
            if (errors.length > 0) {
                alert(`Saved ${successCount} jobs.\n\nErrors:\n${errors.join('\n')}`);
            } else {
                alert(`Successfully saved ${successCount} jobs!`);
            }
            
            clearQueue();
            loadData(); // Reload to show updated schedule
        }
        
        async function assignJob(workOrder, techId) {
            // Legacy function - now uses queue
            const dateStr = prompt(`Assign to which date? (YYYY-MM-DD)`, currentWeek.toISOString().split('T')[0]);
            if (!dateStr) return;
            addToQueue(workOrder, techId, dateStr);
        }
        
        function toggleUrgentPanel() {
            const panel = document.getElementById('urgent-panel');
            panel.classList.toggle('open');
        }
        
        function closeDetailPanel() {
            const panel = document.getElementById('detail-panel');
            panel.classList.remove('open');
        }
        
        function toggleRouteBuilder() {
            const panel = document.getElementById('route-panel');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                populateRouteTechSelect();
                // Set default date to selected week's Monday
                if (currentWeek) {
                    document.getElementById('route-start-date').value = currentWeek.toISOString().split('T')[0];
                }
            } else {
                panel.style.display = 'none';
            }
        }
        
        function populateRouteTechSelect() {
            const select = document.getElementById('route-tech-select');
            select.innerHTML = '<option value="">Select tech...</option>';
            technicians.forEach(tech => {
                select.innerHTML += `<option value="${tech.technician_id}">${tech.name}</option>`;
            });
        }
        
        async function loadRegionsForRouteTech() {
            const techId = document.getElementById('route-tech-select').value;
            const regionSelect = document.getElementById('route-region-select');
            
            if (!techId) {
                regionSelect.innerHTML = '<option value="">Select tech first...</option>';
                return;
            }
            
            try {
                // Get regions that have jobs for this tech
                const startDate = document.getElementById('route-start-date').value || currentWeek.toISOString().split('T')[0];
                const startDateObj = new Date(startDate + 'T00:00:00');
                const monthStart = `${startDateObj.getFullYear()}-${String(startDateObj.getMonth() + 1).padStart(2, '0')}-01`;
                const lastDay = new Date(startDateObj.getFullYear(), startDateObj.getMonth() + 1, 0).getDate();
                const monthEnd = `${startDateObj.getFullYear()}-${String(startDateObj.getMonth() + 1).padStart(2, '0')}-${lastDay}`;
                
                const response = await fetch(`/api/regions/analyze?tech_id=${techId}&month_start=${monthStart}&month_end=${monthEnd}`);
                const data = await response.json();
                
                regionSelect.innerHTML = '';
                if (data.regions) {
                    data.regions.forEach(r => {
                        const hotelBadge = r.requires_hotel ? ' (Hotel)' : '';
                        regionSelect.innerHTML += `<option value="${r.region_name}">${r.region_name} - ${r.job_count} jobs, ${r.total_work_hours}h${hotelBadge}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading regions:', error);
                regionSelect.innerHTML = '<option value="">Error loading regions</option>';
            }
        }
        
        // Friday-restricted sites
        const FRIDAY_RESTRICTED_SITES = ['King Soopers', 'Alta', 'Pacific Pride', 'City Market'];
        
        function isFridayRestricted(siteName) {
            return FRIDAY_RESTRICTED_SITES.some(restricted => 
                siteName.toLowerCase().includes(restricted.toLowerCase())
            );
        }
        
        async function buildRoute() {
            const techId = document.getElementById('route-tech-select').value;
            const regionSelect = document.getElementById('route-region-select');
            const selectedRegions = Array.from(regionSelect.selectedOptions).map(opt => opt.value);
            const startDate = document.getElementById('route-start-date').value;
            const numDays = parseInt(document.getElementById('route-days').value);
            
            console.log('Building route:', { techId, selectedRegions, startDate, numDays });
            
            if (!techId || selectedRegions.length === 0 || !startDate) {
                alert('Please select tech, at least one region, and start date');
                return;
            }
            
            const resultsDiv = document.getElementById('route-results');
            resultsDiv.innerHTML = '<p>Building route...</p>';
            
            try {
                const tech = technicians.find(t => t.technician_id === parseInt(techId));
                console.log('Tech found:', tech);
                
                if (!tech) {
                    resultsDiv.innerHTML = '<p style="color: red;">Error: Tech not found</p>';
                    return;
                }
                
                const techHome = { lat: tech.home_latitude, lon: tech.home_longitude };
                
                // Get month boundaries from start date
                const startDateObj = new Date(startDate + 'T00:00:00');
                const monthStart = `${startDateObj.getFullYear()}-${String(startDateObj.getMonth() + 1).padStart(2, '0')}-01`;
                const lastDay = new Date(startDateObj.getFullYear(), startDateObj.getMonth() + 1, 0).getDate();
                const monthEnd = `${startDateObj.getFullYear()}-${String(startDateObj.getMonth() + 1).padStart(2, '0')}-${lastDay}`;
                
                console.log('Date range:', { monthStart, monthEnd });
                
                // Fetch jobs from ALL selected regions
                let allJobs = [];
                for (const region of selectedRegions) {
                    const url = `/api/jobs/region?tech_id=${techId}&region=${encodeURIComponent(region)}&month_start=${monthStart}&month_end=${monthEnd}`;
                    console.log('Fetching:', url);
                    
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data.jobs && data.jobs.length > 0) {
                        // Add region to each job for reference
                        data.jobs.forEach(j => j.region = region);
                        allJobs = allJobs.concat(data.jobs);
                    }
                }
                
                console.log('Total jobs from all regions:', allJobs.length);
                
                if (allJobs.length === 0) {
                    resultsDiv.innerHTML = '<p style="color: #999;">No jobs found in selected regions</p>';
                    return;
                }
                
                // Build route day by day
                const route = buildMultiDayRoute(allJobs, tech, startDate, numDays);
                
                console.log('Route built:', route);
                
                displayRouteResults(route, tech);
                
            } catch (error) {
                console.error('Error building route:', error);
                resultsDiv.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }
        
        function buildMultiDayRoute(jobs, tech, startDateStr, numDays) {
            const route = [];
            const scheduledWorkOrders = new Set();
            let currentLocation = { lat: tech.home_latitude, lon: tech.home_longitude };
            let stayingAtHotel = false;
            
            const startDate = new Date(startDateStr + 'T00:00:00');
            
            // First, handle recurring jobs - they MUST be on their due date
            const recurringJobs = jobs.filter(j => j.is_recurring_site);
            const regularJobs = jobs.filter(j => !j.is_recurring_site);
            
            for (let dayOffset = 0; dayOffset < numDays; dayOffset++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(currentDate.getDate() + dayOffset);
                const dateStr = currentDate.toISOString().split('T')[0];
                const dayName = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][currentDate.getDay()];
                const isFriday = currentDate.getDay() === 5;
                
                // Check time off
                const timeOffKey = `${tech.technician_id}-${dateStr}`;
                if (techTimeOff[timeOffKey]) {
                    route.push({
                        date: dateStr,
                        dayName: dayName,
                        jobs: [],
                        totalWorkHours: 0,
                        totalDriveHours: 0,
                        hotelStay: false,
                        timeOff: true,
                        timeOffReason: techTimeOff[timeOffKey].reason
                    });
                    continue;
                }
                
                const dayJobs = [];
                let dayWorkHours = 0;
                let dayDriveHours = 0;
                const maxDayHours = 9; // Max hours including drive (conservative for mountain driving)
                const avgSpeed = 45; // mph - conservative for mountain/rural roads
                
                // First, add any recurring jobs that MUST be on this date
                recurringJobs.forEach(job => {
                    if (job.due_date === dateStr && !scheduledWorkOrders.has(job.work_order)) {
                        // Check Friday restriction
                        if (isFriday && isFridayRestricted(job.site_name)) {
                            return; // Skip - can't do this on Friday
                        }
                        
                        const distance = haversineDistance(currentLocation.lat, currentLocation.lon, job.latitude, job.longitude);
                        const driveTime = distance / avgSpeed;
                        
                        dayJobs.push({
                            ...job,
                            distance: distance,
                            driveTime: driveTime,
                            isRecurring: true
                        });
                        dayWorkHours += job.duration;
                        dayDriveHours += driveTime;
                        currentLocation = { lat: job.latitude, lon: job.longitude };
                        scheduledWorkOrders.add(job.work_order);
                    }
                });
                
                // Then fill with regular jobs using nearest-neighbor
                let availableJobs = regularJobs.filter(j => 
                    !scheduledWorkOrders.has(j.work_order) &&
                    !(isFriday && isFridayRestricted(j.site_name))
                );
                
                while (availableJobs.length > 0 && (dayWorkHours + dayDriveHours) < maxDayHours) {
                    // Find nearest job that fits
                    let bestJob = null;
                    let bestDistance = Infinity;
                    
                    for (const job of availableJobs) {
                        const distance = haversineDistance(currentLocation.lat, currentLocation.lon, job.latitude, job.longitude);
                        const driveTime = distance / avgSpeed;
                        
                        // Check if it fits
                        if ((dayWorkHours + dayDriveHours + driveTime + job.duration) <= maxDayHours) {
                            if (distance < bestDistance) {
                                bestDistance = distance;
                                bestJob = job;
                            }
                        }
                    }
                    
                    if (!bestJob) break;
                    
                    const driveTime = bestDistance / avgSpeed;
                    dayJobs.push({
                        ...bestJob,
                        distance: bestDistance,
                        driveTime: driveTime,
                        isRecurring: false
                    });
                    dayWorkHours += bestJob.duration;
                    dayDriveHours += driveTime;
                    currentLocation = { lat: bestJob.latitude, lon: bestJob.longitude };
                    scheduledWorkOrders.add(bestJob.work_order);
                    
                    availableJobs = availableJobs.filter(j => j.work_order !== bestJob.work_order);
                }
                
                // Check if hotel needed (90+ miles from home at end of day, not Friday)
                const distanceToHome = haversineDistance(currentLocation.lat, currentLocation.lon, tech.home_latitude, tech.home_longitude);
                const needsHotel = !isFriday && distanceToHome > 90;
                
                // Add drive home time if not staying at hotel
                let driveHomeTime = 0;
                if (!needsHotel && dayJobs.length > 0) {
                    driveHomeTime = distanceToHome / avgSpeed;
                    dayDriveHours += driveHomeTime;
                }
                
                route.push({
                    date: dateStr,
                    dayName: dayName,
                    jobs: dayJobs,
                    totalWorkHours: dayWorkHours,
                    totalDriveHours: dayDriveHours,
                    driveHomeTime: driveHomeTime,
                    hotelStay: needsHotel,
                    endLocation: currentLocation,
                    distanceToHome: distanceToHome,
                    timeOff: false
                });
                
                // If hotel, next day starts from current location; otherwise from home
                if (!needsHotel) {
                    currentLocation = { lat: tech.home_latitude, lon: tech.home_longitude };
                }
            }
            
            return route;
        }
        
        function displayRouteResults(route, tech, warnings = [], skippedJobs = []) {
            const resultsDiv = document.getElementById('route-results');
            
            let totalJobs = 0;
            let totalWorkHours = 0;
            let totalDriveHours = 0;
            
            let html = '<div style="margin-top: 15px;">';
            
            // Show warnings if any
            if (warnings.length > 0) {
                html += `<div style="background: #fef3c7; border: 1px solid #f59e0b; padding: 8px; border-radius: 4px; margin-bottom: 10px;">
                    <strong style="color: #92400e;">√¢≈°¬†√Ø¬∏¬è Warnings:</strong>
                    <ul style="margin: 5px 0 0 15px; padding: 0; font-size: 11px; color: #92400e;">
                        ${warnings.map(w => `<li>${w}</li>`).join('')}
                    </ul>
                </div>`;
            }
            
            // Show skipped jobs section if any
            if (skippedJobs.length > 0) {
                html += `<div style="background: #fef2f2; border: 1px solid #ef4444; padding: 10px; border-radius: 4px; margin-bottom: 10px;">
                    <strong style="color: #991b1b;">√∞≈∏‚Äú‚Äπ Skipped Jobs (${skippedJobs.length}):</strong>
                    <div style="margin-top: 8px; max-height: 150px; overflow-y: auto;">`;
                
                skippedJobs.forEach((job, index) => {
                    const dayOptions = route.map((d, i) => d.timeOff ? '' : `<option value="${i}">${d.dayName}</option>`).join('');
                    html += `
                        <div style="font-size: 11px; padding: 6px; margin-bottom: 4px; background: white; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <span style="font-weight: 500;">${job.site_name}</span><br>
                                <span style="color: #888;">${job.duration || 2}h | Due: ${job.due_date}</span>
                            </div>
                            <select onchange="addSkippedJobToRoute(${index}, this.value)" style="padding: 4px; font-size: 10px; border: 1px solid #22c55e; border-radius: 3px; background: #dcfce7; cursor: pointer;">
                                <option value="">+ Add to...</option>
                                ${dayOptions}
                            </select>
                        </div>
                    `;
                });
                
                html += `</div></div>`;
            }
            
            route.forEach((day, dayIndex) => {
                if (day.timeOff) {
                    html += `
                        <div style="background: #fee2e2; padding: 10px; margin-bottom: 10px; border-radius: 4px;">
                            <strong>${day.dayName} ${day.date}</strong><br>
                            <span style="color: #991b1b;">Time Off: ${day.timeOffReason || 'Time Off'}</span>
                        </div>
                    `;
                    return;
                }
                
                totalJobs += day.jobs.length;
                totalWorkHours += day.totalWorkHours;
                totalDriveHours += day.totalDriveHours;
                
                const hotelBadge = day.hotelStay ? '<span style="background: #fbbf24; color: #78350f; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 5px;">HOTEL</span>' : '';
                
                html += `
                    <div style="background: #f9fafb; padding: 10px; margin-bottom: 10px; border-radius: 4px; border-left: 3px solid #22c55e;" data-day="${dayIndex}">
                        <strong>${day.dayName} ${day.date}</strong>${hotelBadge}<br>
                        <span style="font-size: 12px; color: #666;">
                            ${day.jobs.length} jobs | ${day.totalWorkHours.toFixed(1)}h work | ${day.totalDriveHours.toFixed(1)}h drive
                        </span>
                        <div style="margin-top: 8px;">
                `;
                
                day.jobs.forEach((job, jobIndex) => {
                    const recurringBadge = job.isRecurring ? '<span style="background: #f59e0b; color: white; padding: 1px 4px; border-radius: 2px; font-size: 9px; margin-left: 4px;">REC</span>' : '';
                    const isFirst = jobIndex === 0;
                    const isLast = jobIndex === day.jobs.length - 1;
                    
                    html += `
                        <div style="font-size: 11px; padding: 4px 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;" data-job="${job.work_order}">
                            <div style="flex: 1;">
                                <span style="font-weight: 500;">${jobIndex + 1}. ${job.site_name}</span>${recurringBadge}<br>
                                <span style="color: #888;">${job.duration}h | ${(job.distance || 0).toFixed(0)} mi | Due: ${job.due_date}</span>
                            </div>
                            <div style="display: flex; gap: 2px; margin-left: 8px;">
                                <button onclick="moveJobInRoute(${dayIndex}, ${jobIndex}, 'up')" ${isFirst ? 'disabled' : ''} style="padding: 2px 5px; font-size: 10px; cursor: pointer; border: 1px solid #ddd; border-radius: 3px; background: ${isFirst ? '#eee' : '#fff'};" title="Move up">√¢‚Ä†‚Äò</button>
                                <button onclick="moveJobInRoute(${dayIndex}, ${jobIndex}, 'down')" ${isLast ? 'disabled' : ''} style="padding: 2px 5px; font-size: 10px; cursor: pointer; border: 1px solid #ddd; border-radius: 3px; background: ${isLast ? '#eee' : '#fff'};" title="Move down">√¢‚Ä†‚Äú</button>
                                <select onchange="moveJobToDay(${dayIndex}, ${jobIndex}, this.value)" style="padding: 2px; font-size: 10px; border: 1px solid #ddd; border-radius: 3px; width: 50px;" title="Move to day">
                                    <option value="">Day</option>
                                    ${route.map((d, i) => d.timeOff ? '' : `<option value="${i}" ${i === dayIndex ? 'disabled' : ''}>${d.dayName.substring(0, 3)}</option>`).join('')}
                                </select>
                                <button onclick="removeJobFromRoute(${dayIndex}, ${jobIndex})" style="padding: 2px 5px; font-size: 10px; cursor: pointer; border: 1px solid #ef4444; border-radius: 3px; background: #fee2e2; color: #dc2626;" title="Remove">√¢≈ì‚Ä¢</button>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            });
            
            html += `
                <div style="background: #dcfce7; padding: 10px; border-radius: 4px; margin-top: 10px;">
                    <strong>Route Summary</strong><br>
                    ${totalJobs} jobs | ${totalWorkHours.toFixed(1)}h work | ${totalDriveHours.toFixed(1)}h drive
                </div>
                <button onclick="recalculateRoute()" style="width: 100%; padding: 10px; background: #f59e0b; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-top: 10px;">
                    Recalculate Times
                </button>
                <button onclick="addRouteToQueue()" style="width: 100%; padding: 10px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-top: 5px;">
                    Add All to Queue
                </button>
            `;
            
            html += '</div>';
            
            resultsDiv.innerHTML = html;
            
            // Store route for adding to queue (preserve skippedJobs)
            window.currentBuiltRoute = { route, tech, skippedJobs };
            
            // Visualize route on map
            visualizeRouteOnMap(route, tech);
        }
        
        function moveJobInRoute(dayIndex, jobIndex, direction) {
            if (!window.currentBuiltRoute) return;
            
            const { route, tech } = window.currentBuiltRoute;
            const day = route[dayIndex];
            
            if (direction === 'up' && jobIndex > 0) {
                [day.jobs[jobIndex], day.jobs[jobIndex - 1]] = [day.jobs[jobIndex - 1], day.jobs[jobIndex]];
            } else if (direction === 'down' && jobIndex < day.jobs.length - 1) {
                [day.jobs[jobIndex], day.jobs[jobIndex + 1]] = [day.jobs[jobIndex + 1], day.jobs[jobIndex]];
            }
            
            recalculateRoute();
        }
        
        function moveJobToDay(fromDayIndex, jobIndex, toDayIndex) {
            if (!window.currentBuiltRoute || toDayIndex === '') return;
            
            const { route, tech } = window.currentBuiltRoute;
            toDayIndex = parseInt(toDayIndex);
            
            const job = route[fromDayIndex].jobs.splice(jobIndex, 1)[0];
            route[toDayIndex].jobs.push(job);
            
            recalculateRoute();
        }
        
        function removeJobFromRoute(dayIndex, jobIndex) {
            if (!window.currentBuiltRoute) return;
            
            const { route, tech } = window.currentBuiltRoute;
            route[dayIndex].jobs.splice(jobIndex, 1);
            
            recalculateRoute();
        }
        
        function addSkippedJobToRoute(skippedIndex, toDayIndex) {
            if (!window.currentBuiltRoute || toDayIndex === '') return;
            
            const { route, tech, skippedJobs } = window.currentBuiltRoute;
            if (!skippedJobs || skippedIndex >= skippedJobs.length) return;
            
            toDayIndex = parseInt(toDayIndex);
            
            // Get the job from skipped list
            const job = skippedJobs.splice(skippedIndex, 1)[0];
            
            // Add to the selected day (at the end)
            route[toDayIndex].jobs.push({
                ...job,
                distance: 0,
                driveTime: 0,
                isSelected: true,
                isRecurring: job.is_recurring_site || false
            });
            
            // Update stored skipped jobs
            window.currentBuiltRoute.skippedJobs = skippedJobs;
            
            recalculateRoute();
        }
        
        function recalculateRoute() {
            if (!window.currentBuiltRoute) return;
            
            const { route, tech, skippedJobs } = window.currentBuiltRoute;
            const avgSpeed = 45;
            
            let currentLocation = { lat: tech.home_latitude, lon: tech.home_longitude };
            
            route.forEach((day, dayIndex) => {
                if (day.timeOff || day.jobs.length === 0) {
                    day.totalWorkHours = 0;
                    day.totalDriveHours = 0;
                    if (!day.hotelStay) {
                        currentLocation = { lat: tech.home_latitude, lon: tech.home_longitude };
                    }
                    return;
                }
                
                let dayWorkHours = 0;
                let dayDriveHours = 0;
                
                day.jobs.forEach((job, jobIndex) => {
                    const distance = haversineDistance(currentLocation.lat, currentLocation.lon, job.latitude, job.longitude);
                    const driveTime = distance / avgSpeed;
                    
                    job.distance = distance;
                    job.driveTime = driveTime;
                    
                    dayWorkHours += job.duration;
                    dayDriveHours += driveTime;
                    
                    currentLocation = { lat: job.latitude, lon: job.longitude };
                });
                
                const distanceToHome = haversineDistance(currentLocation.lat, currentLocation.lon, tech.home_latitude, tech.home_longitude);
                const isFriday = new Date(day.date + 'T00:00:00').getDay() === 5;
                day.hotelStay = !isFriday && distanceToHome > 90;
                day.distanceToHome = distanceToHome;
                
                if (!day.hotelStay) {
                    dayDriveHours += distanceToHome / avgSpeed;
                    currentLocation = { lat: tech.home_latitude, lon: tech.home_longitude };
                }
                
                day.totalWorkHours = dayWorkHours;
                day.totalDriveHours = dayDriveHours;
            });
            
            // Pass skipped jobs to display so they remain visible
            displayRouteResults(route, tech, [], skippedJobs || []);
        }
        
        // Store route visualization layers so we can clear them
        let routeLayers = [];
        
        function clearRouteVisualization() {
            routeLayers.forEach(layer => map.removeLayer(layer));
            routeLayers = [];
        }
        
        function visualizeRouteOnMap(route, tech) {
            // Clear previous route visualization
            clearRouteVisualization();
            
            // Day colors for route lines
            const dayColors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6']; // Mon=red, Tue=orange, Wed=yellow, Thu=green, Fri=blue
            
            let allCoords = [];
            let currentLocation = { lat: tech.home_latitude, lon: tech.home_longitude };
            
            // Add tech home marker (larger, distinct)
            const homeMarker = L.marker([tech.home_latitude, tech.home_longitude], {
                icon: L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="width: 0; height: 0; border-left: 12px solid transparent; border-right: 12px solid transparent; border-bottom: 22px solid #1e40af; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.3));"></div>`,
                    iconSize: [24, 22],
                    iconAnchor: [12, 22]
                })
            });
            homeMarker.bindPopup(`<b>${tech.name}</b><br>Home Base`);
            homeMarker.addTo(map);
            routeLayers.push(homeMarker);
            
            route.forEach((day, dayIndex) => {
                if (day.timeOff || day.jobs.length === 0) {
                    // Reset to home if not hotel
                    if (!day.hotelStay) {
                        currentLocation = { lat: tech.home_latitude, lon: tech.home_longitude };
                    }
                    return;
                }
                
                const dayColor = dayColors[dayIndex % dayColors.length];
                const routeCoords = [[currentLocation.lat, currentLocation.lon]];
                
                // Add job markers and build route line
                day.jobs.forEach((job, jobIndex) => {
                    routeCoords.push([job.latitude, job.longitude]);
                    
                    // Job marker with day number
                    const jobMarker = L.marker([job.latitude, job.longitude], {
                        icon: L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div style="background: ${dayColor}; color: white; width: 22px; height: 22px; border-radius: 50%; border: 2px solid white; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">${jobIndex + 1}</div>`,
                            iconSize: [22, 22],
                            iconAnchor: [11, 11]
                        })
                    });
                    jobMarker.bindPopup(`
                        <b>${job.site_name}</b><br>
                        ${day.dayName} - Stop #${jobIndex + 1}<br>
                        Duration: ${job.duration}h<br>
                        Due: ${job.due_date}
                    `);
                    jobMarker.addTo(map);
                    routeLayers.push(jobMarker);
                    
                    currentLocation = { lat: job.latitude, lon: job.longitude };
                });
                
                // If not staying at hotel, add return line to home
                if (!day.hotelStay) {
                    routeCoords.push([tech.home_latitude, tech.home_longitude]);
                    currentLocation = { lat: tech.home_latitude, lon: tech.home_longitude };
                } else {
                    // Add hotel marker at last job location
                    const lastJob = day.jobs[day.jobs.length - 1];
                    const hotelMarker = L.marker([lastJob.latitude, lastJob.longitude], {
                        icon: L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div style="background: #fbbf24; color: #78350f; width: 24px; height: 24px; border-radius: 4px; border: 2px solid white; display: flex; align-items: center; justify-content: center; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">√∞≈∏¬è¬®</div>`,
                            iconSize: [24, 24],
                            iconAnchor: [12, 24]
                        })
                    });
                    hotelMarker.bindPopup(`<b>Hotel Stay</b><br>After ${day.dayName}<br>${lastJob.site_city}`);
                    hotelMarker.addTo(map);
                    routeLayers.push(hotelMarker);
                }
                
                // Draw route line for this day
                const routeLine = L.polyline(routeCoords, {
                    color: dayColor,
                    weight: 3,
                    opacity: 0.8,
                    dashArray: day.hotelStay ? null : '10, 5' // Dashed if returning home
                });
                routeLine.addTo(map);
                routeLayers.push(routeLine);
                
                allCoords = allCoords.concat(routeCoords);
            });
            
            // Fit map to show entire route
            if (allCoords.length > 0) {
                const bounds = L.latLngBounds(allCoords);
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }
        
        function addRouteToQueue() {
            if (!window.currentBuiltRoute) {
                alert('No route to add');
                return;
            }
            
            const { route, tech } = window.currentBuiltRoute;
            
            route.forEach(day => {
                if (day.timeOff) return;
                
                day.jobs.forEach(job => {
                    // Check if already in queue
                    if (!assignmentQueue.some(a => a.work_order === job.work_order)) {
                        assignmentQueue.push({
                            work_order: job.work_order,
                            technician_id: tech.technician_id,
                            date: day.date,
                            site_name: job.site_name,
                            tech_name: tech.name
                        });
                    }
                });
            });
            
            updateQueueDisplay();
            alert(`Added ${assignmentQueue.length} jobs to queue`);
        }
        
        async function showHistoricalRoutes() {
            const regionSelect = document.getElementById('route-region-select');
            const selectedRegions = Array.from(regionSelect.selectedOptions).map(opt => opt.value);
            const startDate = document.getElementById('route-start-date').value;
            
            if (selectedRegions.length === 0) {
                alert('Please select at least one region');
                return;
            }
            
            const historicalDiv = document.getElementById('historical-results');
            const routeDiv = document.getElementById('route-results');
            
            routeDiv.style.display = 'none';
            historicalDiv.style.display = 'block';
            historicalDiv.innerHTML = '<p>Loading historical routes...</p>';
            
            try {
                // Get month and year from start date for filtering
                const startDateObj = new Date(startDate + 'T00:00:00');
                const month = startDateObj.getMonth() + 1;
                const selectedYear = startDateObj.getFullYear();
                
                // Query previous 2 years for this month (e.g., if scheduling Jan 2026, look at Jan 2025 and Jan 2024)
                const years = [selectedYear - 1, selectedYear - 2];
                
                console.log('Looking for historical routes in years:', years, 'month:', month);
                
                // Get already scheduled sites for this year
                const scheduledRes = await fetch(`/api/schedule/scheduled-sites?year=${selectedYear}`);
                const scheduledData = await scheduledRes.json();
                const scheduledSiteIds = new Set(scheduledData.scheduled_site_ids || []);
                console.log('Already scheduled sites:', scheduledSiteIds.size);
                
                let allTrips = [];
                
                for (const year of years) {
                    const url = `/api/history/routes?regions=${encodeURIComponent(selectedRegions.join(','))}&month=${month}&year=${year}`;
                    console.log('Fetching historical:', url);
                    
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data.trips && data.trips.length > 0) {
                        data.trips.forEach(trip => {
                            trip.year = year;
                            
                            // Filter out already scheduled sites from each day
                            trip.days.forEach(day => {
                                const originalCount = day.jobs.length;
                                day.jobs = day.jobs.filter(job => !scheduledSiteIds.has(job.site_id));
                                day.filtered_count = originalCount - day.jobs.length;
                            });
                            
                            // Recalculate totals
                            trip.total_jobs = trip.days.reduce((sum, d) => sum + d.jobs.length, 0);
                            trip.total_hours = trip.days.reduce((sum, d) => sum + d.jobs.reduce((s, j) => s + (j.duration || 2), 0), 0);
                            trip.filtered_jobs = trip.days.reduce((sum, d) => sum + (d.filtered_count || 0), 0);
                        });
                        
                        // Only include trips that still have jobs after filtering
                        const validTrips = data.trips.filter(t => t.total_jobs > 0);
                        allTrips = allTrips.concat(validTrips);
                    }
                }
                
                if (allTrips.length === 0) {
                    historicalDiv.innerHTML = '<p style="color: #999;">No historical routes found for these regions (or all sites already scheduled)</p>';
                    return;
                }
                
                // Get tech names
                const techNames = {};
                technicians.forEach(t => techNames[t.technician_id] = t.name);
                
                // Display trips
                let html = `<div style="font-weight: bold; margin-bottom: 10px;">Historical Routes (${allTrips.length} trips found)</div>`;
                if (scheduledSiteIds.size > 0) {
                    html += `<div style="font-size: 11px; color: #666; margin-bottom: 10px;">Excluding ${scheduledSiteIds.size} sites already scheduled in ${selectedYear}</div>`;
                }
                
                allTrips.forEach((trip, index) => {
                    const techName = techNames[trip.technician_id] || `Tech ${trip.technician_id}`;
                    const regionBadges = trip.regions.map(r => `<span style="background: #e5e7eb; padding: 1px 4px; border-radius: 2px; font-size: 9px; margin-right: 2px;">${r}</span>`).join('');
                    const filteredNote = trip.filtered_jobs > 0 ? `<span style="color: #f59e0b; font-size: 10px;"> (${trip.filtered_jobs} already scheduled)</span>` : '';
                    
                    html += `
                        <div style="background: #f5f3ff; padding: 10px; margin-bottom: 8px; border-radius: 4px; border-left: 3px solid #8b5cf6;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <strong>${techName}</strong> - ${trip.year}<br>
                                    <span style="font-size: 11px; color: #666;">
                                        ${trip.start_date} to ${trip.end_date} (${trip.num_days} days)<br>
                                        ${trip.total_jobs} jobs | ${trip.total_hours.toFixed(1)}h work${filteredNote}
                                    </span><br>
                                    <span style="font-size: 10px;">${regionBadges}</span>
                                </div>
                                <button onclick="viewHistoricalTrip(${index})" style="padding: 4px 8px; background: #8b5cf6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                                    View
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += `<button onclick="hideHistoricalRoutes()" style="width: 100%; padding: 8px; background: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px;">Back to Route Builder</button>`;
                
                historicalDiv.innerHTML = html;
                
                // Store trips for viewing
                window.historicalTrips = allTrips;
                
            } catch (error) {
                console.error('Error loading historical routes:', error);
                historicalDiv.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }
        
        function hideHistoricalRoutes() {
            document.getElementById('historical-results').style.display = 'none';
            document.getElementById('route-results').style.display = 'block';
        }
        
        function viewHistoricalTrip(tripIndex) {
            if (!window.historicalTrips || !window.historicalTrips[tripIndex]) return;
            
            const trip = window.historicalTrips[tripIndex];
            const historicalDiv = document.getElementById('historical-results');
            
            // Get tech name
            const techNames = {};
            technicians.forEach(t => techNames[t.technician_id] = t.name);
            const techName = techNames[trip.technician_id] || `Tech ${trip.technician_id}`;
            
            let html = `
                <div style="margin-bottom: 10px;">
                    <button onclick="showHistoricalRoutes()" style="padding: 4px 8px; background: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">√¢‚Ä†¬ê Back</button>
                </div>
                <div style="font-weight: bold; margin-bottom: 10px;">${techName}'s Route - ${trip.year}</div>
                <div style="font-size: 12px; color: #666; margin-bottom: 15px;">${trip.start_date} to ${trip.end_date}</div>
            `;
            
            trip.days.forEach(day => {
                html += `
                    <div style="background: #f5f3ff; padding: 10px; margin-bottom: 8px; border-radius: 4px; border-left: 3px solid #8b5cf6;">
                        <strong>${day.date}</strong><br>
                        <span style="font-size: 12px; color: #666;">${day.jobs.length} jobs</span>
                        <div style="margin-top: 8px;">
                `;
                
                day.jobs.forEach((job, i) => {
                    html += `
                        <div style="font-size: 11px; padding: 3px 0; border-bottom: 1px solid #e9d5ff;">
                            ${i + 1}. ${job.site_name}<br>
                            <span style="color: #888;">${job.region} | ${job.duration || 2}h</span>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            });
            
            html += `<button onclick="useHistoricalAsTemplate(${tripIndex})" style="width: 100%; padding: 10px; background: #22c55e; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-top: 10px;">Use as Template</button>`;
            
            historicalDiv.innerHTML = html;
            
            // Visualize on map
            visualizeHistoricalTrip(trip);
        }
        
        function visualizeHistoricalTrip(trip) {
            clearRouteVisualization();
            
            const dayColors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6'];
            let allCoords = [];
            
            trip.days.forEach((day, dayIndex) => {
                const dayColor = dayColors[dayIndex % dayColors.length];
                const routeCoords = [];
                
                day.jobs.forEach((job, jobIndex) => {
                    if (job.latitude && job.longitude) {
                        routeCoords.push([parseFloat(job.latitude), parseFloat(job.longitude)]);
                        
                        const jobMarker = L.marker([parseFloat(job.latitude), parseFloat(job.longitude)], {
                            icon: L.divIcon({
                                className: 'custom-div-icon',
                                html: `<div style="background: ${dayColor}; color: white; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold;">${jobIndex + 1}</div>`,
                                iconSize: [20, 20],
                                iconAnchor: [10, 10]
                            })
                        });
                        jobMarker.bindPopup(`<b>${job.site_name}</b><br>${day.date} - Stop #${jobIndex + 1}`);
                        jobMarker.addTo(map);
                        routeLayers.push(jobMarker);
                    }
                });
                
                if (routeCoords.length > 1) {
                    const routeLine = L.polyline(routeCoords, {
                        color: dayColor,
                        weight: 3,
                        opacity: 0.8
                    });
                    routeLine.addTo(map);
                    routeLayers.push(routeLine);
                }
                
                allCoords = allCoords.concat(routeCoords);
            });
            
            if (allCoords.length > 0) {
                const bounds = L.latLngBounds(allCoords);
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }
        
        async function useHistoricalAsTemplate(tripIndex) {
            if (!window.historicalTrips || !window.historicalTrips[tripIndex]) return;
            
            const trip = window.historicalTrips[tripIndex];
            const techId = document.getElementById('route-tech-select').value;
            const startDate = document.getElementById('route-start-date').value;
            
            if (!techId) {
                alert('Please select a technician first');
                return;
            }
            
            const tech = technicians.find(t => t.technician_id === parseInt(techId));
            if (!tech) {
                alert('Technician not found');
                return;
            }
            
            const historicalDiv = document.getElementById('historical-results');
            historicalDiv.innerHTML = '<p>Matching historical sites to current jobs...</p>';
            
            try {
                // Collect all site_ids from the historical trip
                const historicalSiteIds = [];
                trip.days.forEach(day => {
                    day.jobs.forEach(job => {
                        if (job.site_id) historicalSiteIds.push(job.site_id);
                    });
                });
                
                // Find matching jobs in current unscheduled jobs
                const matchedJobs = unscheduledJobs.filter(job => 
                    historicalSiteIds.includes(job.site_id)
                );
                
                if (matchedJobs.length === 0) {
                    historicalDiv.innerHTML = '<p style="color: #f59e0b;">No matching unscheduled jobs found for this historical route. Sites may already be scheduled or not due this period.</p>';
                    return;
                }
                
                // Build route using the matched jobs, following historical day pattern
                const route = [];
                const usedWorkOrders = new Set();
                let currentDate = new Date(startDate + 'T00:00:00');
                
                trip.days.forEach((historicalDay, dayIndex) => {
                    // Skip weekends
                    while (currentDate.getDay() === 0 || currentDate.getDay() === 6) {
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                    
                    const dateStr = currentDate.toISOString().split('T')[0];
                    const dayName = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][currentDate.getDay()];
                    
                    const dayJobs = [];
                    let dayWorkHours = 0;
                    let dayDriveHours = 0;
                    let currentLocation = { lat: tech.home_latitude, lon: tech.home_longitude };
                    
                    // Try to match jobs from this historical day
                    historicalDay.jobs.forEach(histJob => {
                        const matchedJob = matchedJobs.find(j => 
                            j.site_id === histJob.site_id && !usedWorkOrders.has(j.work_order)
                        );
                        
                        if (matchedJob && dayWorkHours + (matchedJob.duration || 2) <= 9) {
                            const distance = haversineDistance(
                                currentLocation.lat, currentLocation.lon,
                                matchedJob.latitude, matchedJob.longitude
                            );
                            const driveTime = distance / 45;
                            
                            dayJobs.push({
                                ...matchedJob,
                                distance: distance,
                                driveTime: driveTime,
                                isRecurring: matchedJob.is_recurring_site
                            });
                            
                            usedWorkOrders.add(matchedJob.work_order);
                            dayWorkHours += matchedJob.duration || 2;
                            dayDriveHours += driveTime;
                            currentLocation = { lat: matchedJob.latitude, lon: matchedJob.longitude };
                        }
                    });
                    
                    // Calculate drive home
                    if (dayJobs.length > 0) {
                        const lastJob = dayJobs[dayJobs.length - 1];
                        const distHome = haversineDistance(lastJob.latitude, lastJob.longitude, tech.home_latitude, tech.home_longitude);
                        const isFriday = currentDate.getDay() === 5;
                        const hotelStay = !isFriday && distHome > 90;
                        
                        if (!hotelStay) {
                            dayDriveHours += distHome / 45;
                        }
                        
                        route.push({
                            date: dateStr,
                            dayName: dayName,
                            jobs: dayJobs,
                            totalWorkHours: dayWorkHours,
                            totalDriveHours: dayDriveHours,
                            hotelStay: hotelStay,
                            distanceToHome: distHome
                        });
                    }
                    
                    currentDate.setDate(currentDate.getDate() + 1);
                });
                
                if (route.length === 0 || route.every(d => d.jobs.length === 0)) {
                    historicalDiv.innerHTML = '<p style="color: #f59e0b;">Could not build route - no jobs matched or all filtered out.</p>';
                    return;
                }
                
                // Store and display
                window.currentBuiltRoute = { route, tech };
                
                // Show results and switch to route view
                hideHistoricalRoutes();
                displayRouteResults(route, tech);
                
                const totalMatched = route.reduce((sum, d) => sum + d.jobs.length, 0);
                alert(`Matched ${totalMatched} of ${historicalSiteIds.length} historical sites to current jobs. Review the route and adjust as needed.`);
                
            } catch (error) {
                console.error('Error using template:', error);
                historicalDiv.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }
        
        // Track pending changes
        let pendingChanges = [];
        
        function selectDay(techId, dateStr) {
            // Remove previous selection
            document.querySelectorAll('.day-cell.selected').forEach(el => el.classList.remove('selected'));
            
            // Add selection
            const cell = document.querySelector(`[data-tech="${techId}"][data-date="${dateStr}"]`);
            if (cell) cell.classList.add('selected');
            
            // Get jobs for this day
            const dayJobs = scheduledJobs.filter(j => 
                j.technician_id === techId && j.date === dateStr
            );
            
            const tech = technicians.find(t => t.technician_id === techId);
            
            // Store current selection for move operations
            window.selectedTechDay = { techId, dateStr, tech, dayJobs };
            
            // Calculate day hours
            const totalWorkHours = dayJobs.reduce((sum, j) => sum + (j.duration || 0), 0);
            const remainingHours = Math.max(0, 9 - totalWorkHours);
            
            // Show detail panel
            const panel = document.getElementById('detail-panel');
            panel.classList.add('open');
            
            document.getElementById('detail-title').innerHTML = 
                `${tech?.name || 'Unknown'} - ${dateStr} (${dayJobs.length} jobs, ${totalWorkHours.toFixed(1)}h scheduled)
                ${remainingHours > 1 ? `<button onclick="fillDay(${techId}, '${dateStr}')" style="margin-left: 15px; padding: 4px 10px; background: #8b5cf6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Fill Day (${remainingHours.toFixed(1)}h available)</button>` : ''}`;
            
            // Build weekday options for move dropdown
            const weekDays = [];
            for (let i = 0; i < 5; i++) {
                const d = new Date(currentWeek);
                d.setDate(d.getDate() + i);
                weekDays.push({
                    date: d.toISOString().split('T')[0],
                    label: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'][i]
                });
            }
            
            let detailHtml = '';
            if (dayJobs.length === 0) {
                detailHtml = `<p style="color: #666;">No jobs scheduled. 
                    <button onclick="fillDay(${techId}, '${dateStr}')" style="padding: 4px 10px; background: #8b5cf6; color: white; border: none; border-radius: 4px; cursor: pointer;">Fill Day</button>
                    or use Urgent Jobs / Route Builder to add jobs.</p>`;
            } else {
                detailHtml = '<div style="display: flex; flex-wrap: wrap; gap: 12px;">';
                dayJobs.forEach((job, index) => {
                    detailHtml += `
                        <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px; padding: 12px; min-width: 220px; max-width: 280px; flex: 1;">
                            <div style="margin-bottom: 10px;">
                                <div style="font-weight: 600; font-size: 13px; margin-bottom: 6px;">
                                    <a href="https://connect.cgrs.com/CGRSConnect/WorkOrder/Create?workOrderId=${job.work_order}" target="_blank" style="color: #2563eb; text-decoration: none;" title="Open in CGRS">${job.site_name}</a>
                                </div>
                                <div style="font-size: 11px; color: #666; line-height: 1.4;">
                                    <div><strong>WO:</strong> <a href="https://connect.cgrs.com/CGRSConnect/WorkOrder/Create?workOrderId=${job.work_order}" target="_blank" style="color: #2563eb;">${job.work_order}</a></div>
                                    <div><strong>Duration:</strong> ${job.duration}h</div>
                                    <div><strong>SOW:</strong> ${job.sow_1 || 'N/A'}</div>
                                    <div><strong>Due:</strong> ${job.due_date || 'N/A'}</div>
                                </div>
                            </div>
                            <div style="border-top: 1px solid #e5e7eb; padding-top: 8px; display: flex; flex-direction: column; gap: 4px;">
                                <div style="display: flex; gap: 4px; align-items: center;">
                                    <select onchange="queueMoveJob(${job.work_order}, '${job.site_name.replace(/'/g, "\\'")}', this.value, 'date')" style="flex: 1; padding: 4px; font-size: 10px; border: 1px solid #d1d5db; border-radius: 4px;">
                                        <option value="">Move to day...</option>
                                        ${weekDays.map(d => `<option value="${d.date}" ${d.date === dateStr ? 'disabled' : ''}>${d.label} ${d.date.slice(5)}</option>`).join('')}
                                    </select>
                                    <button onclick="queueUnschedule(${job.work_order}, '${job.site_name.replace(/'/g, "\\'")}')" style="padding: 4px 8px; font-size: 12px; background: #fee2e2; color: #dc2626; border: 1px solid #fca5a5; border-radius: 4px; cursor: pointer; font-weight: bold;" title="Remove">√¢≈ì‚Ä¢</button>
                                </div>
                                <select onchange="queueMoveJob(${job.work_order}, '${job.site_name.replace(/'/g, "\\'")}', this.value, 'tech')" style="padding: 4px; font-size: 10px; border: 1px solid #d1d5db; border-radius: 4px;">
                                    <option value="">Reassign to tech...</option>
                                    ${technicians.map(t => `<option value="${t.technician_id}" ${t.technician_id === techId ? 'disabled' : ''}>${t.name}</option>`).join('')}
                                </select>
                                <select onchange="queueAddSecondaryTech(${job.work_order}, '${job.site_name.replace(/'/g, "\\'")}', this.value)" style="padding: 4px; font-size: 10px; border: 1px solid #d1d5db; border-radius: 4px;">
                                    <option value="">Add secondary tech...</option>
                                    ${technicians.map(t => `<option value="${t.technician_id}" ${t.technician_id === techId ? 'disabled' : ''}>${t.name}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                    `;
                });
                detailHtml += '</div>';
            }
            
            document.getElementById('detail-content').innerHTML = detailHtml;
            
            // Highlight jobs on map
            highlightTechDay(techId, dateStr);
        }
        
        async function fillDay(techId, dateStr) {
            const tech = technicians.find(t => t.technician_id === techId);
            const dayJobs = scheduledJobs.filter(j => j.technician_id === techId && j.date === dateStr);
            
            const totalWorkHours = dayJobs.reduce((sum, j) => sum + (j.duration || 0), 0);
            const remainingHours = Math.max(0, 9 - totalWorkHours);
            
            if (remainingHours < 0.5) {
                alert('Day is already full');
                return;
            }
            
            const panel = document.getElementById('detail-panel');
            document.getElementById('detail-title').textContent = `Finding jobs to fill ${tech?.name}'s day (${remainingHours.toFixed(1)}h available)...`;
            document.getElementById('detail-content').innerHTML = '<p>Searching...</p>';
            
            try {
                // Get center point from scheduled jobs or tech home
                let centerLat, centerLon;
                if (dayJobs.length > 0) {
                    // Use average of scheduled job locations
                    const validJobs = dayJobs.filter(j => j.latitude && j.longitude);
                    if (validJobs.length > 0) {
                        centerLat = validJobs.reduce((sum, j) => sum + j.latitude, 0) / validJobs.length;
                        centerLon = validJobs.reduce((sum, j) => sum + j.longitude, 0) / validJobs.length;
                    } else {
                        centerLat = tech.home_latitude;
                        centerLon = tech.home_longitude;
                    }
                } else {
                    centerLat = tech.home_latitude;
                    centerLon = tech.home_longitude;
                }
                
                // Get month boundaries
                const dateObj = new Date(dateStr + 'T00:00:00');
                const monthStart = `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}-01`;
                const lastDay = new Date(dateObj.getFullYear(), dateObj.getMonth() + 1, 0).getDate();
                const monthEnd = `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}-${lastDay}`;
                
                // Fetch nearby jobs
                const nearbyUrl = `/api/fill-day/suggestions?tech_id=${techId}&center_lat=${centerLat}&center_lon=${centerLon}&date=${dateStr}&remaining_hours=${remainingHours}&month_start=${monthStart}&month_end=${monthEnd}`;
                const response = await fetch(nearbyUrl);
                const data = await response.json();
                
                if (!data.suggestions || data.suggestions.length === 0) {
                    document.getElementById('detail-title').textContent = `No nearby jobs found for ${tech?.name} on ${dateStr}`;
                    document.getElementById('detail-content').innerHTML = '<p style="color: #666;">No eligible jobs found within range that fit the remaining time.</p>';
                    return;
                }
                
                // Display suggestions
                document.getElementById('detail-title').innerHTML = `Fill Day: ${tech?.name} - ${dateStr} (${data.suggestions.length} suggestions)`;
                
                let html = '<div style="display: flex; flex-wrap: wrap; gap: 10px;">';
                data.suggestions.forEach((job, i) => {
                    const typeLabel = job.suggestion_type === 'nearby' ? '√∞≈∏‚Äú¬ç Nearby' : '√∞≈∏‚Ä∫¬£√Ø¬∏¬è Corridor';
                    const bgColor = job.suggestion_type === 'nearby' ? '#f0fdf4' : '#fef3c7';
                    
                    html += `
                        <div style="background: ${bgColor}; border: 1px solid #d1d5db; border-radius: 6px; padding: 10px; min-width: 200px; max-width: 250px; flex: 1;">
                            <div style="font-size: 10px; color: #666; margin-bottom: 4px;">${typeLabel} | ${job.distance_miles?.toFixed(1) || '?'} mi</div>
                            <div style="font-weight: 600; font-size: 12px; margin-bottom: 4px;">
                                <a href="https://connect.cgrs.com/CGRSConnect/WorkOrder/Create?workOrderId=${job.work_order}" target="_blank" style="color: #2563eb; text-decoration: none;">${job.site_name}</a>
                            </div>
                            <div style="font-size: 10px; color: #666; margin-bottom: 8px;">
                                ${job.duration}h | Due: ${job.due_date} | ${job.sow_1 || ''}
                            </div>
                            <button onclick="addFillJobToQueue(${job.work_order}, '${job.site_name.replace(/'/g, "\\'")}', ${techId}, '${dateStr}')" 
                                style="width: 100%; padding: 4px 8px; background: #22c55e; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                                Add to Day
                            </button>
                        </div>
                    `;
                });
                html += '</div>';
                
                document.getElementById('detail-content').innerHTML = html;
                
                // Visualize on map
                visualizeFillSuggestions(data.suggestions, dayJobs, tech);
                
            } catch (error) {
                console.error('Error filling day:', error);
                document.getElementById('detail-content').innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }
        
        function addFillJobToQueue(workOrder, siteName, techId, dateStr) {
            const tech = technicians.find(t => t.technician_id === techId);
            
            if (!assignmentQueue.some(a => a.work_order === workOrder)) {
                assignmentQueue.push({
                    work_order: workOrder,
                    technician_id: techId,
                    date: dateStr,
                    site_name: siteName,
                    tech_name: tech?.name || 'Unknown'
                });
            }
            
            updateQueueDisplay();
            
            // Remove the button or mark as added
            event.target.textContent = '√¢≈ì‚Äú Added';
            event.target.disabled = true;
            event.target.style.background = '#9ca3af';
        }
        
        function visualizeFillSuggestions(suggestions, existingJobs, tech) {
            clearRouteVisualization();
            
            // Add tech home
            const homeMarker = L.marker([tech.home_latitude, tech.home_longitude], {
                icon: L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 18px solid #1e40af;"></div>`,
                    iconSize: [20, 18],
                    iconAnchor: [10, 18]
                })
            });
            homeMarker.bindPopup(`<b>${tech.name}</b><br>Home`);
            homeMarker.addTo(map);
            routeLayers.push(homeMarker);
            
            // Add existing jobs (black squares)
            existingJobs.forEach(job => {
                if (job.latitude && job.longitude) {
                    const marker = L.marker([job.latitude, job.longitude], {
                        icon: L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div style="background: #000; width: 14px; height: 14px; border: 2px solid white;"></div>`,
                            iconSize: [14, 14],
                            iconAnchor: [7, 7]
                        })
                    });
                    marker.bindPopup(`<b>Scheduled:</b> ${job.site_name}`);
                    marker.addTo(map);
                    routeLayers.push(marker);
                }
            });
            
            // Add suggestion markers
            const allCoords = [[tech.home_latitude, tech.home_longitude]];
            suggestions.forEach((job, i) => {
                if (job.latitude && job.longitude) {
                    const color = job.suggestion_type === 'nearby' ? '#22c55e' : '#f59e0b';
                    const marker = L.circleMarker([job.latitude, job.longitude], {
                        radius: 8,
                        fillColor: color,
                        color: '#fff',
                        weight: 2,
                        fillOpacity: 0.8
                    });
                    marker.bindPopup(`<b>${job.site_name}</b><br>${job.distance_miles?.toFixed(1)} mi | ${job.duration}h`);
                    marker.addTo(map);
                    routeLayers.push(marker);
                    allCoords.push([job.latitude, job.longitude]);
                }
            });
            
            existingJobs.forEach(j => {
                if (j.latitude && j.longitude) allCoords.push([j.latitude, j.longitude]);
            });
            
            if (allCoords.length > 1) {
                const bounds = L.latLngBounds(allCoords);
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }
        
        function queueMoveJob(workOrder, siteName, newValue, changeType) {
            if (!newValue) return;
            
            // Remove any existing change for this work order of the same type
            pendingChanges = pendingChanges.filter(c => !(c.work_order === workOrder && c.type === changeType));
            
            pendingChanges.push({
                work_order: workOrder,
                site_name: siteName,
                type: changeType,
                value: changeType === 'tech' ? parseInt(newValue) : newValue,
                label: changeType === 'date' ? `Move to ${newValue}` : `Reassign to ${technicians.find(t => t.technician_id === parseInt(newValue))?.name || newValue}`
            });
            
            updatePendingChangesDisplay();
        }
        
        function queueUnschedule(workOrder, siteName) {
            // Remove any existing changes for this work order
            pendingChanges = pendingChanges.filter(c => c.work_order !== workOrder);
            
            pendingChanges.push({
                work_order: workOrder,
                site_name: siteName,
                type: 'unschedule',
                label: 'Unschedule'
            });
            
            updatePendingChangesDisplay();
        }
        
        function queueAddSecondaryTech(workOrder, siteName, techId) {
            if (!techId) return;
            
            pendingChanges = pendingChanges.filter(c => !(c.work_order === workOrder && c.type === 'secondary'));
            
            const tech = technicians.find(t => t.technician_id === parseInt(techId));
            pendingChanges.push({
                work_order: workOrder,
                site_name: siteName,
                type: 'secondary',
                value: parseInt(techId),
                label: `Add ${tech?.name || techId} as secondary`
            });
            
            updatePendingChangesDisplay();
        }
        
        function removeFromPendingChanges(index) {
            pendingChanges.splice(index, 1);
            updatePendingChangesDisplay();
        }
        
        function updatePendingChangesDisplay() {
            let panel = document.getElementById('pending-changes-panel');
            if (!panel) {
                panel = document.createElement('div');
                panel.id = 'pending-changes-panel';
                panel.style.cssText = 'position: fixed; top: 100px; right: 10px; width: 280px; max-height: 80vh; background: #1e3a5f; color: white; padding: 15px; z-index: 1003; display: none; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); overflow-y: auto;';
                document.body.appendChild(panel);
            }
            
            if (pendingChanges.length === 0) {
                panel.style.display = 'none';
                return;
            }
            
            panel.style.display = 'block';
            
            const changesHtml = pendingChanges.map((c, i) => 
                `<div style="background: #374151; padding: 8px 10px; border-radius: 4px; margin-bottom: 6px; font-size: 11px; display: flex; justify-content: space-between; align-items: center; gap: 8px;">
                    <span style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${c.site_name.substring(0, 18)}... √¢‚Ä†‚Äô ${c.label}</span>
                    <span onclick="removeFromPendingChanges(${i})" style="cursor: pointer; font-weight: bold; color: #ef4444;">√É‚Äî</span>
                </div>`
            ).join('');
            
            panel.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <div style="font-weight: bold; font-size: 14px; border-bottom: 1px solid #4b5563; padding-bottom: 8px;">
                        √∞≈∏‚Äú‚Äπ Pending Changes (${pendingChanges.length})
                    </div>
                    <div style="max-height: 50vh; overflow-y: auto;">
                        ${changesHtml}
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 8px; padding-top: 10px; border-top: 1px solid #4b5563;">
                        <button onclick="saveAllChanges()" style="padding: 10px 12px; background: #22c55e; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">√¢≈ì‚Äú Save All Changes</button>
                        <button onclick="clearPendingChanges()" style="padding: 8px 12px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer;">Clear All</button>
                    </div>
                </div>
            `;
        }
        
        function clearPendingChanges() {
            pendingChanges = [];
            updatePendingChangesDisplay();
        }
        
        async function saveAllChanges() {
            if (pendingChanges.length === 0) {
                alert('No changes to save');
                return;
            }
            
            let successCount = 0;
            let errors = [];
            
            for (const change of pendingChanges) {
                try {
                    let response;
                    
                    if (change.type === 'unschedule') {
                        response = await fetch('/api/schedule/unschedule', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ work_order: change.work_order })
                        });
                    } else if (change.type === 'date') {
                        response = await fetch('/api/schedule/update', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ work_order: change.work_order, date: change.value })
                        });
                    } else if (change.type === 'tech') {
                        response = await fetch('/api/schedule/update', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ work_order: change.work_order, technician_id: change.value })
                        });
                    } else if (change.type === 'secondary') {
                        response = await fetch('/api/schedule/add-secondary', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ work_order: change.work_order, secondary_tech_id: change.value })
                        });
                    }
                    
                    const result = await response.json();
                    if (result.success) {
                        successCount++;
                    } else {
                        errors.push(`${change.site_name}: ${result.error || 'Unknown error'}`);
                    }
                } catch (error) {
                    errors.push(`${change.site_name}: ${error.message}`);
                }
            }
            
            if (errors.length > 0) {
                alert(`Saved ${successCount} changes.\n\nErrors:\n${errors.join('\n')}`);
            } else {
                alert(`Successfully saved ${successCount} changes!`);
            }
            
            clearPendingChanges();
            loadData();
        }
        
        // Legacy functions - keep for compatibility
        async function moveScheduledJob(workOrder, newDate) {
            if (!newDate) return;
            queueMoveJob(workOrder, 'Job', newDate, 'date');
        }
        
        async function reassignScheduledJob(workOrder, newTechId) {
            if (!newTechId) return;
            queueMoveJob(workOrder, 'Job', newTechId, 'tech');
        }
        
        async function unscheduleJob(workOrder) {
            queueUnschedule(workOrder, 'Job');
        }
        
        function highlightJob(workOrder, lat, lng) {
            if (lat && lng) {
                map.setView([lat, lng], 10);
            }
        }
        
        function highlightTechDay(techId, dateStr) {
            // Get jobs for this tech/day
            const dayJobs = scheduledJobs.filter(j => 
                j.technician_id === techId && j.date === dateStr
            );
            
            if (dayJobs.length > 0) {
                // Zoom to fit all jobs
                const lats = dayJobs.map(j => j.latitude).filter(l => l);
                const lngs = dayJobs.map(j => j.longitude).filter(l => l);
                
                if (lats.length > 0) {
                    const bounds = L.latLngBounds(
                        [Math.min(...lats), Math.min(...lngs)],
                        [Math.max(...lats), Math.max(...lngs)]
                    );
                    map.fitBounds(bounds, { padding: [50, 50] });
                }
            }
        }
        
        // ============================================================================
        // EXPORT AND EMAIL FUNCTIONS
        // ============================================================================
        
        function exportScheduleCSV() {
            const rows = [['WOID', 'UserID', 'IsPrimary', 'ScheduleDate']];
            
            scheduledJobs.forEach(job => {
                // Primary tech row
                rows.push([
                    job.work_order,
                    job.technician_id,
                    '1',
                    job.date
                ]);
                
                // Additional tech rows from job data (can be multiple)
                if (job.additional_tech_ids && job.additional_tech_ids.length > 0) {
                    job.additional_tech_ids.forEach(techId => {
                        rows.push([
                            job.work_order,
                            techId,
                            '0',
                            job.date
                        ]);
                    });
                }
            });
            
            const csvContent = rows.map(e => e.join(",")).join("\n");
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `schedule_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }
        
        function generateEmailPreview() {
            const modal = document.getElementById('email-modal');
            const tableContainer = document.getElementById('email-table-container');
            
            const days = ['mon', 'tue', 'wed', 'thu', 'fri'];
            const dayLabels = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
            
            // Build jobsByTechDay
            const jobsByTechDay = {};
            scheduledJobs.forEach(job => {
                const techId = job.technician_id;
                const jobDate = new Date(job.date + 'T00:00:00');
                const dayOfWeek = jobDate.getDay();
                const dayKey = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][dayOfWeek];
                
                if (!days.includes(dayKey)) return;
                
                const key = `${techId}-${dayKey}`;
                if (!jobsByTechDay[key]) jobsByTechDay[key] = [];
                jobsByTechDay[key].push(job);
            });
            
            // Get week dates
            const weekDates = [];
            for (let i = 0; i < 5; i++) {
                const d = new Date(currentWeek);
                d.setDate(d.getDate() + i);
                weekDates.push(d);
            }
            
            // Build individual emails for each tech
            let html = '<div style="display: flex; flex-direction: column; gap: 20px;">';
            
            technicians.forEach((tech, techIndex) => {
                const techJobs = days.map((day, i) => ({
                    day: dayLabels[i],
                    date: weekDates[i],
                    dateStr: weekDates[i].toISOString().split('T')[0],
                    jobs: jobsByTechDay[`${tech.technician_id}-${day}`] || []
                }));
                
                const hasAnyJobs = techJobs.some(d => d.jobs.length > 0);
                const timeOffDays = days.map((day, i) => {
                    const dateStr = weekDates[i].toISOString().split('T')[0];
                    return techTimeOff[`${tech.technician_id}-${dateStr}`];
                });
                const hasTimeOff = timeOffDays.some(t => t);
                
                // Skip techs with no jobs and no time off
                if (!hasAnyJobs && !hasTimeOff) return;
                
                html += `
                    <div style="border: 2px solid #1e3a5f; border-radius: 8px; overflow: hidden;" id="email-${tech.technician_id}">
                        <div style="background: #1e3a5f; color: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="margin: 0;">${tech.name} - Week of ${weekDates[0].toLocaleDateString()}</h3>
                            <button onclick="copyTechEmail(${tech.technician_id})" style="padding: 5px 12px; background: #22c55e; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Copy</button>
                        </div>
                        <div style="padding: 15px;" id="email-content-${tech.technician_id}">
                            <table style="border-collapse: collapse; width: 100%; font-size: 12px;">
                                <thead>
                                    <tr>
                                        <th style="background: #f3f4f6; padding: 8px; border: 1px solid #ddd; text-align: left;">Day</th>
                                        <th style="background: #f3f4f6; padding: 8px; border: 1px solid #ddd; text-align: left;">Site</th>
                                        <th style="background: #f3f4f6; padding: 8px; border: 1px solid #ddd; text-align: left;">Address</th>
                                        <th style="background: #f3f4f6; padding: 8px; border: 1px solid #ddd; text-align: left;">City</th>
                                        <th style="background: #f3f4f6; padding: 8px; border: 1px solid #ddd; text-align: left;">SOW</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                techJobs.forEach((dayData, dayIndex) => {
                    const timeOff = timeOffDays[dayIndex];
                    
                    if (timeOff) {
                        html += `
                            <tr style="background: #fee2e2;">
                                <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">${dayData.day} ${dayData.date.getMonth()+1}/${dayData.date.getDate()}</td>
                                <td colspan="4" style="padding: 8px; border: 1px solid #ddd; color: #dc2626; font-style: italic;">${timeOff.reason || 'Time Off'}</td>
                            </tr>
                        `;
                    } else if (dayData.jobs.length === 0) {
                        html += `
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;">${dayData.day} ${dayData.date.getMonth()+1}/${dayData.date.getDate()}</td>
                                <td colspan="4" style="padding: 8px; border: 1px solid #ddd; color: #999;">No jobs scheduled</td>
                            </tr>
                        `;
                    } else {
                        dayData.jobs.forEach((job, jobIndex) => {
                            const isFirstJob = jobIndex === 0;
                            const rowBg = dayIndex % 2 === 0 ? '#ffffff' : '#f9fafb';
                            
                            html += `
                                <tr style="background: ${rowBg};">
                                    ${isFirstJob ? `<td style="padding: 8px; border: 1px solid #ddd; font-weight: bold;" rowspan="${dayData.jobs.length}">${dayData.day} ${dayData.date.getMonth()+1}/${dayData.date.getDate()}</td>` : ''}
                                    <td style="padding: 8px; border: 1px solid #ddd;">
                                        <a href="https://connect.cgrs.com/CGRSConnect/WorkOrder/Create?workOrderId=${job.work_order}" target="_blank" style="color: #2563eb; text-decoration: none;">${job.site_name}</a>
                                    </td>
                                    <td style="padding: 8px; border: 1px solid #ddd;">${job.site_address || job.address || ''}</td>
                                    <td style="padding: 8px; border: 1px solid #ddd;">${job.site_city || ''}${job.site_state ? ', ' + job.site_state : ''}</td>
                                    <td style="padding: 8px; border: 1px solid #ddd;">${job.sow_1 || ''}</td>
                                </tr>
                            `;
                        });
                    }
                });
                
                html += `
                        </tbody>
                    </table>
                </div>
            </div>
                `;
            });
            
            html += '</div>';
            tableContainer.innerHTML = html;
            modal.style.display = 'block';
        }
        
        function copyTechEmail(techId) {
            const content = document.getElementById(`email-content-${techId}`);
            if (!content) {
                alert('Content not found');
                return;
            }
            
            const range = document.createRange();
            range.selectNode(content);
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);
            
            try {
                document.execCommand('copy');
                alert('Email copied to clipboard!');
            } catch (err) {
                alert('Failed to copy. Please select and copy manually.');
            }
            
            window.getSelection().removeAllRanges();
        }
        
        function closeEmailModal() {
            document.getElementById('email-modal').style.display = 'none';
        }
        
        // ============================================================================
        // SELECTED JOBS FUNCTIONS
        // ============================================================================
        
        let selectedJobs = [];
        const FRIDAY_RESTRICTED = ['King Soopers', 'Alta', 'Pacific Pride', 'City Market'];
        
        function addToSelectedJobs(workOrder) {
            const job = unscheduledJobs.find(j => j.work_order === workOrder);
            if (!job) {
                alert('Job not found');
                return;
            }
            
            // Check if already in list
            if (selectedJobs.some(j => j.work_order === workOrder)) {
                alert('Job already in Selected Jobs');
                return;
            }
            
            selectedJobs.push(job);
            updateSelectedJobsDisplay();
            
            // Open Route Builder panel if not visible
            document.getElementById('route-panel').style.display = 'block';
        }
        
        function removeFromSelectedJobs(workOrder) {
            selectedJobs = selectedJobs.filter(j => j.work_order !== workOrder);
            updateSelectedJobsDisplay();
        }
        
        function clearSelectedJobs() {
            selectedJobs = [];
            updateSelectedJobsDisplay();
        }
        
        function updateSelectedJobsDisplay() {
            const listDiv = document.getElementById('selected-jobs-list');
            const countSpan = document.getElementById('selected-count');
            const badge = document.getElementById('selected-jobs-badge');
            
            if (countSpan) countSpan.textContent = selectedJobs.length;
            
            // Update badge on toggle button
            if (badge) {
                badge.textContent = selectedJobs.length;
                badge.style.display = selectedJobs.length > 0 ? 'inline' : 'none';
            }
            
            if (!listDiv) return;
            
            if (selectedJobs.length === 0) {
                listDiv.innerHTML = '<p style="color: #666; font-style: italic; margin: 0;">Click jobs on map √¢‚Ä†‚Äô "+ Selected"</p>';
                return;
            }
            
            let html = '';
            selectedJobs.forEach(job => {
                const isRecurring = job.is_recurring_site ? '<span style="background: #8b5cf6; color: white; padding: 0 3px; border-radius: 2px; font-size: 8px; margin-left: 3px;">REC</span>' : '';
                const isFridayRestricted = FRIDAY_RESTRICTED.some(r => job.site_name.includes(r)) ? '<span style="background: #ef4444; color: white; padding: 0 3px; border-radius: 2px; font-size: 8px; margin-left: 3px;">NoFri</span>' : '';
                
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 3px 0; border-bottom: 1px solid #eee;">
                        <div style="flex: 1; overflow: hidden;">
                            <span style="font-size: 10px;">${job.site_name.substring(0, 22)}${job.site_name.length > 22 ? '...' : ''}</span>${isRecurring}${isFridayRestricted}
                            <br><span style="color: #888; font-size: 9px;">${job.region} | ${job.duration}h | Due: ${job.due_date}</span>
                        </div>
                        <button onclick="removeFromSelectedJobs(${job.work_order})" style="padding: 1px 5px; background: #fee2e2; color: #dc2626; border: none; border-radius: 3px; cursor: pointer; font-size: 9px;">√¢≈ì‚Ä¢</button>
                    </div>
                `;
            });
            
            // Show totals
            const totalHours = selectedJobs.reduce((sum, j) => sum + (j.duration || 2), 0);
            html += `<div style="margin-top: 5px; padding-top: 5px; border-top: 1px solid #f59e0b; font-size: 10px; font-weight: bold;">
                ${selectedJobs.length} jobs | ${totalHours.toFixed(1)}h work
            </div>`;
            
            listDiv.innerHTML = html;
        }
        
        async function buildRouteFromSelected() {
            const techId = document.getElementById('route-tech-select').value;
            const startDate = document.getElementById('route-start-date').value;
            
            if (!techId) {
                alert('Please select a technician');
                return;
            }
            
            if (selectedJobs.length === 0) {
                alert('No jobs selected. Click jobs on map and use "+ Selected" button.');
                return;
            }
            
            const tech = technicians.find(t => t.technician_id === parseInt(techId));
            if (!tech) {
                alert('Technician not found');
                return;
            }
            
            const resultsDiv = document.getElementById('route-results');
            resultsDiv.innerHTML = '<p>Building route from selected jobs...</p>';
            
            try {
                // Get week dates
                const weekDates = [];
                for (let i = 0; i < 5; i++) {
                    const d = new Date(startDate + 'T00:00:00');
                    d.setDate(d.getDate() + i);
                    weekDates.push(d.toISOString().split('T')[0]);
                }
                
                // Get time off for this tech
                const techTimeOffDays = new Set();
                Object.keys(techTimeOff).forEach(key => {
                    if (key.startsWith(tech.technician_id + '-')) {
                        const dateStr = key.split('-').slice(1).join('-');
                        techTimeOffDays.add(dateStr);
                    }
                });
                
                // Separate recurring jobs (must be on due date) from regular jobs
                const recurringJobs = selectedJobs.filter(j => j.is_recurring_site);
                const regularJobs = selectedJobs.filter(j => !j.is_recurring_site);
                
                // Calculate distance from tech home for each regular job
                regularJobs.forEach(job => {
                    job.distanceFromHome = haversineDistance(
                        tech.home_latitude, tech.home_longitude,
                        job.latitude, job.longitude
                    );
                });
                
                // Sort regular jobs by distance (farthest first)
                regularJobs.sort((a, b) => b.distanceFromHome - a.distanceFromHome);
                
                // Build route day by day
                const route = [];
                const usedWorkOrders = new Set();
                const warnings = [];
                
                for (let dayIndex = 0; dayIndex < 5; dayIndex++) {
                    const dateStr = weekDates[dayIndex];
                    const dayName = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'][dayIndex];
                    const isFriday = dayIndex === 4;
                    
                    // Check time off
                    if (techTimeOffDays.has(dateStr)) {
                        route.push({
                            date: dateStr,
                            dayName: dayName,
                            timeOff: true,
                            jobs: [],
                            totalWorkHours: 0,
                            totalDriveHours: 0
                        });
                        continue;
                    }
                    
                    const dayJobs = [];
                    let dayWorkHours = 0;
                    let dayDriveHours = 0;
                    let currentLocation = { lat: tech.home_latitude, lon: tech.home_longitude };
                    
                    // First: Add recurring jobs that MUST be on this date
                    recurringJobs.forEach(job => {
                        if (job.due_date === dateStr && !usedWorkOrders.has(job.work_order)) {
                            if (isFriday && FRIDAY_RESTRICTED.some(r => job.site_name.includes(r))) {
                                warnings.push(`${job.site_name}: Recurring due Friday but Friday-restricted`);
                            }
                            
                            const distance = haversineDistance(currentLocation.lat, currentLocation.lon, job.latitude, job.longitude);
                            const driveTime = distance / 45;
                            
                            dayJobs.push({ ...job, distance, driveTime, isSelected: true, isRecurring: true });
                            usedWorkOrders.add(job.work_order);
                            dayWorkHours += job.duration || 2;
                            dayDriveHours += driveTime;
                            currentLocation = { lat: job.latitude, lon: job.longitude };
                        }
                    });
                    
                    // Second: Add regular selected jobs by geography
                    const availableJobs = regularJobs.filter(j => !usedWorkOrders.has(j.work_order));
                    
                    // Target jobs by day (far early, close late)
                    let targetJobs;
                    if (dayIndex <= 1) {
                        targetJobs = availableJobs.filter(j => j.distanceFromHome > 90);
                        if (targetJobs.length === 0) targetJobs = availableJobs.slice(0, 3);
                    } else if (dayIndex <= 2) {
                        targetJobs = availableJobs.filter(j => j.distanceFromHome > 50 && j.distanceFromHome <= 150);
                        if (targetJobs.length === 0) targetJobs = availableJobs.slice(0, 3);
                    } else {
                        targetJobs = availableJobs.filter(j => j.distanceFromHome <= 90);
                        if (targetJobs.length === 0) targetJobs = availableJobs;
                    }
                    
                    // Nearest-neighbor from current location
                    while (targetJobs.length > 0) {
                        let bestJob = null;
                        let bestDistance = Infinity;
                        
                        for (const job of targetJobs) {
                            if (usedWorkOrders.has(job.work_order)) continue;
                            if (isFriday && FRIDAY_RESTRICTED.some(r => job.site_name.includes(r))) continue;
                            
                            const distance = haversineDistance(currentLocation.lat, currentLocation.lon, job.latitude, job.longitude);
                            if (distance < bestDistance) {
                                bestDistance = distance;
                                bestJob = job;
                            }
                        }
                        
                        if (!bestJob) break;
                        
                        const driveTime = bestDistance / 45;
                        const jobDuration = bestJob.duration || 2;
                        const distanceToHome = haversineDistance(bestJob.latitude, bestJob.longitude, tech.home_latitude, tech.home_longitude);
                        const isOutOfTown = distanceToHome > 90;
                        const maxHours = isOutOfTown ? 11 : 9;
                        
                        if (dayWorkHours + dayDriveHours + driveTime + jobDuration > maxHours && dayJobs.length > 0) break;
                        
                        dayJobs.push({ ...bestJob, distance: bestDistance, driveTime, isSelected: true, isRecurring: false });
                        usedWorkOrders.add(bestJob.work_order);
                        dayWorkHours += jobDuration;
                        dayDriveHours += driveTime;
                        currentLocation = { lat: bestJob.latitude, lon: bestJob.longitude };
                        targetJobs = targetJobs.filter(j => j.work_order !== bestJob.work_order);
                    }
                    
                    // Hotel check
                    let hotelStay = false;
                    if (dayJobs.length > 0) {
                        const lastJob = dayJobs[dayJobs.length - 1];
                        const distanceToHome = haversineDistance(lastJob.latitude, lastJob.longitude, tech.home_latitude, tech.home_longitude);
                        if (!isFriday && distanceToHome > 90) {
                            hotelStay = true;
                        } else {
                            dayDriveHours += distanceToHome / 45;
                        }
                    }
                    
                    if (dayWorkHours + dayDriveHours > 9 && !hotelStay) {
                        warnings.push(`${dayName}: ${(dayWorkHours + dayDriveHours).toFixed(1)}h (over 9h)`);
                    }
                    
                    route.push({
                        date: dateStr,
                        dayName: dayName,
                        jobs: dayJobs,
                        totalWorkHours: dayWorkHours,
                        totalDriveHours: dayDriveHours,
                        hotelStay: hotelStay
                    });
                }
                
                // Check unassigned
                const skippedJobs = selectedJobs.filter(j => !usedWorkOrders.has(j.work_order));
                if (skippedJobs.length > 0) {
                    warnings.push(`${skippedJobs.length} jobs couldn't be placed`);
                }
                
                // Display
                displayRouteResults(route, tech, warnings, skippedJobs);
                window.currentBuiltRoute = { route, tech, skippedJobs };
                visualizeRouteOnMap(route, tech);
                
            } catch (error) {
                console.error('Error building route:', error);
                resultsDiv.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
