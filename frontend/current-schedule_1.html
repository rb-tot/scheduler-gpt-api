<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Current Schedule - SchedulerGPT</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
        }
        
        /* Navigation */
        .nav-bar {
            background: #1e3a5f;
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .nav-bar h1 {
            font-size: 18px;
            font-weight: 600;
        }
        .nav-links {
            display: flex;
            gap: 8px;
        }
        .nav-links a {
            color: white;
            text-decoration: none;
            padding: 8px 14px;
            border-radius: 4px;
            background: rgba(255,255,255,0.1);
            font-size: 14px;
            transition: background 0.2s;
        }
        .nav-links a:hover {
            background: rgba(255,255,255,0.2);
        }
        .nav-links a.active {
            background: #3b82f6;
        }
        
        /* Controls Bar */
        .controls-bar {
            background: white;
            padding: 12px 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        .controls-bar label {
            font-size: 13px;
            color: #4b5563;
            font-weight: 500;
        }
        .controls-bar input[type="date"] {
            padding: 6px 10px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 14px;
        }
        .controls-bar button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        .btn-primary:hover {
            background: #2563eb;
        }
        .btn-toggle {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db !important;
        }
        .btn-toggle.active {
            background: #dc2626;
            color: white;
            border-color: #dc2626 !important;
        }
        .quick-range {
            display: flex;
            gap: 5px;
            margin-left: 10px;
        }
        .quick-range button {
            padding: 5px 10px;
            font-size: 12px;
            background: #e5e7eb;
            color: #374151;
        }
        .quick-range button:hover {
            background: #d1d5db;
        }
        
        /* Main Layout */
        .main-container {
            display: flex;
            height: calc(100vh - 110px);
        }
        
        /* Schedule Panel */
        .schedule-panel {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #f5f7fa;
        }
        
        /* Day Card */
        .day-card {
            background: white;
            border-radius: 8px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .day-header {
            background: #1e3a5f;
            color: white;
            padding: 10px 15px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .day-header .job-count {
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
        }
        .day-header.today {
            background: #059669;
        }
        .day-jobs {
            padding: 10px;
        }
        .day-jobs.empty {
            padding: 20px;
            text-align: center;
            color: #9ca3af;
            font-style: italic;
        }
        
        /* Job Item */
        .job-item {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            border-radius: 6px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: background 0.2s;
            border-left: 4px solid;
        }
        .job-item:hover {
            background: #f9fafb;
        }
        .job-item:last-child {
            margin-bottom: 0;
        }
        .job-tech-indicator {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 11px;
            margin-right: 10px;
            flex-shrink: 0;
        }
        .job-info {
            flex: 1;
            min-width: 0;
        }
        .job-site {
            font-weight: 600;
            font-size: 13px;
            color: #1f2937;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .job-details {
            font-size: 11px;
            color: #6b7280;
            margin-top: 2px;
        }
        .job-time {
            font-size: 12px;
            color: #374151;
            font-weight: 500;
            text-align: right;
            margin-left: 10px;
        }
        
        /* Map Panel */
        .map-panel {
            width: 50%;
            min-width: 400px;
            position: relative;
        }
        #map {
            width: 100%;
            height: 100%;
        }
        
        /* Tech Legend */
        .tech-legend {
            position: absolute;
            bottom: 20px;
            left: 10px;
            background: white;
            padding: 10px 12px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            font-size: 12px;
        }
        .tech-legend h4 {
            margin-bottom: 8px;
            font-size: 12px;
            color: #374151;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 4px;
        }
        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 50%;
        }
        
        /* Urgent Panel */
        .urgent-panel {
            position: fixed;
            right: 0;
            top: 110px;
            width: 320px;
            height: calc(100vh - 110px);
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            z-index: 1001;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        .urgent-panel.open {
            transform: translateX(0);
        }
        .urgent-header {
            background: #dc2626;
            color: white;
            padding: 12px 15px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .urgent-header .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 0 5px;
        }
        .urgent-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        .urgent-job {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            cursor: pointer;
        }
        .urgent-job:hover {
            background: #fee2e2;
        }
        .urgent-job .due-badge {
            background: #dc2626;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
        }
        .urgent-job .site-name {
            font-weight: 600;
            font-size: 13px;
            margin: 5px 0;
        }
        .urgent-job .job-meta {
            font-size: 11px;
            color: #6b7280;
        }
        
        /* Address Lookup Panel */
        .lookup-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            z-index: 1000;
            width: 300px;
        }
        .lookup-panel h4 {
            margin-bottom: 10px;
            font-size: 14px;
            color: #1f2937;
        }
        .lookup-panel input[type="text"] {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 13px;
            margin-bottom: 8px;
        }
        .lookup-panel button {
            width: 100%;
            padding: 8px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
        }
        .lookup-panel button:hover {
            background: #2563eb;
        }
        .lookup-panel button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        /* Analysis Results */
        .analysis-results {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e5e7eb;
            display: none;
        }
        .analysis-results.show {
            display: block;
        }
        .analysis-results h5 {
            font-size: 12px;
            color: #374151;
            margin-bottom: 8px;
        }
        .analysis-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 12px;
            border-bottom: 1px solid #f3f4f6;
        }
        .analysis-row:last-child {
            border-bottom: none;
        }
        .analysis-row .tech-name {
            font-weight: 500;
        }
        .analysis-row .distance {
            color: #6b7280;
        }
        .best-suggestion {
            background: #d1fae5;
            border: 1px solid #6ee7b7;
            border-radius: 4px;
            padding: 8px;
            margin-top: 10px;
            font-size: 12px;
        }
        .best-suggestion strong {
            color: #047857;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #e5e7eb;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 10px;
            vertical-align: middle;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="nav-bar">
        <h1>SchedulerGPT - Current Schedule</h1>
        <div class="nav-links">
            <a href="/scheduler-helper">Scheduler</a>
            <a href="/analysis">Analysis</a>
            <a href="/tech-manager">Technicians</a>
            <a href="/data-manager">Data Manager</a>
            <a href="/current-schedule" class="active">Current View</a>
        </div>
    </nav>
    
    <!-- Controls -->
    <div class="controls-bar">
        <div>
            <label>From:</label>
            <input type="date" id="start-date">
        </div>
        <div>
            <label>To:</label>
            <input type="date" id="end-date">
        </div>
        <button class="btn-primary" onclick="loadSchedule()">Load</button>
        
        <div class="quick-range">
            <button onclick="setDateRange('today')">Today</button>
            <button onclick="setDateRange('week')">This Week</button>
            <button onclick="setDateRange('next-week')">Next Week</button>
            <button onclick="setDateRange('2-weeks')">2 Weeks</button>
        </div>
        
        <button class="btn-toggle" id="urgent-toggle" onclick="toggleUrgentPanel()">
            Urgent Jobs <span id="urgent-count">(0)</span>
        </button>
    </div>
    
    <!-- Main Content -->
    <div class="main-container">
        <!-- Schedule List -->
        <div class="schedule-panel" id="schedule-panel">
            <div class="loading">Loading schedule...</div>
        </div>
        
        <!-- Map -->
        <div class="map-panel">
            <div id="map"></div>
            
            <!-- Tech Legend -->
            <div class="tech-legend" id="tech-legend">
                <h4>Technicians</h4>
                <div id="legend-items"></div>
            </div>
            
            <!-- Address Lookup -->
            <div class="lookup-panel">
                <h4>Address Lookup</h4>
                <input type="text" id="address-input" placeholder="Enter address to find...">
                <button onclick="lookupAddress()" id="lookup-btn">Find Location</button>
                
                <div class="analysis-results" id="analysis-results">
                    <h5>Nearest Technicians</h5>
                    <div id="tech-distances"></div>
                    <div class="best-suggestion" id="best-suggestion"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Urgent Jobs Panel -->
    <div class="urgent-panel" id="urgent-panel">
        <div class="urgent-header">
            <span>Urgent Unscheduled Jobs</span>
            <button class="close-btn" onclick="toggleUrgentPanel()">&times;</button>
        </div>
        <div class="urgent-content" id="urgent-content">
            <div class="loading">Loading...</div>
        </div>
    </div>
    
    <script>
        // Tech colors - same as scheduler-helper.html
        const TECH_COLORS = [
            '#8b5cf6', // purple
            '#ec4899', // pink
            '#0ea5e9', // sky blue
            '#6366f1', // indigo
            '#14b8a6', // teal
            '#a855f7', // violet
            '#f43f5e', // rose
            '#06b6d4', // cyan
            '#d946ef', // fuchsia
            '#0284c7', // light blue
            '#7c3aed', // purple darker
            '#db2777', // pink darker
        ];
        
        // State
        let map = null;
        let technicians = [];
        let scheduledJobs = [];
        let urgentJobs = [];
        let markers = [];
        let lookupMarker = null;
        let urgentPanelOpen = false;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            setDateRange('week');
            loadTechnicians().then(() => {
                loadSchedule();
                loadUrgentJobs();
            });
        });
        
        function initMap() {
            map = L.map('map').setView([39.5, -105.0], 7);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap'
            }).addTo(map);
        }
        
        // Date range helpers
        function setDateRange(range) {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const monday = new Date(today);
            monday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
            
            let startDate, endDate;
            
            switch(range) {
                case 'today':
                    startDate = today;
                    endDate = today;
                    break;
                case 'week':
                    startDate = today;
                    endDate = new Date(monday);
                    endDate.setDate(monday.getDate() + 4); // Friday
                    break;
                case 'next-week':
                    startDate = new Date(monday);
                    startDate.setDate(monday.getDate() + 7);
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 4);
                    break;
                case '2-weeks':
                    startDate = today;
                    endDate = new Date(monday);
                    endDate.setDate(monday.getDate() + 11); // 2 Fridays
                    break;
            }
            
            document.getElementById('start-date').value = formatDate(startDate);
            document.getElementById('end-date').value = formatDate(endDate);
            loadSchedule();
        }
        
        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }
        
        // Load technicians
        async function loadTechnicians() {
            try {
                const res = await fetch('/api/technicians/all');
                const data = await res.json();
                technicians = (data.technicians || []).filter(t => t.active);
                renderLegend();
            } catch (error) {
                console.error('Error loading technicians:', error);
            }
        }
        
        function getTechColor(techId) {
            const index = technicians.findIndex(t => t.technician_id === techId);
            return TECH_COLORS[index % TECH_COLORS.length] || '#6b7280';
        }
        
        function getTechInitials(techId) {
            const tech = technicians.find(t => t.technician_id === techId);
            if (!tech) return '?';
            const names = tech.name.split(' ');
            return names.map(n => n[0]).join('').substring(0, 2).toUpperCase();
        }
        
        function getTechName(techId) {
            const tech = technicians.find(t => t.technician_id === techId);
            return tech ? tech.name : 'Unknown';
        }
        
        function renderLegend() {
            const container = document.getElementById('legend-items');
            container.innerHTML = technicians.map(tech => {
                const color = getTechColor(tech.technician_id);
                return `
                    <div class="legend-item">
                        <div class="legend-color" style="background: ${color}"></div>
                        <span>${tech.name}</span>
                    </div>
                `;
            }).join('');
        }
        
        // Load scheduled jobs
        async function loadSchedule() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            if (!startDate || !endDate) return;
            
            document.getElementById('schedule-panel').innerHTML = '<div class="loading">Loading schedule...</div>';
            
            try {
                // We need to load week by week since the API is week-based
                scheduledJobs = [];
                const start = new Date(startDate + 'T00:00:00');
                const end = new Date(endDate + 'T00:00:00');
                
                // Get week start (Monday) for each week in range
                let current = new Date(start);
                const dayOfWeek = current.getDay();
                current.setDate(current.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
                
                const weekStarts = new Set();
                while (current <= end) {
                    weekStarts.add(formatDate(current));
                    current.setDate(current.getDate() + 7);
                }
                
                // Fetch each week
                for (const weekStart of weekStarts) {
                    const res = await fetch(`/api/schedule/week-all?week_start=${weekStart}`);
                    const data = await res.json();
                    if (data.scheduled_jobs) {
                        scheduledJobs = scheduledJobs.concat(data.scheduled_jobs);
                    }
                }
                
                // Filter to exact date range
                scheduledJobs = scheduledJobs.filter(job => {
                    const jobDate = job.date;
                    return jobDate >= startDate && jobDate <= endDate;
                });
                
                // Remove duplicates (in case of overlapping week fetches)
                const seen = new Set();
                scheduledJobs = scheduledJobs.filter(job => {
                    const key = job.work_order;
                    if (seen.has(key)) return false;
                    seen.add(key);
                    return true;
                });
                
                renderSchedule(startDate, endDate);
                renderMapMarkers();
                
            } catch (error) {
                console.error('Error loading schedule:', error);
                document.getElementById('schedule-panel').innerHTML = 
                    '<div style="padding: 20px; color: #dc2626;">Error loading schedule: ' + error.message + '</div>';
            }
        }
        
        function renderSchedule(startDate, endDate) {
            const panel = document.getElementById('schedule-panel');
            const start = new Date(startDate + 'T00:00:00');
            const end = new Date(endDate + 'T00:00:00');
            const today = formatDate(new Date());
            
            // Group jobs by date
            const jobsByDate = {};
            scheduledJobs.forEach(job => {
                if (!jobsByDate[job.date]) {
                    jobsByDate[job.date] = [];
                }
                jobsByDate[job.date].push(job);
            });
            
            // Generate day cards
            let html = '';
            const current = new Date(start);
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            
            while (current <= end) {
                const dateStr = formatDate(current);
                const dayJobs = jobsByDate[dateStr] || [];
                const isToday = dateStr === today;
                const dayName = dayNames[current.getDay()];
                const displayDate = `${current.getMonth() + 1}/${current.getDate()}`;
                
                // Sort jobs by tech then time
                dayJobs.sort((a, b) => {
                    if (a.technician_id !== b.technician_id) {
                        return a.technician_id - b.technician_id;
                    }
                    return (a.start_time || '08:00').localeCompare(b.start_time || '08:00');
                });
                
                html += `
                    <div class="day-card">
                        <div class="day-header ${isToday ? 'today' : ''}">
                            <span>${dayName} ${displayDate}</span>
                            <span class="job-count">${dayJobs.length} jobs</span>
                        </div>
                        <div class="day-jobs ${dayJobs.length === 0 ? 'empty' : ''}">
                `;
                
                if (dayJobs.length === 0) {
                    html += 'No jobs scheduled';
                } else {
                    dayJobs.forEach(job => {
                        const color = getTechColor(job.technician_id);
                        const initials = getTechInitials(job.technician_id);
                        const duration = job.duration || 2;
                        const time = job.start_time ? job.start_time.substring(0, 5) : '08:00';
                        
                        html += `
                            <div class="job-item" style="border-left-color: ${color}" 
                                 onclick="focusJob(${job.work_order})"
                                 data-work-order="${job.work_order}">
                                <div class="job-tech-indicator" style="background: ${color}">${initials}</div>
                                <div class="job-info">
                                    <div class="job-site">${job.site_name || 'Unknown Site'}</div>
                                    <div class="job-details">
                                        ${job.site_city || ''}, ${job.site_state || ''} | 
                                        ${job.sow_1 || 'N/A'} | ${duration}h
                                    </div>
                                </div>
                                <div class="job-time">${time}</div>
                            </div>
                        `;
                    });
                }
                
                html += '</div></div>';
                current.setDate(current.getDate() + 1);
            }
            
            panel.innerHTML = html;
        }
        
        // Map rendering
        function renderMapMarkers() {
            // Clear existing markers
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            
            // Add tech home markers (triangles)
            technicians.forEach(tech => {
                if (tech.home_latitude && tech.home_longitude) {
                    const color = getTechColor(tech.technician_id);
                    const homeIcon = L.divIcon({
                        className: 'custom-marker',
                        html: `<div style="
                            width: 0; height: 0;
                            border-left: 8px solid transparent;
                            border-right: 8px solid transparent;
                            border-bottom: 14px solid ${color};
                            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));
                        "></div>`,
                        iconSize: [16, 14],
                        iconAnchor: [8, 14]
                    });
                    const marker = L.marker([tech.home_latitude, tech.home_longitude], { icon: homeIcon })
                        .bindTooltip(`${tech.name} (Home)`, { permanent: false });
                    marker.addTo(map);
                    markers.push(marker);
                }
            });
            
            // Add job markers
            scheduledJobs.forEach(job => {
                if (job.latitude && job.longitude) {
                    const color = getTechColor(job.technician_id);
                    const jobIcon = L.divIcon({
                        className: 'custom-marker',
                        html: `<div style="
                            width: 12px; height: 12px;
                            background: ${color};
                            border: 2px solid white;
                            border-radius: 50%;
                            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
                        "></div>`,
                        iconSize: [12, 12],
                        iconAnchor: [6, 6]
                    });
                    
                    const marker = L.marker([job.latitude, job.longitude], { icon: jobIcon })
                        .bindPopup(`
                            <strong>${job.site_name}</strong><br>
                            ${job.site_city}, ${job.site_state}<br>
                            ${job.date} @ ${job.start_time || '08:00'}<br>
                            Tech: ${getTechName(job.technician_id)}<br>
                            SOW: ${job.sow_1 || 'N/A'} | Duration: ${job.duration || 2}h
                        `);
                    marker.workOrder = job.work_order;
                    marker.addTo(map);
                    markers.push(marker);
                }
            });
            
            // Fit bounds if we have markers
            if (scheduledJobs.length > 0) {
                const bounds = L.latLngBounds(
                    scheduledJobs
                        .filter(j => j.latitude && j.longitude)
                        .map(j => [j.latitude, j.longitude])
                );
                if (bounds.isValid()) {
                    map.fitBounds(bounds, { padding: [50, 50] });
                }
            }
        }
        
        function focusJob(workOrder) {
            const marker = markers.find(m => m.workOrder === workOrder);
            if (marker) {
                map.setView(marker.getLatLng(), 12);
                marker.openPopup();
            }
        }
        
        // Urgent jobs
        async function loadUrgentJobs() {
            try {
                const today = new Date();
                const futureDate = new Date(today);
                futureDate.setDate(today.getDate() + 10);
                
                const startStr = formatDate(today);
                const endStr = formatDate(futureDate);
                
                const res = await fetch(`/api/jobs/unscheduled?start_date=${startStr}&end_date=${endStr}&limit=100`);
                const data = await res.json();
                urgentJobs = data.jobs || [];
                
                // Sort by due date
                urgentJobs.sort((a, b) => (a.due_date || '').localeCompare(b.due_date || ''));
                
                document.getElementById('urgent-count').textContent = `(${urgentJobs.length})`;
                renderUrgentJobs();
                
            } catch (error) {
                console.error('Error loading urgent jobs:', error);
            }
        }
        
        function renderUrgentJobs() {
            const container = document.getElementById('urgent-content');
            
            if (urgentJobs.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #6b7280;">No urgent jobs in next 10 days</div>';
                return;
            }
            
            container.innerHTML = urgentJobs.map(job => {
                const dueDate = job.due_date ? new Date(job.due_date + 'T00:00:00') : null;
                const today = new Date();
                const daysUntil = dueDate ? Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24)) : '?';
                
                return `
                    <div class="urgent-job" onclick="showUrgentOnMap(${job.latitude}, ${job.longitude}, '${(job.site_name || '').replace(/'/g, "\\'")}')">
                        <span class="due-badge">${daysUntil <= 0 ? 'OVERDUE' : daysUntil + ' days'}</span>
                        <div class="site-name">${job.site_name || 'Unknown'}</div>
                        <div class="job-meta">
                            ${job.site_city || ''}, ${job.site_state || ''}<br>
                            Due: ${job.due_date || 'N/A'} | ${job.sow_1 || 'N/A'} | ${job.duration || 2}h<br>
                            ${job.eligible_tech_count || 0} eligible techs
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function toggleUrgentPanel() {
            urgentPanelOpen = !urgentPanelOpen;
            const panel = document.getElementById('urgent-panel');
            const toggle = document.getElementById('urgent-toggle');
            
            if (urgentPanelOpen) {
                panel.classList.add('open');
                toggle.classList.add('active');
            } else {
                panel.classList.remove('open');
                toggle.classList.remove('active');
            }
        }
        
        function showUrgentOnMap(lat, lng, siteName) {
            if (lat && lng) {
                map.setView([lat, lng], 12);
                
                // Add temporary marker
                if (lookupMarker) {
                    map.removeLayer(lookupMarker);
                }
                
                const icon = L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="
                        width: 16px; height: 16px;
                        background: #dc2626;
                        border: 3px solid white;
                        border-radius: 50%;
                        box-shadow: 0 2px 6px rgba(0,0,0,0.4);
                    "></div>`,
                    iconSize: [16, 16],
                    iconAnchor: [8, 8]
                });
                
                lookupMarker = L.marker([lat, lng], { icon })
                    .bindPopup(`<strong>Urgent: ${siteName}</strong>`)
                    .addTo(map)
                    .openPopup();
            }
        }
        
        // Address lookup with geocoding
        async function lookupAddress() {
            const address = document.getElementById('address-input').value.trim();
            if (!address) return;
            
            const btn = document.getElementById('lookup-btn');
            btn.disabled = true;
            btn.textContent = 'Searching...';
            
            try {
                // Use Nominatim for geocoding
                const encoded = encodeURIComponent(address);
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encoded}&limit=1`);
                const data = await res.json();
                
                if (data.length === 0) {
                    alert('Address not found. Try being more specific.');
                    return;
                }
                
                const result = data[0];
                const lat = parseFloat(result.lat);
                const lng = parseFloat(result.lon);
                
                // Remove old marker
                if (lookupMarker) {
                    map.removeLayer(lookupMarker);
                }
                
                // Add new marker
                const icon = L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="
                        width: 20px; height: 20px;
                        background: #f59e0b;
                        border: 3px solid white;
                        border-radius: 50%;
                        box-shadow: 0 2px 6px rgba(0,0,0,0.4);
                    "></div>`,
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });
                
                lookupMarker = L.marker([lat, lng], { icon })
                    .bindPopup(`<strong>Lookup Location</strong><br>${address}`)
                    .addTo(map)
                    .openPopup();
                
                map.setView([lat, lng], 10);
                
                // Analyze nearest techs
                analyzeNearestTechs(lat, lng);
                
            } catch (error) {
                console.error('Geocoding error:', error);
                alert('Error looking up address. Please try again.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Find Location';
            }
        }
        
        // Haversine distance calculation
        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 3959; // Earth's radius in miles
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        function analyzeNearestTechs(targetLat, targetLng) {
            const resultsDiv = document.getElementById('analysis-results');
            const distancesDiv = document.getElementById('tech-distances');
            const suggestionDiv = document.getElementById('best-suggestion');
            
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            // Calculate distance from each tech's home
            const techDistances = technicians
                .filter(t => t.home_latitude && t.home_longitude)
                .map(tech => {
                    const homeDistance = haversineDistance(
                        targetLat, targetLng,
                        tech.home_latitude, tech.home_longitude
                    );
                    
                    // Find tech's scheduled jobs in date range
                    const techJobs = scheduledJobs.filter(j => 
                        j.technician_id === tech.technician_id &&
                        j.latitude && j.longitude
                    );
                    
                    // Find closest scheduled job to target
                    let closestJobDistance = Infinity;
                    let closestJobDate = null;
                    
                    techJobs.forEach(job => {
                        const dist = haversineDistance(
                            targetLat, targetLng,
                            job.latitude, job.longitude
                        );
                        if (dist < closestJobDistance) {
                            closestJobDistance = dist;
                            closestJobDate = job.date;
                        }
                    });
                    
                    return {
                        tech,
                        homeDistance,
                        closestJobDistance: closestJobDistance === Infinity ? null : closestJobDistance,
                        closestJobDate,
                        // Use closest job if available, otherwise home distance
                        effectiveDistance: closestJobDistance !== Infinity ? closestJobDistance : homeDistance
                    };
                })
                .sort((a, b) => a.effectiveDistance - b.effectiveDistance);
            
            // Render distances
            distancesDiv.innerHTML = techDistances.slice(0, 5).map(td => {
                const color = getTechColor(td.tech.technician_id);
                const distText = td.closestJobDistance !== null 
                    ? `${td.closestJobDistance.toFixed(0)} mi from route (${td.closestJobDate})`
                    : `${td.homeDistance.toFixed(0)} mi from home`;
                
                return `
                    <div class="analysis-row">
                        <span class="tech-name" style="color: ${color}">${td.tech.name}</span>
                        <span class="distance">${distText}</span>
                    </div>
                `;
            }).join('');
            
            // Best suggestion
            if (techDistances.length > 0) {
                const best = techDistances[0];
                const driveTime = (best.effectiveDistance / 45).toFixed(1);
                
                if (best.closestJobDate) {
                    suggestionDiv.innerHTML = `
                        <strong>Best Option:</strong> ${best.tech.name} on ${best.closestJobDate}<br>
                        Only ${best.closestJobDistance.toFixed(0)} miles from existing route (~${driveTime}h drive)
                    `;
                } else {
                    suggestionDiv.innerHTML = `
                        <strong>Closest Tech:</strong> ${best.tech.name}<br>
                        ${best.homeDistance.toFixed(0)} miles from home (~${driveTime}h drive)
                    `;
                }
            }
            
            resultsDiv.classList.add('show');
        }
        
        // Allow Enter key in address input
        document.getElementById('address-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                lookupAddress();
            }
        });
    </script>
</body>
</html>
